Running List of CCL Queries and Useful Info, too.
########################################################################################################################################################

/*************************************************************************************
 * SAVE
 *************************************************************************************/

; To grab data from clinical event table

select * from clinical_event ce                                                                        
where ce.encntr_id = 30792722.00                                                                       
and ce.event_end_dt_tm > cnvtdatetime("16-JUL-2009 17:40:00") ;and cnvtdatetime("14-APR-2009 12:10:00")########################################################################################################################################################
with time=60                                                                                           

/*************************************************************************************
 * The query below identifies affected and potentially affected orders by patient name, order sentence (40 characters), start date, start time, and
 * ORDER_ID. If you execute this query for a location other than the United States, ensure that you change the line of text including the dates of 
 * 2-NOV-2008 and 3-NOV-2008 to the dates that corresponding to the fall DST change for your location:
 *************************************************************************************/


select
o.order_id,
disp_line=substring(1,50,o.dept_misc_line),
pname=substring(1,50,p.name_full_formatted)
from orders o, order_detail od, person p, order_action oa, code_value cv
plan cv where cv.code_set = 6000 and cv.cdf_meaning = "PHARMACY" and
cv.active_ind = 1
join oa where oa.action_dt_tm > cnvtdatetime("2-NOV-2008 00:59") and
oa.action_dt_tm < cnvtdatetime("3-NOV-2008 00:00")
join od where oa.order_id = od.order_id and
oa.action_sequence = od.action_sequence and
od.oe_field_meaning_id = 2071 and
od.oe_field_value > -1
join o where oa.order_id = o.order_id and
o.catalog_type_cd+0 = cv.code_value and
o.template_order_flag in (0,1)
join p where o.person_id = p.person_id
order by p.person_id, o.order_id
head report
x=0
head page
col 00, "PATIENT NAME / ORDER SENTENCE",
col 52, "START DATE/TIME",
col 72, "STOP DATE/TIME",
col 92, "ORDER ID"
row+1
head p.person_id
col 00, pname, row+1
detail
col 00, disp_line,
col 52, o.current_start_dt_tm "mm/dd/yyyy;;d",
col 63, o.current_start_dt_tm "hh:mm:ss;;m",
col 72, o.projected_stop_dt_tm "mm/dd/yyyy;;d",
col 83, o.projected_stop_dt_tm "hh:mm:ss;;m",
col 92, o.order_id "############;p0",
row+1
foot o.person_id
row+1
with counter
go




########################################################################################################################################################

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; This will list items charged on a powerform, by unique dtas/alpha responses.
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


SELECT 
        B.BILL_ITEM_ID,
        BILL_NUM = B.KEY6,   ;bill number
        BILL_ITEM_DESC = B.KEY7,   ;bill item description
        BI_EXT_CHILD_CONTRIBUTOR_DISP = UAR_GET_CODE_DISPLAY( BI.EXT_CHILD_CONTRIBUTOR_CD ),
        BI.EXT_PARENT_REFERENCE_ID,
        CV1.DISPLAY ; dta name
 
FROM
        BILL_ITEM_MODIFIER  B,
        BILL_ITEM  BI,
        CODE_VALUE  CV1
 
PLAN B WHERE  B.KEY6 != " "
JOIN BI WHERE  B.BILL_ITEM_ID =   BI.BILL_ITEM_ID
 AND BI.EXT_CHILD_CONTRIBUTOR_CD =         3417.00  ;codeset 13016, alpha response 
 AND BI.ACTIVE_IND = 1
 
JOIN CV1  WHERE  BI.EXT_PARENT_REFERENCE_ID =   CV1.CODE_VALUE
;codeset 14003 - dta's on a powerform whose alpha's are built in the cspricingtool for charges
AND CV1.CODE_VALUE IN(    2328507.00) ; UAR_GET_CODE_BY( "DISPLAY",14003,"Aerosol Delivery Device")
 
ORDER BY        CV1.DISPLAY,
        BI.EXT_PARENT_REFERENCE_ID,
        B.KEY7

########################################################################################################################################################

/*************************************************************************************
 * Locate Powerform label that is not connected to anything - HD02338182
 *************************************************************************************/
 
Here are the steps taken.
1. Search for Powerform and obtain reference id (dcp_forms_ref_id)
select * from dcp_forms_ref dfr where dfr.description = "Adult Initial Ongoing Assessment"
reference id = 731692.00
2. Locate label control on one of the sections that has something selected under the label associations control tab and is not connected to anything
Select *
from dcp_forms_ref dfr
,dcp_forms_def dfd
,dcp_section_ref dsr
,dcp_input_ref dir
,name_value_prefs nvp
plan dfr where dfr.active_ind = 1 and dfr.dcp_forms_ref_id = 731692.00
join dfd where dfd.dcp_form_instance_id = dfr.dcp_form_instance_id
and dfd.active_ind = 1
join dsr where dsr.dcp_section_ref_id = dfd.dcp_section_ref_id
and dsr.active_ind = 1
join dir where dir.dcp_section_instance_id = dsr.dcp_section_instance_id
and dir.active_ind = 1
and dir.input_type = 1
join nvp where nvp.parent_entity_id = dir.dcp_input_ref_id
and nvp.pvc_name in ("question_role","header_role","reference_role")
and nvp.parent_entity_name = "DCP_INPUT_REF"
and nvp.active_ind = 1
with counter 
go 
########################################################################################################################################################

/*************************************************************************************
 * PowerChart Task Reports Menu - How to pull in date prompts
 *************************************************************************************/

free record parameters  
record parameters(
  1 beg_dt_tm = dq8
  1 end_dt_tm = dq8
)
 
declare iRequest_Cnt = i4 with protect, noconstant (0)
declare sYear        = vc with protect, noconstant (" ")
declare sMonth       = vc with protect, noconstant (" ")
declare sDay         = vc with protect, noconstant (" ")
declare iNull_Date   = i2 with protect, noconstant (0)

for (iRequest_Cnt = 1 to request->nv_cnt)
  if (request->nv[iRequest_Cnt]->pvc_name = "BEG_DT_TM")
    set sYear      = trim(substring( 1, 4, request->nv[iRequest_Cnt]->pvc_value))
    set sMonth     = trim(substring( 5, 2, request->nv[iRequest_Cnt]->pvc_value))
    set sDay       = trim(substring( 7, 2, request->nv[iRequest_Cnt]->pvc_value))
    call echo(sYear)
    call echo(sMonth)
    call echo(sDay)
    set parameters->beg_dt_tm = cnvtdate(build(sMonth, sDay, sYear))
    call echo(parameters->beg_dt_tm)
    call echo(format(parameters->beg_dt_tm, "MM/DD/YYYY;;D"))
  endif
  
  if (request->nv[iRequest_Cnt]->pvc_name = "END_DT_TM")
    set sYear      = trim(substring( 1, 4, request->nv[iRequest_Cnt]->pvc_value))
    set sMonth     = trim(substring( 5, 2, request->nv[iRequest_Cnt]->pvc_value))
    set sDay       = trim(substring( 7, 2, request->nv[iRequest_Cnt]->pvc_value))
    call echo(sYear)
    call echo(sMonth)
    call echo(sDay)
    set parameters->end_dt_tm = cnvtdate(build(sMonth, sDay, sYear))
    call echo(parameters->end_dt_tm)
    call echo(format(parameters->end_dt_tm, "MM/DD/YYYY;;D"))
  endif
endfor
########################################################################################################################################################

/*************************************************************************************
 * Charge Services Charge Reconciliation Report with AIX FTP.
 *************************************************************************************/

drop program SHETR_CS_RECON_RPT_FTP_A go
create program SHETR_CS_RECON_RPT_FTP_A
 
/*
prompt
	"Output to File/Printer/MINE" = "MINE"
with OUTDEV
*/
 
;variables
;manual counter for record count.
declare cnt = i4

;mod 002 for ftp ; absolute path (AIX)
set path = "/cerner/w_custom/cmprd_wh_cust/code/cs_ftp/"

;mod003 Per Sarah Wotruba, change file from *.txt to *.dat
;set filename = "SOURCE_SMH_CME.TXT"
set filename = "SOURCE_SMH_CME.DAT"
set filen = concat(path,filename)

select into value(filen)
	FACILITY = TRIM(CNVTUPPER(org.ORG_NAME))
	, DEPT = trim(substring(1,4,i.prim_cdm)) ; dept code
	, PATIENT_NAME = trim(substring(1,30,p.name_full_formatted))
	, EMRN = trim(cnvtalias(ea.alias, ea.alias_pool_cd),3)
	, VISIT_NBR = trim(substring(1,8,i.fin_nbr))
	, SERVICE_DT = FORMAT(i.SERVICE_DT_TM, "YYYYMMDD;;D" )
	, Service_Date = i.SERVICE_DT_TM
	, CHRG_CD = trim(substring(1,9,i.prim_cdm))
	, CHRG_DESC = trim(substring(1,30,CNVTUPPER(i.CHARGE_DESCRIPTION)))
	, i.CHARGE_DESCRIPTION
	, QTY = trim(cnvtstring(i.ext_bill_qty))  ; quantity
	, QTY_ALL = I.EXT_BILL_QTY
	, QTY_DEBIT = I.EXT_BILL_QTY
	, QTY_CREDIT = I.EXT_BILL_QTY
	, DR_CR = trim(substring(1,1,uar_get_code_display(i.charge_type_cd)))
	, PRICE_ALL = trim(cnvtstring(i.net_ext_price)) ; net price
	, PRICE_DEBIT = i.net_ext_price
	, PRICE_CREDIT = i.net_ext_price
 
;tables
FROM
	ORGANIZATION   ORG
	, ENCOUNTER   E
	, ENCNTR_ALIAS   EA
	, PERSON   P
	, INTERFACE_CHARGE   I
 
;qualifications
plan i where i.organization_id = 589723.00 ; SMH
	and i.active_ind = 1
	and (i.posted_dt_tm >= CNVTDATETIME(CURDATE-1, 000000) ;;"07-OCT-1992 12:30:00"
	and i.posted_dt_tm <= CNVTDATETIME(CURDATE-1, 235959))
	;and (i.posted_dt_tm >= CNVTDATETIME("30-NOV-2007 00:00:00") ;;"07-OCT-1992 12:30:00"
	;and i.posted_dt_tm <= CNVTDATETIME("05-DEC-2007 23:59:59"))
    /*************************************************************
	* "i.process_flg" shows the status of the interface charge.
	* This flag will be used to determine if the
	* interface charge qualifies for the interface file.
	*************************************************************/
	and i.process_flg = 999
	and i.beg_effective_dt_tm <= cnvtdatetime(curdate,curtime3)
	and i.end_effective_dt_tm >= cnvtdatetime(curdate,curtime3)
join e where e.encntr_id = i.encntr_id
	and e.active_ind = 1
	and e.beg_effective_dt_tm <= cnvtdatetime(curdate,curtime3)
	and e.end_effective_dt_tm >= cnvtdatetime(curdate,curtime3)
join p where p.person_id = i.person_id
	and p.active_ind = 1
	and p.beg_effective_dt_tm <= cnvtdatetime(curdate,curtime3)
	and p.end_effective_dt_tm >= cnvtdatetime(curdate,curtime3)
join org where org.organization_id = i.organization_id
	and org.active_ind = 1
join ea where ea.encntr_id = e.encntr_id
	and ea.encntr_alias_type_cd = 1079.00 ; MRN
	and ea.active_ind = 1
	and ea.beg_effective_dt_tm <= cnvtdatetime(curdate,curtime3)
	and ea.end_effective_dt_tm >= cnvtdatetime(curdate,curtime3)
 
;Sorting
ORDER BY
	org.ORG_NAME
	, DEPT
	, SERVICE_DT
	, P.NAME_LAST_KEY
	, I.FIN_NBR
	, I.PRIM_CDM
 
Head Report
null
	/*
	; mod001
	; move header line to footer report
	D1 = format(curdate,"YYYYMMDD;;D")
	COL 0 "**1"
	COL 5 "2"
	COL 7 "SMH"
	;COL 11 D1
	COL 11 "20071130"
	COL 20 "NNNNNNN"
	COL 29 "MILLENNIUM"
	ROW + 1
	*/
 
Head Page
null
 
Head DEPT
null
 
Head Service_Date
null
 
Detail
	cnt = cnt + 1 ; mod001 - add one to counter
	pt_name = substring(1,30,CONCAT(trim(P.NAME_LAST_KEY),",",trim(p.name_first_key)," ",trim(P.name_middle_key)))
	COL 0   pt_name
	COL 32   EMRN
	COL 45   VISIT_NBR
	COL 55   SERVICE_DT
	COL 65   CHRG_CD
	COL 76   CHRG_DESC
	COL 107  QTY "########;R"
	COL 117  DR_CR
	COL 126  PRICE_ALL "#########"
	ROW + 1
 
Foot Service_Date
null
 
Foot DEPT
null
 
;mod001
;Created foot report section and
;added manual counter
Foot Report
	D1 = format(curdate-1,"YYYYMMDD;;D") ; date the report was ran for
	qual = cnvtstring(cnt)
	COL 0 "**1"
	COL 5 "2"
	COL 7 "SMH"
	COL 11 D1
	;COL 11 "20071130"
	COL 20 qual
	COL 29 "MILLENNIUM"
 
WITH SKIPREPORT=0, NOCOUNTER, SEPARATOR="", FORMAT, COMPRESS, MAXCOL = 140; , version ; added "version" for mod002
 
END
GO
 
SHETR_CS_RECON_RPT_FTP_A go
 
########################################################################################################################################################

/*************************************************************************************
 * Fix for FirstNet Pre-Arrival Issue
 *************************************************************************************/

From: Kreinbring,Ryan 
Sent: Monday, March 17, 2008 4:35 PM
To: Hill,Ruth; Kaplan,Stacey; Cindy Dennis; michelle.trahan@sharp.com; david.rhodes@sharp.com
Subject: RE: ED notes from the meeting Tues.

 

I wanted to clarify this for everyone.  It may get a little technical at the end.  If the nurse cancels the pre-arrival that should inactivate (active_ind = 0) the row, thus the patient will not show in the box at the bottom.  The box of available patients to attach a pre-arrival to is a very specific subset of the tracking_prearrival table.  It looks at all patients who do NOT have an attached_ennctr_id (attached_ennctr_id = 0) and that are active (active_ind = 1).  This makes sense as this SHOULD be all patients that aren’t yet attached and haven’t been canceled.  Problem lies if a pre-arrival row somehow never gets attached and the pre-arrival is somehow checked out (usually by double clicking the bed column then moving them to checkout location) it will create these “orphaned” rows.  The following query should match what the application shows in the bottom box:

 

;***Query*****

select * from tracking_prearrival 
where attached_encntr_id = 0 
and active_ind = 1 go

 

Currently this returns 20 rows which is what shows in FirstNet.  I can easily batch update these 20 rows with an update statement to clean it out for now.  Basically, it will set the active_ind = 0 for all 20 of these rows.  The key before running this would be to ensure there are no legitimate pre-arrivals out there (and print these 20 rows in case we need to go back) as it will remove them all.  I am not sure this will be our long term solution as we need to understand better how it’s happening in the first place so we can stop it.  I think if we clean it up for now, it will allow us to monitor it better, (maybe run this query twice a day) so we can track down the users (by looking at the updt_id) and ask them what they are doing.  Somehow that yellow row is getting checked out of FirstNet tracking before its attached to a patient or cancelled.   

 

;***Fix******

UPDATE into tracking_prearrival
set active_ind = 0 where
attached_encntr_id = 0
and active_ind = 1 go
commit go

Here's another fix with based on tracking_prearrival_id:

 UPDATE into tracking_prearrival
 set active_ind = 0 where
 attached_encntr_id = 0
 and active_ind = 1 
 and not tracking_prearrival_id in (531937185.00) 
 go
 commit go
 
  UPDATE into tracking_prearrival
 set active_ind = 0 where
 attached_encntr_id = 0
 and active_ind = 1 
 and  tracking_prearrival_id in (531411472.00) 
 go
 
 531411472.00



If there is any concern from whoever may be running this in PROD please ask me and I will assist with running it to ensure there is no negative impact.


########################################################################################################################################################

/*************************************************************************************
 * ED Triage Report
 *************************************************************************************/
 
/*************************************************************************
      *  Copyright Notice:  (c) 1983 Laboratory Information Systems &        *
      *                              Technology, Inc.                        *
      *       Revision      (c) 1984-2007 Cerner Corporation                 *
      *                                                                      *
      *  Cerner (R) Proprietary Rights Notice:  All rights reserved.         *
      *  This material contains the valuable properties and trade secrets of *
      *  Cerner Corporation of Kansas City, Missouri, United States of       *
      *  America (Cerner), embodying substantial creative efforts and        *
      *  confidential information, ideas and expressions, no part of which   *
      *  may be reproduced or transmitted in any form or by any means, or    *
      *  retained in any storage or retrieval system without the express     *
      *  written permission of Cerner.                                       *
      *                                                                      *
      *  Cerner is a registered mark of Cerner Corporation.                  *
      *                                                                      *
 ************************************************************************
*****************************************************************************
        Source file name:   5_shrp_ca_ed_tri.prg
        Object name:        5_shrp_ca_ed_tri
        Request #:
 
        Product:            Discern Custom Programming
        Product Team:       Discern Custom Programming
        HNA Version:        HNAM  2005.02
        CCL Version:        CCL Rev: 8.2.5
 
        Program purpose:    Ed Triage Form
 
        Tables read:
 
        Tables updated:     None
 
        Executing from:     ExplorerMenu
 
        Special Notes:
****************************************************************************
****************************************************************************
*                      GENERATED MODIFICATION CONTROL LOG                  *
    ************************************************************************
*                                                                          *
*  Mod    Date     		Engineer        Comment      	    		       *
*  ---    ------------- --------------- -----------------------------------*
*  001    01/19/08	 	ah009892		Initial release
*  002    03/17/08	 	cc010582		Moved Layout
*  003    03/17/08	 	cc010582		Added Birthday
*  004    03/18/08		cc010582		Added Additional Med HX
*  005    03/18/08		cc010582		Modified SpO2
*  006    03/18/08	    cc010582		Added Social Behaviors
*  007    03/19/08		cc010582		Added Previous Surg
*  008    04/01/08      th012425        Modified Chief Complaint for non pediactric.
*                                       Added cheif complaint description for pediactric
   009    05/22/08      glaro			Testing changes to fix uncharted powerform
****************************************************************************/
 
;set trace backdoor p30ins go
drop program 5_shrp_ca_ed_tri:DBA go
create program 5_shrp_ca_ed_tri:DBA

prompt
	"Output to File/Printer/MINE" = "MINE"   ;* Enter or select the printer or file name to send this report to.
	, "FIN" = ""
 
with OUTDEV, FIN
 
execute reportrtl
%i cust_script:5_shrp_ca_ed_tri.dvl
 
set d0 = InitializeReport(0)
 
declare fnbr_cd = f8 with protected,
        constant(uar_get_code_by("DISPLAYKEY", 319, "FINNBR"))
declare canceled_cd = f8 with protected,
        constant(uar_get_code_by("DISPLAYKEY", 12025, "CANCELED"))
declare pharmacy_cd = f8 with protected,
        constant(uar_get_code_by("DISPLAY_KEY",6000,"PHARMACY"))
declare ordered_cd = f8 with protected,
        constant(uar_get_code_by("DISPLAYKEY",6004,"ORDERED"))
declare mrn_cd = f8 with protected,
        constant(uar_get_code_by("DISPLAYKEY", 4, "MRN"))
declare IND_ID = f8 with protect, noconstant(15.0)
declare LAST_ADMIN_DT_TM_ID = f8 with protect, constant(16.0)
declare ORDERED_STAT_CD = f8 with protect, constant(uar_get_code_by("MEANING", 6004, "ORDERED"))
declare PRESCRIPT_DISCH_FLAG = i2 with protect, constant(1)
declare RECORDED_HOME_MEDS_FLAG = i2 with protect, constant(2)
declare NONE_TEMP_FLAG= i2 with protect, constant(0)
declare TEMPLATE_TEMP_FLAG = i2 with protect, constant(1)
declare FUTURE_RECUR_TEMP_FLAG = i2 with protect, constant(5)
declare lMedHist = i4 with protected,noconstant(0)
declare lsocBeh = i4 with protected,noconstant(0)	; 006
declare lprevSurg = i4 with protected,noconstant(0)	; 007
declare alcUse = f8 with protect, constant(uar_get_code_by("DISPLAY",72,"Alcohol Use Row"))		; 006
declare tobUse = f8 with protect, constant(uar_get_code_by("DISPLAY",72,"Tobacco Use Row"))             ; 006
declare recUse = f8 with protect, constant(uar_get_code_by("DISPLAY",72,"Recreational Drug Use Row"))   ; 006
declare prevSurgv = f8 with protect, constant(uar_get_code_by("DISPLAY",72,"Previous Surgery Grid"))	; 007
declare behTxt = vc with public, noconstant(" ")							; 006
declare surgTxt = vc with public, noconstant(" ")							; 007
declare ctype = vc with public, noconstant(" ")								; 006
declare cuse = vc with public, noconstant(" ")                                                  	; 006
declare cfreq = vc with public, noconstant(" ")                                                 	; 006
declare clast = vc with public, noconstant(" ")                                                 	; 006
declare camnt = vc with public, noconstant(" ")                                                 	; 006
declare ofreq = vc with public, noconstant(" ")                                                 	; 006
declare croute = vc with public, noconstant(" ")                                                	; 006
declare surgDate = vc with public, noconstant(" ")							; 007
declare surgDesc = vc with public, noconstant(" ")							; 007
declare medHistCmt = vc with public, noconstant(" "); 008
 
record ed
(
 
  1 curdatetm = c45
  1 patNme = vc
  1 patId = f8
  1 encntrId = f8
  1 mrn = vc
  1 fin = vc
  1 age = vc
  1 dob = vc			; 003
  1 gender = vc
  1 allergies = vc
  1 meds = vc
  1 arrvTm = vc
  1 medHis = vc
  1 addMh = vc
  1 socBeh = vc			; 006
  1 prevSurg = vc		; 007
  1 trnpMd = vc
  1 tempOr = vc
  1 perPlsRt = vc
  1 rspRt = vc
  1 sysBl = vc
  1 dysBl = vc
  1 cfSite = vc
  1 oxSat = vc
  1 oxTh = vc
  1 Height = vc
  1 Weight = vc
  1 chCmp = vc
  1 arrBy = vc
 
)
 
record medHis
(
  1 qual[*]
    2 event_id = f8
)
 
record socBeh			; 006
(				; 006
  1 qual[*]			; 006
    2 event_id = f8		; 006
)				; 006
 
record prevSurg			; 007
(				; 007
  1 qual[*]			; 007
    2 event_id = f8		; 007
)				; 007
 
set ed->curdatetm =
        format(cnvtdatetime(curdate,curtime3),"MM/DD/YYYY HH:MM;;D")
  
select into "nl:"
 
  from encntr_alias ea
       ,encounter e
       ,person p
       ,person_alias pa
 
  plan ea where ea.alias = $FIN
        and ea.encntr_alias_type_cd = fnbr_cd
        and ea.active_ind = 1
        and ea.end_effective_dt_tm >= SYSDATE
 
  join e where e.encntr_id = ea.encntr_id
        and e.active_ind = 1
 
  join p where p.person_id = e.person_id
        and p.active_ind = 1
 
  join pa where pa.person_id = outerjoin(e.person_id)
         and pa.active_ind = outerjoin(1)
         and pa.person_alias_type_cd = outerjoin(mrn_cd)
 
  detail
     ed->patId = p.person_id
     ed->encntrId = e.encntr_id
     ed->patNme = p.name_full_formatted
     ed->mrn = cnvtalias(pa.alias,pa.alias_pool_cd)
     ed->fin = $FIN
     ed->age = trim(cnvtage(p.birth_dt_tm),3)
     ed->dob = trim(format(p.birth_dt_tm,"mm/dd/yyyy;;d"))						;003
     ed->gender = uar_get_code_display(p.sex_cd)
     ed->arrvTm  = format(cnvtdatetime(e.arrive_dt_tm), "mm/dd/yyyy hh:mm;;d")
 
  with nocounter
 
select into "nl:"
  event = uar_get_code_display(ce1.event_cd)
from dcp_forms_activity dfa,
     dcp_forms_activity_comp dfac,
     clinical_event ce,
     clinical_event ce1,
     clinical_event ce2
 
plan dfa
    ;where dfa.person_id = ed->patId
    where dfa.encntr_id = ed->encntrId
 
      and dfa.dcp_forms_ref_id IN (
      		select dfr1.dcp_forms_ref_id
      		from   dcp_forms_ref dfr1
      		where  dfr1.dcp_forms_ref_id = dfa.dcp_forms_ref_id
      		  and  cnvtupper(dfr1.definition) IN ( "ED TRIAGE ADULT","ED TRIAGE PEDIATRICS" )
      		  and  dfr1.end_effective_dt_tm = cnvtdatetime("31-DEC-2100 00:00:00")
      		  and  dfr1.active_ind = 1 ) ;end of sub-select
 
join dfac
    where dfac.dcp_forms_activity_id = dfa.dcp_forms_activity_id
      and dfac.parent_entity_name = "CLINICAL_EVENT"
join ce
    where ce.parent_event_id = dfac.parent_entity_id
      and ce.valid_until_dt_tm = cnvtdatetime("31-DEC-2100 00:00:00")
      	AND CE.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
 
join ce1
     where ce1.parent_event_id = ce.event_id
       and ce1.valid_until_dt_tm = cnvtdatetime("31-DEC-2100 00:00:00")
       	AND CE1.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
 
join ce2
     where ce2.parent_event_id = outerjoin(ce1.event_id)
       and ce2.valid_until_dt_tm = outerjoin(cnvtdatetime("31-DEC-2100 00:00:00"))
       	AND CE2.EVENT_TAG != outerjoin("In Error");Added to not show results from uncharted powerforms
 
       order by ce.event_id, ce1.event_id, event, ce1.event_end_dt_tm, ce2.event_end_dt_tm
 
detail
 
   if ( ce1.view_level = 1 )
    if ( (ce2.event_cd = alcUse) or (ce2.event_cd = TobUse) or (ce2.event_cd = RecUse))	; 006
      lsocBeh = lsocBeh + 1					; 006
      stat = alterlist(socBeh->qual, lsocBeh)                   ; 006
      socBeh->qual[lsocBeh].event_id = ce2.event_id             ; 006
    elseif (ce1.event_cd = prevSurgv)				; 007
     lprevSurg = lprevSurg + 1					; 007
     stat = alterlist(prevSurg->qual, lprevSurg)		; 007
     prevSurg->qual[lprevSurg].event_id = ce2.event_id		; 007
    else				                        ; 006
      case(CNVTUPPER(trim(ce1.event_title_text)))
          of "TRANSPORT MODE ORDER DETAIL":
            ed->trnpMd = trim(ce1.result_val)
          of "TEMPERATURE ORAL":
            ed->tempOr = concat(trim(ce1.result_val),"  ",
            trim(uar_get_code_display(ce1.result_units_cd)))
          of "PERIPHERAL PULSE RATE":
            ed->perPlsRt = concat(trim(ce1.result_val),"  ",
            trim(uar_get_code_display(ce1.result_units_cd)))
          of "RESPIRATORY RATE":
             ed->rspRt = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "SYSTOLIC BLOOD PRESSURE":
             ed->sysBl = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "DIASTOLIC BLOOD PRESSURE":
             ed->dysBl = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "CUFF SITE":
             ed->cfSite = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "SPO2":						;005
          of "OXYGEN SATURATION":				;005
             ed->oxSat = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "OXYGEN THERAPY":
             ed->oxTh = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "HEIGHT":
             ed->Height = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "DOSING WEIGHT":
             ed->Weight = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "CHIEF COMPLAINT":
             ed->chCmp = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          /**** 008 start *****/
          of "CHIEF COMPLAINT DESCRIPTION":
 ;008 note, after investigation in prod, CHIEF COMPLAINT was not disp.
 ;CC was not an event_title_text for actual pediactric patients
             ed->chCmp = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          /**** 008 end ****/
          of "ARRIVED BY":
             ed->arrBy = concat(trim(ce1.result_val),"  ",
             trim(uar_get_code_display(ce1.result_units_cd)))
          of "ADDITIONAL MEDICAL HISTORY":			;004
             ed->addMh = ce1.result_val				;004
          of "MEDICAL HISTORY":
             lMedHist = lMedHist + 1
             stat = alterlist(medHis->qual,lMedHist)
             medHis->qual[lMedHist].event_id = ce1.event_id
             ;ed->MedHis = concat(trim(ce1.result_val),"  ",
            ;trim(uar_get_code_display(ce1.result_units_cd)))
        endcase
       endif							;006
    else
       case(CNVTUPPER(trim(ce2.event_title_text)))
          of "TRANSPORT MODE ORDER DETAIL":
            ed->trnpMd = trim(ce2.result_val)
          of "TEMPERATURE ORAL":
            ed->tempOr = concat(trim(ce2.result_val),"  ",
            trim(uar_get_code_display(ce2.result_units_cd)))
          of "PRE HEART RATE MONITOR":
            ed->perPlsRt = concat(trim(ce2.result_val),"  ",
            trim(uar_get_code_display(ce2.result_units_cd)))
          of "RESPIRATORY RATE":
             ed->rspRt = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "SYSTOLIC BLOOD PRESSURE":
             ed->sysBl = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "DIASTOLIC BLOOD PRESSURE":
             ed->dysBl = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "CUFF SITE":
             ed->cfSite = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "OXYGEN SATURATION":
             ed->oxSat = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "OXYGEN THERAPY":
             ed->oxTh = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "HEIGHT":
             ed->Height = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "DOSING WEIGHT":
             ed->Weight = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "CHIEF COMPLAINT":
             ed->chCmp = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          /**** 008 start *****/
          of "CHIEF COMPLAINT DESCRIPTION":
             ed->chCmp = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          /**** 008 end ****/
          of "ARRIVED BY":
             ed->arrBy = concat(trim(ce2.result_val),"  ",
             trim(uar_get_code_display(ce2.result_units_cd)))
          of "MEDICAL HISTORY":
             lMedHist = lMedHist + 1
             stat = alterlist(medHis->qual,lMedHist)
             medHis->qual[lMedHist].event_id = ce2.event_id
             ;ed->MedHis = concat(trim(ce2.result_val),"  ",
             ;trim(uar_get_code_display(ce2.result_units_cd)))
        endcase
    endif
 
with nocounter
declare ind = i4 with protected,noconstant(0)
 
/*MEDICAL HISTORY*/
 
 /******* 008 start, commenting old code out**********
select into "nl:"
 from
clinical_event ce,
clinical_event ce1,
clinical_event ce3
  
plan ce3 where ce3.encntr_id = ed->encntrId
and ce3.event_title_text = "Medical History"
and ce3.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
 
join ce where ce.parent_event_id = ce3.event_id
      and ce.event_title_text = "Discrete Grid"
join ce1 where ce1.parent_event_id = ce.event_id
     and ce1.result_val = "Yes"
detail
 
  if (ed->medHis > " " )
     ed->medHis = concat(ed->medHis,", ",trim(ce1.event_title_text))
  else
     ed->medHis = trim(ce1.event_title_text)
  endif
 
with nocounter
 */
 
;CALL ECHORECORD(medHis)
;call echorecord(ed)
; /************ 008 end **********************
/************* 008 new code *************/
select into "nl:"
 
;ce.*
ce1.*
 from
clinical_event ce,
clinical_event ce1,
clinical_event ce3,
 
;clinical_event ce2,
ce_event_note cen2,
long_blob lb2

plan ce3 where ce3.encntr_id = ed->encntrId
	and ce3.event_title_text = "Medical History"
	and ce3.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
		AND CE3.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
join ce where ce.parent_event_id = ce3.event_id
    and ce.event_title_text = "Discrete Grid"
	and ce.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
		AND CE.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
join ce1 where ce1.parent_event_id = ce.event_id
    and ce1.result_val = "Yes"
	and ce1.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
		AND CE1.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
join cen2 where cen2.event_id = outerjoin(ce1.event_id)
	and cen2.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
join lb2 where lb2.parent_entity_id = outerjoin(cen2.ce_event_note_id)
 
detail
 
 if (lb2.long_blob_id > 0) ;makes sure there is a long blob, else just brackets will show
 medhistcmt = lb2.long_blob
  y1 = size(trim(medHistCmt)); sizes the
 medHistCmt = concat( "[ ",substring(1,y1-8,( trim(lb2.long_blob)))," ]");008
 endif
 
  if (ed->medHis > " " )
 	if (medhistcmt > " "); if there is a med hist comment
 
	     ed->medHis = concat(ed->medHis,", ",trim(ce1.event_title_text),medHistCmt)
     else
    	 ed->medHis = concat(ed->medHis,", ",trim(ce1.event_title_text))
    endif
 
  else
 	if (medhistcmt > " ")
 
    	 ed->medHis = concat(trim(ce1.event_title_text),medHistCmt)
    else
    	 ed->medHis = concat(ed->medHis,", ",trim(ce1.event_title_text))
 	endif
  endif
 
 
with nocounter
/****************** 008 end ****************/
 
 
/* ALLERGIES */
 
select into "nl:"
from allergy a,
     nomenclature n
plan a where a.person_id = ed->patId
;plan a where a.person_id = ed->encntrId
         and a.active_ind+0 = 1
         and a.beg_effective_dt_tm+0 <= SYSDATE
         and (a.end_effective_dt_tm+0 >= SYSDATE
                or a.end_effective_dt_tm + 0 = NULL)
         and a.reaction_status_cd+0 != canceled_cd
join n where n.nomenclature_id = outerjoin(a.substance_nom_id)
order a.person_id, a.onset_dt_tm
 
detail
 
  if ( ed->allergies > " " )
       ed->allergies = concat(ed->allergies,", ")
  endif
 
  if (n.source_string > " ")
    ed->allergies = concat(ed->allergies,trim(n.source_string))
  elseif (a.substance_ftdesc > " ")
    ed->allergies = concat(ed->allergies,trim(a.substance_ftdesc))
  endif
 
with nocounter
 
/* 006 Find Social Behaviors */
select into "nl:"
 socType = cnvtupper(trim(uar_get_code_display(ce1.event_cd)))
from  (dummyt d with seq = size(socBeh->qual,5))
     ,clinical_event ce1
     ,clinical_event ce2
plan d
join ce1
 where	ce1.event_id = socBeh->qual[d.seq].event_id
 and	ce1.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
 	AND CE1.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
join ce2
 where	ce2.parent_event_id = ce1.event_id
 and    ce2.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
 	AND CE2.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
order by
  socType
 ,ce1.event_id
 ,ce2.clinical_event_id
head ce1.event_id
 behTxt = " ", ctype = " ", cuse = " ", cfreq = " ", clast = " ", camnt = " ", ofreq = " ", croute = " "
head ce2.clinical_event_id
 case(cnvtupper(ce2.event_title_text))
  of "ALCOHOL USE":		cuse = concat(trim(ce2.result_val)," Alcohol Use")
  of "TOBACCO USE":     	cuse = concat(trim(ce2.result_val)," Tobacco Use")
  of "DRUG USE":		cuse = concat(trim(ce2.result_val)," Drug Use")
  of "CIGARETTE USE PACKS/DAY": cfreq = concat(" ", trim(cnvtstring(ce2.result_val)))
  of "OTHER TOBACCO FREQUENCY": ofreq = concat(" and ",trim(ce2.result_val)," ")
  of "TYPE":	   		ctype = concat(" ",trim(ce2.result_val))
  of "FREQUENCY":  		cfreq = concat(" ",trim(ce2.result_val))
  of "AMOUNT":     		camnt = concat(" ",trim(ce2.result_val))
  of "LAST USE":   		clast = concat(" (",trim(ce2.result_val),")")
  of "ROUTE":			croute = concat(" via ",trim(ce2.result_val)," ")
 endcase
foot ce1.event_id
 behTxt = concat(cuse, ctype, camnt, cfreq, ofreq, croute, clast)
 ed->socBeh = build(ed->socBeh,behTxt,char(10))
with nocounter
/* 006 End Find Social Behaviors */
  
/* 007 Find Surgical History */
 select into "nl:"
 from 	 (dummyt d1 with seq = size(prevSurg->qual,5))
 	,clinical_event ce1
 	,clinical_event ce2
 plan	d1
 join	ce1
  where ce1.event_id = prevSurg->qual[d1.seq].event_id
  and	ce1.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
  	AND CE1.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
 join	ce2
  where	ce2.parent_event_id = ce1.event_id
  and	ce2.valid_until_dt_tm = cnvtdatetime("31-DEC-2100")
  	AND CE2.EVENT_TAG != ("In Error");Added to not show results from uncharted powerforms
 order by
   ce1.event_id
  ,ce2.clinical_event_id
 head ce1.event_id
  surgTxt = " "
  surgDesc = " "
  surgDate = " "
 head ce2.clinical_event_id
  case(cnvtupper(ce2.event_title_text))
   of "SURGERY DATE":		surgDate = concat(trim(ce2.result_val))
   of "SURGERY DESCRIPTION": 	surgDesc = concat(trim(ce2.result_val))
  endcase
 foot ce1.event_id
  surgTxt = build(surgDate, ": ", surgDesc)
  ed->prevSurg = build(ed->prevSurg,surgTxt,char(10))

/* 007 End Find Surgical History */
 
	select into "nl:"
		o.ordered_as_mnemonic,
		o.hna_order_mnemonic,
		o.clinical_display_line
 
	from 	orders o
 
	plan o
		where o.person_id = ed->patId
		;where o.person_id =	ed->encntrId
		and o.orig_ord_as_flag in (PRESCRIPT_DISCH_FLAG, RECORDED_HOME_MEDS_FLAG)
		and o.template_order_flag in (NONE_TEMP_FLAG, TEMPLATE_TEMP_FLAG, FUTURE_RECUR_TEMP_FLAG)
		and o.order_status_cd = ORDERED_STAT_CD
		and o.active_ind = 1
		and NOT EXISTS(select odp.order_id
					from order_dispense odp
					where odp.order_id = o.order_id
						and ((odp.parent_order_id+0 > 0)
		              			or ((odp.parent_order_id+0 = 0) and (o.person_id+0 = odp.person_id+0))))
  
	detail
 
  if (ed->meds > " " )
     ed->meds = concat(ed->meds,", ",trim(o.ordered_as_mnemonic))
  else
     ed->meds = trim(o.ordered_as_mnemonic)
  endif
 with nocounter


select into "nl:"
 
 from (dummyt d1)
 
   plan d1
 
  head report
  null = 0
 
 detail
 
   d0 = DetailSection(Rpt_Render)
   null = 0
 
with nocounter
 
set d0 = FinalizeReport($OUTDEV)
 
end
go

########################################################################################################################################################

/*************************************************************************************
 * Query for pref maint configuration position tab powerchart application
 *************************************************************************************/

SELECT 
	PosCD= V.POSITION_CD,
	Position = UAR_GET_CODE_DISPLAY( V.POSITION_CD ),
	Component=V.VIEW_NAME,
	Display_Order=cnvtint(N1.PVC_VALUE),
	TabName=N.PVC_VALUE,
	Pref=N2.PVC_NAME,
	Pref_Val=N2.PVC_VALUE

FROM
	VIEW_PREFS  V,
	NAME_VALUE_PREFS  N,
	DETAIL_PREFS  D,
	NAME_VALUE_PREFS  N1,
	NAME_VALUE_PREFS  N2

PLAN  V WHERE V.ACTIVE_IND = 1 
;      AND V.POSITION_CD = 46897   ;  Position (CPR BUILD)
      AND V.FRAME_TYPE = "CHART"
      AND V.APPLICATION_NUMBER = 600005 ; Powerchart
JOIN  N WHERE N.PARENT_ENTITY_ID = V.VIEW_PREFS_ID
      AND  N.ACTIVE_IND = 1
      AND  N.PVC_NAME = "VIEW_CAPTION"
JOIN  N1 WHERE N1.PARENT_ENTITY_ID = V.VIEW_PREFS_ID
      AND  N1.ACTIVE_IND = 1
      AND  N1.PVC_NAME = "DISPLAY_SEQ"
JOIN  D WHERE D.ACTIVE_IND = 1
      AND  D.APPLICATION_NUMBER = 600005
      AND  D.POSITION_CD =  V.POSITION_CD
      AND  D.VIEW_NAME =  V.VIEW_NAME
      AND  D.VIEW_SEQ =  V.VIEW_SEQ
JOIN  N2 WHERE N2.PARENT_ENTITY_ID = D.DETAIL_PREFS_ID
      AND  N2.ACTIVE_IND = 1
      ;AND  N2.PVC_NAME = "R_*"  ; Set to wrench preference of interest

ORDER BY	Position,
	Display_Order,
	Component
END
GO



########################################################################################################################################################

;------------------------------------------
;App Prefs
;------------------------------------------
select
cv.code_value, a.description, position = cv.display, nvp.pvc_name, nvp.pvc_value, ap.app_prefs_id, nvp.name_value_prefs_id
from app_prefs ap, code_value cv, name_value_prefs nvp, application a
plan ap where  ap.prsnl_id = 0
join nvp where nvp.parent_entity_id = ap.app_prefs_id
join cv where cv.code_value = outerjoin(ap.position_cd)
join a where a.application_number = ap.application_number 
order by cv.display, nvp.pvc_name
go

;------------------------------------------
;Detail Prefs
;------------------------------------------
select
cv.code_value
, a.description
, position = cv.display
;, dp.view_name
;, dp.comp_name
, dp.*
, nvp.pvc_name
, nvp.pvc_value
, dp.detail_prefs_id
, nvp.name_value_prefs_id
, nvp.parent_entity_id

from detail_prefs dp, code_value cv, name_value_prefs nvp, application a
plan dp where dp.prsnl_id = 0 and dp.active_ind = 1

join nvp where nvp.parent_entity_id = dp.detail_prefs_id

join cv where cv.code_value = outerjoin(dp.position_cd)
join a where a.application_number = dp.application_number 
order by cv.display, dp.view_name, dp.comp_name, nvp.pvc_name
go



########################################################################################################################################################

/*************************************************************************************
 * Radiology Discontinued Orders
 *************************************************************************************/

drop program 1_RAD_CANCELED_ORDERS go
create program 1_RAD_CANCELED_ORDERS

prompt 
	"Output to File/Printer/MINE" = "MINE"   ;* Enter or select the printer or file name to send this report to.
	, "Start Date/Time:" = "SYSDATE"
	, "End Date/Time:" = "SYSDATE" 

with OUTDEV, dtStart, dtEnd


SELECT INTO $OUTDEV
	P.NAME_FULL_FORMATTED
	, FIN = EA.alias
	, O_CATALOG_TYPE_DISP = UAR_GET_CODE_DISPLAY(O.CATALOG_TYPE_CD)
	, O.ORDER_MNEMONIC
	, ORDER_STATUS_CDF = UAR_GET_CODE_MEANING( O.ORDER_STATUS_CD )
	, o.discontinue_effective_dt_tm ";;q"
	, LOC_NURSE_UNIT_DISP = UAR_GET_CODE_DISPLAY( E.LOC_NURSE_UNIT_CD )
	, LOC_ROOM_DISP = UAR_GET_CODE_DISPLAY( E.LOC_ROOM_CD )
	, LOC_BED_DISP = UAR_GET_CODE_DISPLAY( E.LOC_BED_CD )
	, E.REASON_FOR_VISIT	
	, O.ORIG_ORDER_DT_TM
	, O.CLINICAL_DISPLAY_LINE
	;, o.active_status_dt_tm ";;q"
	;, o.clin_relevant_updt_dt_tm ";;q"
	;, o.current_start_dt_tm ";;q"
	;, o.interest_dt_tm ";;q"
	;, o.modified_start_dt_tm ";;q"
	;, o.projected_stop_dt_tm ";;q"
	;, o.resume_effective_dt_tm ";;q"
	;, o.soft_stop_dt_tm ";;q"
	;, o.status_dt_tm  ";;q"; the date and time of the last order status change.
	;, o.suspend_effective_dt_tm ";;q"
	;, o.updt_dt_tm ; the date and time the row was last inserted or updated.
	;, o.valid_dose_dt_tm ";;q"

FROM
	ORDERS   O
	, PERSON   P
	, ENCOUNTER   E
	, ENCNTR_ALIAS EA
	
PLAN  O  WHERE  ;o.order_id = 17920775
;	O.discontinue_effective_dt_tm >= CNVTDATETIME(CNVTDATE(052008), 0)
;	O.discontinue_effective_dt_tm between cnvtdatetime($dtEnd) and cnvtdatetime($dtStart)
	(o.discontinue_effective_dt_tm >= cnvtdatetime($dtStart)
	 	and o.discontinue_effective_dt_tm <= cnvtdatetime($dtEnd))
	
	AND O.order_status_cd =        2545.00; 2542.00 canceled
	AND O.catalog_type_cd =        2517.00
JOIN P  WHERE  P.PERSON_ID = O.PERSON_ID
JOIN E  WHERE  E.ENCNTR_ID = O.ENCNTR_ID
JOIN EA WHERE EA.encntr_id = E.encntr_id
	AND EA.encntr_alias_type_cd = 1077.00
	and ea.end_effective_dt_tm  >= cnvtdatetime(curdate,curtime)
                                                           

ORDER BY
	E.LOC_NURSE_UNIT_CD
	, P.NAME_FULL_FORMATTED
	, O.ORDER_MNEMONIC

WITH NOCOUNTER, SEPARATOR=" ", FORMAT, MAXCOL = 500, TIME = 120

end
go

########################################################################################################################################################

/*************************************************************************************
 * Query to search for order sets, care plans
 *************************************************************************************/

SELECT
	ORD_TYPE = IF (oc.orderable_type_flag = 2)
	"Care Set - Super Group"
ELSEIF (oc.orderable_type_flag = 3)
	"Care Plan"
ELSEIF (oc.orderable_type_flag = 6)
	"Care Set - Order Set"
ENDIF
	, OC.*
	, OC_DCP_CLIN_CAT_DISP = UAR_GET_CODE_DISPLAY(OC.DCP_CLIN_CAT_CD)

FROM
	order_catalog   oc

where oc.orderable_type_flag in (2,3,6)
	AND OC.active_ind = 1
;AND OC.updt_applctx =  180692935.00

ORDER BY
	ORD_TYPE

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   VE Report of an Orders Audit by Nursing Station
   
   Description
   VE Report for Active Person's Orders within a certain Date Range entered by the User. 2 prompts of the Start and Ending order_detail.OE_FIELD_DT_TM_VALUE are used to qualify on. Report prints headings by Nursing Station, Person's Name, and under Order
   
   Install 
   AUDIT_PT_ORDERS.VCL

 *************************************************************************************/


########################################################################################################################################################

/*************************************************************************************
 * 
 *************************************************************************************/

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   CareSet Audit Report
   
   Description
   CareSet Audit Report. Lists all the Caresets that are built along with their components and any order sentences built,Will list the following: Primary Mnemonic of the CareSet; Mnemonic of every component of the CareSet; Order Sentence(if built) for every
   
   Install 
   Care_CareSet_Audit.VCL

 *************************************************************************************/

See F drive.
   
########################################################################################################################################################
   
/*************************************************************************************
 * Purpose 
   This program displays MDR status and all isolation types for patients with the status of Observation and Inpatient. 
   
   Description
   Patient Isolation Report

 *************************************************************************************/

See code in F drive.

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Query Example of how to use the Discern Explorer evaluate function with a record structure.
   
   Description
   This program provides example code showing how to use the evaluate function with a record structure. The EVALUATE command evaluates an expression. It can be used to show the contents of a variable or perform simple calculations at the debugger command li 
 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_evaluate
Source Code File: ccl_evaluate.prg
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: None 
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: ccl_evaluate 
Objects Dropped: None 
Description: This program provides example code showing how to use the 
evaluate function with a record structure. 
The EVALUATE command evaluates an expression.  It can be used to show
the contents of a variable or perform simple calculations at the
debugger command line.  The results of the EVALUATE command are
displayed on the output line at the bottom of the debugger window.
In the example below when running this program, XYZ should be
displayed to the screen because the record structure field was
set to 1.
**************************************************************************/ 


DROP PROGRAM CCL_EVALUATE GO
CREATE PROGRAM CCL_EVALUATE

RECORD REC1
   (1  FLD = I4)

SET REC1->FLD = 1

set TEST1 = evaluate(REC1->fld,   	;case expression            
	     1, "XYZ",      		;if    1 return XYZ
             0, null,       		;elseif 0 return null 
	     "ZZZ")			;else     return ZZZ

CALL ECHO (TEST1)

END
GO

CCL_EVALUATE GO

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Program example of Execute/Screenwriter
   
   Description
   This program provides example code showing how to use the Discern Explorer execute function with screenwriter. Executing a program (EXECUTE) enables you to pass parameters to and run another program. This generally is used to run any Discern Explorer pro

 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_execute_exam 
Source Code File: ccl_execute_exam.prg
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: None
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: ccl_execute_exam 
Objects Dropped: None 
Description: This program provides example code showing how to use the 
Discern Explorer execute function with screenwriter. 
Executing a program (EXECUTE) enables you to pass parameters
to and run another program.  This generally is used to run any
Discern Explorer program that is stored in the object library.
When EXECUTE is used to execute a stored program, the program 
can prompt for each parameter separately. The ccl_start.inc
will also need to be copied from the Library in order for this program
to include(%I) without error. This program is executing 3 standard
ccl programs, CCLGLOS, TABLEDEF2, CCLORATABLE from a screen app.
**************************************************************************/ 


drop program CCL_EXECUTE_EXAM:dba go
create program CCL_EXECUTE_EXAM:dba
  
paint

set selection_nbr = 0

#start
%i CCL_start.inc

  call text(5,32,"EXECUTE EXAMPLE")
  call text (10,10," 1 - Glossary")
  call text (12,10," 2 - DATA DICTIONARY")
  call text (14,10," 3 - Indexes")
  call text (16,10," 4 - END")
  call text (24,2," Enter Selection or Hit  to Exit :                ")
  call text (24,60,"                 ")
  call accept(24,42,"9;CU","4"
      WHERE CURACCEPT IN ("1","2","3","4"))
  set selection_nbr = cnvtint(curaccept)
  call clear (1,1)

  case (selection_nbr)
    of 1:
      execute CCLGLOS
    of 2:
      execute TABLEDEF2 
    of 3:
      execute CCLORATABLE
    of 4:
      go to LAST
  endcase
  GO TO START

#LAST
  CALL CLEAR(1,1)

END GO

CCL_EXECUTE_EXAM go


########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Example of how to load record structure and join to it.
   
   Description
   This program provides example code showing how to load persons' into a record structure, then join the record structure to the person_alias table. The query will need to be included(%I) at command line to execute.
   
 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_join_rec_struc_exam 
Source Code File: ccl_join_rec_struc_exam.ccl
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: Person, Dummyt, Person_Alias 
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: None
Objects Dropped: None 
Description: This program provides example code showing how to load 
persons' into a record structure, then join the record structure 
to the person_alias table. The query will need to be included(%I)
at command line to execute.
**************************************************************************/ 

;ccl_join_rec_struc_exam.ccl 

cclseclogin go

free record person go
;create the record structure
record person(
1 person[*]
2 id = f8
2 name = c20 )
go

select p.person_id,
name = substring(1,20,p.name_full_formatted)

from person p

where p.person_id >0

order p.person_id

head report
;initialize counter variables
cntp = 0
cntpx = 0

;initialize 10 positions in the person segment of the record structure
stat = alterlist(person->person,10)

detail
cntp = cntp +1

;add positions to the person segment if needed
stat = mod(cntp,10)
if(stat = 1 and cntp != 1)
stat = alterlist(person->person,cntp + 10)
endif
;store the data in the record structure
person->person[cntp].id = p.person_id
person->person[cntp].name = name


foot report
;remove unused person positions
stat = alterlist(person->person, cntp)

;display the data stored in the record structure
for(cntpx = 1 to cntp)
col 1 person->person[cntpx].id
col +1 person->person[cntpx].name
row +1
endfor

with maxrec = 1000
go


;join the record structure to the person_alias table

select into "NL:" ;do the select in memory
pa.person_id,
pa.alias
;the value and size functions are used to determine the 
;number of positions in the person record structure
from (dummyt d with seq = value(size(person->person,5))),
person_alias pa

plan d
join pa where person->person[d.seq].id = pa.person_id

detail ;echo information to the screen with out using the displayer
call echo(build(
"-- pid =",
person->person[d.seq].id,
"-- name =",
person->person[d.seq].name,
"-- alias =",
pa.alias))

go


########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Share information with other users regarding best practices in testing the Discern Suite of products
   
   Description
   This is not a program it is sample of some testing scripts that have been customized for our site.
   
   
   Supporting Documentation Files
      DISCERN.XLS
 *************************************************************************************/

Look in F drive in CCl\Documentation folder

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   VE Report of Emergency Census Report
   
   Description
   VE Report to print Emergency encounters by Facility and Nursing Station within a certain date range entered by the user by the two prompts of beginning and ending dates. Current date is the default for both prompts which will extract one days data if pro
   
   Install 
   ER_CENSUS.VCL
 *************************************************************************************/

Code goes here.


########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   This program demonstrates how to use DCL commands on AIX to send the output of a report (when sent to a file) as an attachement.
   
   Description
   Sample of how to email the output of a report as an attachement using DCL on an AIX system.
   
 *************************************************************************************/

;email_report.prg
;
;This is a CCL example of emailing the output of a report as an attachment.
;
;Created on: 2/13/2004
;Created by:
; Randy Schauffele, Sr. Programmer/Analyst
; Adventist Health
; 1101 Creekside Ridge Dr., Suite 150
; Roseville, CA 95678
; (916) 783-2500
; schaufrs@ah.org
;
;Copyright 2004

drop program email_report go
create program email_report

prompt "Email Address " = ""

;these files will be put in $CCLUSERDIR by default
set output_file = "report_out.csv"
set message_file = "report_out.msg"

;output report to the output csv file
select into value( output_file )
*
from organization
with format, format=pcformat ;, noheading


;email output as an attachment
;Three AIX commands
; 1 echo the body of the email to the temporary message file
; 2 uuencode the report output (turns the file into an email attachment) and append it to the message file
; 3 echo the contents of the message file into the mailx command and send it to $1
; (multiple email addresses will work, separate with a space)

set dclcom1 = concat( 'echo "Attached is the output of email_report.\n\nPlease do not respond to this email." > ', message_file,
' && ', 'uuencode ', output_file, ' ', output_file, ' >> ', message_file,
' && ', 'cat ', message_file, ' | mailx -s "email_report" ', $1 )
set dcllen1 = size( trim( dclcom1 ) )
set dclstatus = 0
call dcl( dclcom1, dcllen1, dclstatus )

;"&&" between korn shell commands is a test, if any of the commands fail the execution stops.
;You may want to add commands to clean up temporary files when done
;To send the output of the report in the body of the email you can skip the message_file steps and cat the 
; ouput file directly to mailx.

end
go
   
########################################################################################################################################################
   
/*************************************************************************************
 * Purpose 
   This program is a quick way to identify the encntr_id and person_id for troubleshooting and diagnosing front end problmes
   
   Description
   With this program the user is prompted to key in the FIN # and the encntr_id, person_id and the name of the person will be returned. This program is similar to the program PN, CV etc.
   
 *************************************************************************************/

DROP PROGRAM FIN GO
CREATE PROGRAM FIN
PROMPT "Fin #: " = "xxxxxxxx"

SELECT INTO MINE
ea.encntr_id,
p.person_id,
p.name_full_formatted

FROM
encntr_alias ea,
encounter e,
person p

plan ea WHERE ea.alias = ($1)
join e where e.encntr_id = ea.encntr_id
join p where p.person_id = e.person_id
WITH NOCOUNTER
END GO

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   This visual explorer query is a simple way to access HL7 messages that Millennium has recieved during a set period of time. It is a good tool to confirm that messages from interfaced systems are seen in Millennium
   
   Description
   HL7 extraction tool that returns messages recieved by Millennium during a set time period. 
   
   Install 
      HL7 MESSAGES.VCL

 *************************************************************************************/

Code goes here.



########################################################################################################################################################

/*************************************************************************************
 * 
 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_wrap_text_exam 
Source Code File: ccl_wrap_text_exam.inc
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: None
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: None 
Objects Dropped: None 
Description: This subroutine can be used in CCL programs 
to wrap textual fields in reportwriter.  In Visual Explorer,
it can be included using %I in the Subroutines section of 
the Report menu and then called in the report.
This routine will need to be copied into the cclsource directory
in order to execute for the ccl_wrap_text_exam.prg in the libary,
otherwise the directory in the ccl_wrap_text_exam would need to
be modified to the directory where the ccl_wrap_text_exam.inc
has been copied to. The .inc does NOT need to be included.
************************************************************************/ 

SUBROUTINE CCL_WRAP_TEXT(X, Y, Z)  ;name of the subroutine is CCL_WRAP_TEXT

;The parameters X, Y, and Z will be passed from the program when this
;subroutine is called.
;X = column where item is placed on report 
;Y = the length of the text string before it wraps
;Z = the textual field that is being placed on the report

;initialize variables
        eol = SIZE(TRIM(Z),1)   ;finds total length of trimmed textual field
        bseg = 1
	eseg = 1
	line = SUBSTRING(bseg, eol, Z)

        while(eseg <= eol )
                bseg = eseg
                eseg = eseg + y
                ;if there is a space in the segment, break on the space
                if(findstring(" ",substring(bseg,eseg-bseg,line))>0)
                     while(substring(eseg -1,1,line) != " " and eseg !=bseg)
                                eseg = eseg -1
                     endwhile
                     segment = substring(bseg,(eseg - bseg) -1, z)
                else
                     segment = substring(bseg,(eseg - bseg), z)
                endif
                col x call print(substring(1,y,segment))
                row +1
        endwhile
END

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Example of Set variable command.
   
   Description
   This program provides example code showing how to use the SET variable command for local and global variables. The variables are declared and initialized using the SET variable command. The syntax of this command is shown below: SET variable = expression

 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_variables 
Source Code File: ccl_variables.prg
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: Dummyt 
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: ccl_variables 
Objects Dropped: None 
Description: This program provides example code showing how to use
the SET variable command for local and global variables. 
The variables are declared and initialized using the SET variable
command. The syntax of this command is shown below:
SET variable = expression 
The variable name can be any combination of letters or numbers,
but you should avoid using names that are already in use by
Discern Explorer (any command like SELECT or SET, or any 
reserved variables like CURDATE or CURACCEPT). 
The expression to which you set a variable can be any alphabetic,
numeric, or mathematics equation, an array, or a 
function (like the FILLSTRING( ) function. Four variables are 
initialized to the data types in which they are going to store
the data. Two variables (a,d) are set in the select making them
local variables, two variables(b,c) are set in the detail making
them global variables.
**************************************************************************/ 

drop program ccl_variables go
create program ccl_variables

;declare and initialize user variables.
set a = 0
set b = 0.0
set c = cnvtdatetime(curdate,curtime3)
set d = fillstring(10," ")

select ;local variables
a = 10,
d = "Smith"
from dummyt
detail ;global variables
b = 10.2
c = cnvtdatetime("01-jan-1998")
col 0 a
col+1 b
col+1 c ";;q"
col+1 d
with nocounter


call echo(build("local a:",a) )
call echo(build("global b:",b) )
call echo(build("global c:",format(c,";;q") ) )
call echo(build("local d:",d) )

end 
go

ccl_variables go

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Example of program to wrap large text fields in reportwriter
   
   Description
   This program provides example code showing how to use the subroutine, CCL_WRAP_TEXT, to wrap a textual field in the report writer section of the program. In the Head Report 

 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_wrap_text_exam 
Source Code File: ccl_wrap_text_exam.prg
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: PROBLEM, PROBLEM_COMMENT, NOMENCLATURE, PERSON 
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: ccl_wrap_text_exam 
Objects Dropped: None 
Description: This program provides example code showing how to use
the subroutine, CCL_WRAP_TEXT, to wrap a textual field in the 
report writer section of the program. In the Head Report
%i cclsource:ccl_text_wrap.inc will include text from that
subroutine in the program. The text from the problem_comment 
table will print 100 characters per line of a 1000 character 
data field.
************************************************************************/ 

DROP PROGRAM CCL_WRAP_TEXT_EXAM GO
CREATE PROGRAM CCL_WRAP_TEXT_EXAM

SELECT	P.PERSON_ID,
	N.SOURCE_STRING,
	PROBLEM_COMMENT = SUBSTRING( 1, 1000, PC.PROBLEM_COMMENT ),
	P.ONSET_DT_TM "MM/DD/YYYY;;D",
	PE.NAME_FULL_FORMATTED

FROM	PROBLEM  P,
	PROBLEM_COMMENT  PC,
	NOMENCLATURE  N,
	PERSON  PE

PLAN P WHERE P.PERSON_ID > 0       ;=  58657

JOIN PE WHERE PE.PERSON_ID = P.PERSON_ID

JOIN N WHERE N.NOMENCLATURE_ID = P.NOMENCLATURE_ID

JOIN PC WHERE PC.PROBLEM_ID = P.PROBLEM_ID

ORDER	PE.NAME_LAST_KEY

Head Report

%i cclsource:ccl_text_wrap.inc

Head Page
	COL 57  "PROBLEMS/COMMENTS REPORT"
	ROW + 2

Head  PE.NAME_LAST_KEY
	NAME_FULL_FORMATTED1 = SUBSTRING( 1, 20, PE.NAME_FULL_FORMATTED ),
	COL 7  "PERSON NAME:"
	COL 20  NAME_FULL_FORMATTED1
	ROW + 2

Detail
	if ((ROW + 4) >= maxrow)  break endif
	SOURCE_STRING1 = SUBSTRING( 1, 100, N.SOURCE_STRING ),
	COL 7 "ONSET DATE/TIME:"
	COL 24 P.ONSET_DT_TM
	ROW+1
	COL 7  "PROBLEM:"
	COL 16  SOURCE_STRING1
	ROW + 1
	COL 7  "COMMENT: "
	CALL CCL_WRAP_TEXT (COL, 100, PC.PROBLEM_COMMENT)
	ROW + 2

Foot PE.NAME_LAST_KEY
	ROW + 1

WITH  	MAXREC = 2000, 
	MAXCOL = 500
	
END
GO

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Example of Subroutine
   
   Description
   This program provides example code showing how to define a subroutine and use it in the detail section of a select command.

 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_subroutine_exam 
Source Code File: ccl_subroutine_exam.prg
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: Person 
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: ccl_subroutine_exam 
Objects Dropped: None 
Description: This program provides example code showing how to 
define a subroutine and use it in the detail section of a 
select command.
**************************************************************************/ 
drop program ccl_subroutine_exam:dba go
create program ccl_subroutine_exam:dba


;declare the subroutine
declare sample_sub( x ) = c40

;define the subroutine
;sample_sub will convert the passed parameter to a string 
;and concatenate the text "Test:" to that string

subroutine sample_sub( x )
  set temp_str = concat("Test:",cnvtstring(x))
  return (temp_str)
end ;sample_sub


free record myrec
;create a record structure for testing
record myrec(
	1 qual[*]
	  2 person_id = f8
	  2 sample    = c40
)

set cntg = 0

;the following select statement calls the subroutine in the
;detail section and populates the sample section of the 
;myrec record structure with the value returned by the subroutine

select into "NL:"
	p.person_id
from	person p
where	p.sex_cd > 0
head report
	cnt = 0
detail
	if(mod(cnt,10)=0)
		stat = alterlist(myrec->qual, cnt + 10)
	endif
	cnt = cnt +1
	myrec->qual[cnt].person_id = p.person_id
	myrec->qual[cnt].sample = sample_sub(p.sex_cd)
foot report
	cntg = cnt
	stat = alterlist(myrec->qual, cnt)
	for(cntx = 1 to cnt)
		call echo(myrec->qual[cntx].person_id)
	endfor
with maxrec = 25


;for trouble shooting echo out the data stored in the myrec structure
for(cntl = 1 to cntg)
	call echo(build(
		"person_id:",
		myrec->qual[cntl].person_id,
		"sex_cd:",
		myrec->qual[cntl].sample))
endfor

end go
ccl_subroutine_exam:dba go

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Example of how to use a .inc within a program
   
   Description
   This program provides example code showing how to include the ccl_include.inc file within a program. The .inc is used for the screenwriter part of the program. The line %M ccl_include.inc within the progam is inserted at the point where the program shou

 *************************************************************************************/

/************************************************************************ 
Program Name: ccl_include_exam 
Source Code File: ccl_include_exam.prg
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: Person
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: ccl_include_exam 
Objects Dropped: None 
Description:  This program provides example code showing how to
include the ccl_include.inc file within a program. 
The .inc is used for the screenwriter part of the
program. The line %M ccl_include.inc within the progam is inserted 
at the point where the program should execute this piece of the code.
In this example the .inc is used for the screenwriter portion. 
Will need to load the ccl_include.inc from libary as well.
**************************************************************************/ 

DROP PROGRAM CCL_INCLUDE_EXAM GO
CREATE PROGRAM CCL_INCLUDE_EXAM

PAINT

SET OUTP = "MINE"
SET NAME = FILLSTRING(40," ")
SET PGM_TITLE = "EXAMPLE INCLUDE PROGRAM" 

%M CCL_INCLUDE.INC

#ACCEPT_DATA2
CALL TEXT(12,10,"ENTER LAST NAME:")
CALL ACCEPT(12,32,"P(40);CU","*")
SET NAME = CURACCEPT
GO TO CORRECT_YN

#RUN_PGM
SELECT INTO VALUE(OUTP)
        P.*
FROM    PERSON P
WHERE   P.NAME_LAST_KEY = PATSTRING(NAME)
WITH MAXREC = 100

END
GO

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Example of .INC file to be used within CCL_INCLUDE_EXAM.PRG
   
   Description
   This .inc program provides example code showing how to create a include file in which to use within another program ccl_include.prg. Expecially useful for consistency and uniformity purposes and can be used over and over again within other ccl programs. T

 *************************************************************************************/
 
/************************************************************************ 
Program Name: ccl_include 
Source Code File: ccl_include.inc
Author: Discern Explorer Library
Date Written: 04/01/2000 
Tables Read: None 
Tables Created: None 
Files Created: None 
Files Deleted: None 
Objects Created: None
Objects Dropped: None 
Description: This .inc program provides example code showing how to
create a include file in which to use within another program 
ccl_include_exam.prg. Expecially useful for consistency and uniformity 
reasons and can be used over and over again within other
ccl programs. This example is used for the screenwriter part of the
program. The ccl_include_exam.prg program will have a line 
%M ccl_include.inc in place within the program in order to execute 
this piece of the code. This is not a standalone program that can be 
executed from the command line. It should not be included(%I) at the
command line. 
**************************************************************************/ 

; used in ccl_include.prg

#DRAW_BOX_begin_include
CALL BOX(2,4,22,76)
CALL LINE(6,4,73,XHOR)

#ACCEPT_DATA1
CALL TEXT(4,25,PGM_TITLE)
CALL TEXT(10,10,"ENTER OUTPUT DEVICE:")
CALL ACCEPT(10,32,"PPPP;CU",OUTP)
SET OUTP = CURACCEPT

GO TO ACCEPT_DATA2

#CORRECT_YN
CALL CLEAR(24,2)
CALL TEXT(24,1,"CORRECT? Y/N ")
CALL ACCEPT(24,15,"P;CU","Y" WHERE CURACCEPT IN ("Y","N") )

IF(CURACCEPT = "N") 	GO TO ACCEPT_DATA1
ELSE			GO TO RUN_PGM
ENDIF
 

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Create a test file to execute a Discern Explorer program from a Discern Expert rule.
   
   Description
   This program can be called from a Discern Expert rule using the EKS_EXEC_CCL_L or EKS_EXEC_CCL_A template. The program will create a test file named 1_ccl_eks_test_file.tst. The test file can be used to see what data a Discern Expert rule makes available to a Discern Explorer program. The test file can also be used to set the variables that the rule makes available and execute the program to test a program that will be called from a rule independant of the rule. This will make developing the program easier for a Discern Explorer programmer. 

 *************************************************************************************/

/*

The following program can be used to write the variables that are passed to a
Discern Explorer program from a Discern Expert rule to a file.

The resulting file can be used as a test file to execute a Discern Explorer program
that is called from a Discern Expert rule without having to actually fire the rule.


The following information was copied from the Template Documentation for the
EKS_EXEC_CCL_L and EKS_EXEC_CCL_A templates:


	General variables available to the Discern Explorer Program
	eksevent (vc):		The name of the triggering event (i.e. CLINICAL_EVENT, ORDER_EVENT)
	eksrequest (f8):	The request number of the triggering request
	tname(vc):			The name of the current Template
	retval (i4):		The return value that must be set by the CCL program being executed.
				  			-1 = FAILED
			    			0 = FALSE
							100 = TRUE

	trigger_personid (f8):		The person_id from the triggering request structure
	trigger_encntrid (f8):		The encntr_id from the triggering request structure
	trigger_accessionid (f8):	The accession_id from the triggering request structure
	trigger_orderid (f8):		The order_id from the triggering request structure

	If the OPT_LINK parameter is filled out, the following variables are available to the CCL
	program being executed.

	link_template (i4):	The value of OPT_LINK

	The following are retrieved from the linked Logic Template's eksdata entry:

		link_accessionid (f8):	The accession_id from the linked Logic Template
		link_orderid (f8):		The order_id from the linked LogicTemplate
		link_encntrid (f8):		The encntr_id fromthe linked Logic Template
		link_personid (f8):		The person_id from the linked Logic Template
		link_taskassaycd (f8):	The task_assay_cd from the linked Logic Template
		link_clineventid (f8):	The clinical_event_id from the linked Logic Template
		link_tname (vc):		The name of the linked Logic Template
		link_misc1 (vc):		The first miscellaneous entry from the linked Logic Template



*/



Drop Program 1_ccl_eks_create_test_file go
Create Program 1_ccl_eks_create_test_file

select into "1_ccl_eks_test_file.tst"
from dummyt d
detail

	col 0 "set eksevent             = ", "'", eksevent, "'",   " go" row +1
	col 0 "set eksresquest          = ", eksrequest,          " go" row +1
	col 0 "set tname                = ", "'", tname,  "'",     " go" row +1
	col 0 "set retval               = ", retval,		       " go" row +2

	col 0 "set trigger_personid     = ", trigger_personid,     " go" row +1
	col 0 "set trigger_encntrid     = ", trigger_encntrid,     " go" row +1
	col 0 "set trigger_accessionid  = ", trigger_accessionid,  " go" row +1
	col 0 "set trigger_orderid      = ", trigger_orderid,      " go" row +2

 if(validate(link_template,0) != 0) ;if eks_exec_ccl_ is linked
	col 0 "set link_template        = ", link_template ,       " go" row +1

	col 0 "set link_accessionid     = ", link_accessionid,     " go" row +1
	col 0 "set link_orderid         = ", link_orderid,         " go" row +1
	col 0 "set link_encntrid        = ", link_encntrid,        " go" row +1
	col 0 "set link_personid        = ", link_personid,        " go" row +1
	col 0 "set link_taskassaycd     = ", link_taskassaycd,     " go" row +1
	col 0 "set link_clineventid     = ", link_clineventid,     " go" row +1
	col 0 "set link_tname           = ", "'", link_tname, "'", " go" row +2
 endif

 	col 0 "declare log_accessionid = f8 go" row +1
	col 0 "declare log_orderid     = f8 go" row +1
	col 0 "declare log_encntrid    = f8 go" row +1
	col 0 "declare log_personid    = f8 go" row +1
	col 0 "declare log_taskassaycd = f8 go" row +1
	col 0 "declare log_clineventid = f8 go" row +1
	col 0 "declare log_message     = vc go" row +1
	col 0 "declare log_misc1       = vc go" row +1

	col 0 ";Execute your program here" row +1
	col 0 ";Execute program_name go" row +2


;use call echos for validation and troubleshooting
    col 0 "call echo(retval)          go" row +1

if(validate(link_template,0) = 0)
    col 0 "call echo(build('log_personid=',    log_personid))    go" row +1
	col 0 "call echo(build('log_encntrid=',    log_encntrid))    go" row +1
	col 0 "call echo(build('log_accessionid=', log_accessionid)) go" row +1
	col 0 "call echo(build('log_orderid=',     log_orderid))     go" row +1

else
    col 0 "call echo(build('log_personid=',    log_personid))    go" row +1
	col 0 "call echo(build('log_encntrid=',    log_encntrid))    go" row +1
	col 0 "call echo(build('log_accessionid=', log_accessionid)) go" row +1
	col 0 "call echo(build('log_orderid=',     log_orderid))     go" row +1
	col 0 "call echo(build('log_taskassaycd=', log_taskassaycd)) go" row +1
	col 0 "call echo(build('log_clineventid=', log_clineventid)) go" row +1
	col 0 "call echo(build('log_message=',     log_message))       go" row +1
	col 0 "call echo(build('log_misc1=',       log_misc1))       go" row +1
endif

with format, separator = " ", format = variable

end go

########################################################################################################################################################

/*************************************************************************************
 * Purpose 
   Write record structure contents to .csv formatted file

   Description
   Example program that writes information to a record structure, then reads the record structure and writes the contents out to a file in .csv format

 *************************************************************************************/

drop program 1_ccl_record_struc_to_csv go
create program 1_ccl_record_struc_to_csv

record person (
1 list[*]
2 person_id = f8
2 person_name = c20 )

declare cnt = i4

select into "nl:"
p.person_id,
p.name_full_formatted

from
person p

head report
cnt = 0
detail
cnt = cnt +1
if(mod(cnt,10) = 1)
stat = alterlist(person->list, cnt +9)
endif
person->list[cnt].person_id = p.person_id
person->list[cnt].person_name = substring(1,20,p.name_full_formatted)
foot report
stat = alterlist( person->list, cnt)
with maxrec = 100


select into ccl_record_to_csv
id = person->list[d.seq].person_id,
name = person->list[d.seq].person_name
from (dummyt d with seq = value(cnt))
with format, format = pcformat
end
go

1_ccl_record_struc_to_csv go

########################################################################################################################################################

/*************************************************************************************
 *
 *************************************************************************************/

drop program pha_nonform_daily_mail_ops go
create program pha_nonform_daily_mail_ops
/***********************************************************************
Date written:        06-26-2006
Author:              Pamela Mackey
Source File Name:    PHA_NONFORM_DAILY_MAIL_OPS
Report Name:         Daily Non-Formulary Report - Mail version
Program Purpose:     Mail version of PHA_NONFORM_DAILY_MAIL_OPS
					 To provide a daily list of non-formulary,
                     investigational, and TNF dispensed with quantities
                     for patients to be reviewed by our pharmacies.
                     Designed to be run from ops.
Requester:           Perry Flowers
************************************************************************
                   	MODIFICATIONS
Mod#	Date		Analyst		Details
001		06-26-2006 	pamackey	New report
002		07-##-2006	baharms		Added new column(s) and recipient(s).
003		08-02-2006	choji		1.	Re-added prompt11 (10th recipient) as
									it was previously not visible in the code
									(an IDE glitch probably).
								2.  Declared/initialized "CCDM" & "CSYSTEM"
									code value variables for consistency.
								3.  Reordered prompts and their references
									to put FACILITY first.
004      09-04-2006 Bharms      1.  Add CDM Number
								2.  Add FIN #
005      12-01-2006 BHarms		Changed for Fort Bend Facility Name Change
************************************************************************/
prompt
	"Choose the desired facility" = ""   ;* Choose facility or ALL for all facilities
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
	, "Enter email address:" = ""
 
with prompt1, prompt2, prompt3, prompt4, prompt5, prompt6, prompt7, prompt8, prompt9,
	prompt10, prompt11
 
 
IF (  NOT ( VALIDATE ( REPLY ,  0 ) ) )
RECORD  REPLY  (
 1  TEXT  =  VC
 1  STATUS_DATA
 2  STATUS  =  C1
 2  SUBEVENTSTATUS [ 1 ]
 3  OPERATIONNAME  =  C15
 3  OPERATIONSTATUS  =  C1
 3  TARGETOBJECTNAME  =  C15
 3  TARGETOBJECTVALUE  =  C100 )
ENDIF
 
set reply->status_data->status = "F"
 
 
;Request HNAM sign-on when executed from CCL on host
IF (VALIDATE(IsOdbc, 0) = 0)  EXECUTE CCLSECLOGIN  ENDIF
 
set investigational_cd = 0.0
set nonformulary_cd = 0.0
set tnf_cd = 0.0
set cinpatient_cd = 0.0
set page_break = 0
set CCDM = 0.0	;mod003
set CSYSTEM = 0.0	;mod003
 
set stat = uar_get_meaning_by_codeset(4512,"INVESTIGAT",1,investigational_cd)
set stat = uar_get_meaning_by_codeset(4512,"NONFORMULARY",1,nonformulary_cd)
set stat = uar_get_meaning_by_codeset(4512,"TNF",1,tnf_cd)
set stat = uar_get_meaning_by_codeset(4500,"INPATIENT",1,cinpatient_cd)
set stat = uar_get_meaning_by_codeset(11000,"CDM",1,CCDM)
SET  STAT  =  UAR_GET_MEANING_BY_CODESET ( 4062 ,  "SYSTEM" ,  1 ,  CSYSTEM )
 
SET facility = fillstring(60," ")
SET facility_loc = fillstring(100," ")
SET facility_var = $1	;mod003
declare START_DATE = f8 with NoConstant(0.0),Protect
declare END_DATE   = f8 with NoConstant(0.0),Protect
 
%i cust_script:c4_facility_logic.inc
 
 
;Date calculation
set END_DATE   = cnvtdatetime(curdate - 1, 235959)
set WEEK_DAY   = weekday(curdate)
 
if(WEEK_DAY = 1)
   ;--- then start_date should be Friday, so past three days
    set START_DATE = cnvtdatetime(curdate - 3, 000000)
else
   ;--- then start_date should be for previous day
   set START_DATE = cnvtdatetime(curdate - 1, 000000)
endif
 
;-----------------------
 
call echo(build("START_DATE == ", format(START_DATE, "DD-MMM-YY HH:MM;;Q")))
call echo(build("END_DATE == ", format(END_DATE, "DD-MMM-YY HH:MM;;Q")))
call echo(build("DAY OF WEEK =", WEEK_DAY))
 
if(cnvtdate(START_DATE) = cnvtdate(END_DATE))
   set date_range_str = concat(format(START_DATE, "MM/DD/YYYY;;Q"))
else
   set date_range_str = concat(format(START_DATE, "MM/DD/YYYY;;Q"), " - ", format(END_DATE, "MM/DD/YYYY;;Q"))
endif
 
;setup for emailing files
;the report output and message files will be put in $CCLUSERDIR by default
set file_date=FORMAT(curdate, ";;D")
set date_string = replace(file_date,"/","_",0) ;replace all "/" in string date
 
;set output_file = concat($2,"-NF-",date_string,".csv") ;make output file name
;set output_file = replace(output_file," ","",0) ;remove spaces from output file name
SET OUTPUT_FILE  = (CONCAT((TRIM($1,3)),"_NF_RPT_",date_string,".CSV")) ;mod003
SET MESSAGE_FILE = (CONCAT((TRIM($1,3)),"_NF_RPT_",date_string,".MSG")) ;mod003
set subject_line = concat("Daily Nonformulary Report-",$1) ;subject line for email ;mod003
 
set email1 = concat($2,"@memorialhermann.org")	;mod003
set email2 = concat($3,"@memorialhermann.org")
set email3 = concat($4,"@memorialhermann.org")
set email4 = concat($5,"@memorialhermann.org")
set email5 = concat($6,"@memorialhermann.org")
set email6 = concat($7,"@memorialhermann.org")
set email7 = concat($8,"@memorialhermann.org")
set email8 = concat($9,"@memorialhermann.org")
set email9 = concat($10,"@memorialhermann.org")
set email10= concat($11,"@memorialhermann.org")
 
 
SET MaxSecs = 0
IF (VALIDATE(IsOdbc, 0) = 1)  SET MaxSecs = 15  ENDIF
 
 
SELECT DISTINCT INTO value(output_file)
	LOCATION = UAR_GET_CODE_DISPLAY( E.LOC_FACILITY_CD ),
	FORMULARY_STATUS = UAR_GET_CODE_DISPLAY( MD.FORMULARY_STATUS_CD ),
	PATIENT_NAME = PE.NAME_FULL_FORMATTED,
	MED_INFO = O.DEPT_MISC_LINE,
	O.CURRENT_START_DT_TM "@SHORTDATETIME",
	ORDER_STATUS = UAR_GET_CODE_DISPLAY( O.DEPT_STATUS_CD ),
	O.PROJECTED_STOP_DT_TM "@SHORTDATETIME",
	DISP_EVENT_TYPE = UAR_GET_CODE_DISPLAY( D.DISP_EVENT_TYPE_CD ),
	D.DISPENSE_DT_TM "@SHORTDATETIME",
	P.CHARGE_QTY,
	P.CREDIT_QTY,
	MD_NAME = PR.NAME_FULL_FORMATTED,
	RPH_NAME = PR2.name_full_formatted
 
 
FROM
	DISPENSE_HX  D,
	PROD_DISPENSE_HX  P,
	ORDERS  O,
    MED_DISPENSE MD,
	ENCOUNTER  E,
	PERSON  PE,
	ORDER_ACTION  OA,
	PRSNL  PR,
	PRSNL  PR2
 
PLAN D
  WHERE  D.DISPENSE_DT_TM between cnvtdatetime(START_DATE) and cnvtdatetime(END_DATE)
;  where d.dispense_dt_tm between cnvtdatetime("15-APR-2006 00:00:00:00")
; and cnvtdatetime("21-JUN-2006 23:59:59:59")
 
JOIN P
WHERE  D.DISPENSE_HX_ID =   P.DISPENSE_HX_ID
 
JOIN O
WHERE D.ORDER_ID = O.ORDER_ID
 
JOIN PE
WHERE  O.PERSON_ID = PE.PERSON_ID
 
JOIN MD
WHERE P.ITEM_ID = MD.ITEM_ID
AND MD.pharmacy_type_cd = cinpatient_cd
AND md.med_package_type_id = 0
and md.parent_entity_id = 0
AND  (MD.FORMULARY_STATUS_CD =  investigational_cd
OR    MD.FORMULARY_STATUS_CD =  nonformulary_cd
OR    MD.FORMULARY_STATUS_CD =  tnf_cd)
 
JOIN E
	WHERE  O.ENCNTR_ID =  E.ENCNTR_ID
	AND  PARSER(facility_loc)
 
JOIN OA
WHERE O.ORDER_ID = OA.ORDER_ID
 
JOIN PR
    WHERE OA.ORDER_PROVIDER_ID = PR.PERSON_ID
    AND PR.PHYSICIAN_IND+0=1
 
JOIN PR2
	WHERE OA.ACTION_PERSONNEL_ID = PR2.PERSON_ID
	AND PR2.ACTIVE_IND+0=1
 
ORDER BY
	E.LOC_FACILITY_CD,
	MD.FORMULARY_STATUS_CD,
	O.DEPT_MISC_LINE,
	0
 
with format, format=pcformat
 
 
;uuencode the output so that it can be sent as an email attachment
set dclcom1 = concat('mcr tcpip$uuencode ',output_file,' ', message_file)
set dcllen1 = textlen(dclcom1)
set dclstatus = 0
call dcl( dclcom1, dcllen1, dclstatus )
 
;mail them
if (trim($2) != "")	;mod003
	execute email email1," ",subject_line, message_file
endif
if (trim($3) != "")
	execute email email2," ",subject_line, message_file
endif
if (trim($4) != "")
	execute email email3," ",subject_line, message_file
endif
if (trim($5) != "")
	execute email email4," ",subject_line, message_file
endif
if (trim($6) != "")
	execute email email5," ",subject_line, message_file
endif
if (trim($7) != "")
	execute email email6," ",subject_line, message_file
endif
if (trim($8) != "")
	execute email email7," ",subject_line, message_file
endif
if (trim($9) != "")
	execute email email8," ",subject_line, message_file
endif
if (trim($10) != "")
	execute email email9," ",subject_line, message_file
endif
 
if (trim($11) != "")
	execute email email10," ",subject_line, message_file
endif
 
 
set reply->status_data->status = "S"
 
end
go

########################################################################################################################################################

/*************************************************************************************
 *CCL that queries the Immunization Profile and also pulls in Hx from an Aurora Form.
 *************************************************************************************/

/****************************************************************************
Begin CCL Comments
 
                        Aurora Health Care
 
*****************************************************************************
                Source Code: CUST_SCRIPT:AURO_DCP_GET_GENVIEW_qmimmune.PRG
                 Written By: Sharon Matyas
                       Date: 09/07/2005
                    Purpose: To display a patient's immunization information – checks for
		         Pneumo, flu and tetanus on the immunization tab
		        or the encounter specific form – Admission History
*****************************************************************************
 MOD#   INITIALS    DATE     DESCRIPTION
------  --------  --------   ------------------------------------------------
 
****************************************************************************/
DROP PROGRAM AURO_DCP_GET_GENVIEW_qmimmune : DBA  GO
CREATE PROGRAM AURO_DCP_GET_GENVIEW_qmimmune : DBA
 
SET CNT = 0
 
set immune_flag = "N"
 
declare i_name = c20
 
declare i_date = c20
declare i_prov = c20
 
;Declare global variables to be used in the last select to display the record
;fields correctly in the REPLY record structure
DECLARE RES_DISPLAY = c50
DECLARE RES_DETAIL  = c20
DECLARE SEQ_FLAG = I2
DECLARE CATEGORY = c20
DECLARE RES_PROV = c30
declare sub_seq_flag = i2
 
if (not validate(temp_req,0))
RECORD TEMP_REQ(
        1 QUAL[*]
          2 Category	= c20
          2 RES_DISPLAY = c50
          2 RES_DETAIL  = c20
          2 RES_PROV	= c30
          2 seq_flag	= i2
          2 sub_seq_flag	= i2)
endif
 
;******** check for existence of immunizations  *****
 
 
Select ;INTO MINE
	into "nl:"
		ce.event_id,
		ce.event_cd
		;result_date = format(cem.admin_start_dt_tm,"mm/dd/yyyy hh:mm;;d"),
 
 
FROM (ENCOUNTER E),
	( clinical_event ce )
 
 
PLAN	( E WHERE (E.ENCNTR_ID= REQUEST -> VISIT [ 1 ]-> ENCNTR_ID ))
	;51878039) ;CERT, CLINMAXWELL
	;38120072)
	;38264184) ;BLUE, CLINDOCEIGHT
	;38116286) ;CERT, WAMHCPITWO
	;113831965))  ;cert,frankone
	;113840662))   ;cert,princess
 
join	(ce where (e.person_id = ce.person_id)
	and (ce.event_cd in (56349,15769080,56911,15272391,15272397,
			103449,98000266,98002828,98000265,52648691))   ;tetanus
	and (ce.event_end_dt_tm <= cnvtdatetime(curdate,curtime3) )
	and (ce.valid_until_dt_tm > cnvtdatetime(curdate,curtime3)))
 
 
 
detail
 
	if (ce.event_cd in (56349,15769080,56911,103449,98000266,98002828,98000265))
	immune_flag = "Y"
	i_name = "Immunization"
	i_date	= "Date"
	i_prov = "Ordered by"
	elseif(ce.event_cd in (15272391,15272397,52648691)and ce.encntr_id = e.encntr_id ) ;form
	immune_flag = "Y"
	i_name = "Immunization"
	i_date	= "Date"
	i_prov = "Ordered by"
 
endif
 
with maxrec = 10
 
if (immune_flag = "Y")
select; into mine
	into "nl:"
from dummyt
 
 
 
HEAD REPORT
        STAT = ALTERLIST(TEMP_REQ->QUAL,50)
 
 
 
detail
		CNT = CNT + 1
 
        IF(MOD(CNT,50) = 1 AND CNT != 1)
          STAT = ALTERLIST(TEMP_REQ->QUAL,CNT+50) ;bgr +10)
        ENDIF
 
 
	TEMP_REQ->QUAL[CNT].CATEGORY		= TRIM("Immunization: ")
	TEMP_REQ->QUAL[CNT].SEQ_FLAG		= 1
	;TEMP_REQ->QUAL[CNT].SUB_SEQ_FLAG	= 2
	TEMP_REQ->QUAL[CNT].res_display		= i_name
	TEMP_REQ->QUAL[CNT].res_detail		= i_date
	TEMP_REQ->QUAL[CNT].res_prov		= i_prov
 
 
FOOT REPORT
 
	stat = alterlist(temp_req->QUAL,cnt)
 
/*
        X = 0
 
 
        FOR(X = 1 TO CNT)
   ; if (TEMP_REQ->QUAL[X].category > " ")
        COL 0   TEMP_REQ->QUAL[X].category
	COL 20  TEMP_REQ->QUAL[X].seq_flag
	COL 40  TEMP_REQ->QUAL[X].sub_seq_flag
	COL 60 TEMP_REQ->QUAL[X].res_display
	col 100 TEMP_REQ->QUAL[X].res_date"mm/dd/yyyy hh:mm;;d"
	col 120 TEMP_REQ->QUAL[X].res_detail
 
 
 
	ROW+1
	;else
	;row + 0
	;endif
 
	ENDFOR
 
WITH 	MAXCOL = 5000
*/
elseif(immune_flag = "N")
select ;into mine
	into "nl:"
from dummyt
 
HEAD REPORT
        STAT = ALTERLIST(TEMP_REQ->QUAL,50)
 
 
 
detail
		CNT = CNT + 1
 
        IF(MOD(CNT,50) = 1 AND CNT != 1)
          STAT = ALTERLIST(TEMP_REQ->QUAL,CNT+50) ;bgr +10)
        ENDIF
 
	TEMP_REQ->QUAL[CNT].CATEGORY		= TRIM("Immunization: ")
	TEMP_REQ->QUAL[CNT].SEQ_FLAG		= 1
	;TEMP_REQ->QUAL[CNT].SUB_SEQ_FLAG	= 2
	TEMP_REQ->QUAL[CNT].res_display		= trim("No Relevant Immunizations recorded")
	;TEMP_REQ->QUAL[CNT].res_detail		= trim("No Assessment Documented")
 
FOOT REPORT
 
	stat = alterlist(temp_req->QUAL,cnt)
 
/*
        X = 0
 
 
        FOR(X = 1 TO CNT)
   ; if (TEMP_REQ->QUAL[X].category > " ")
        COL 0   TEMP_REQ->QUAL[X].category
	COL 20  TEMP_REQ->QUAL[X].seq_flag
	COL 40  TEMP_REQ->QUAL[X].sub_seq_flag
	COL 60 TEMP_REQ->QUAL[X].res_display
	col 100 TEMP_REQ->QUAL[X].res_date"mm/dd/yyyy hh:mm;;d"
	col 120 TEMP_REQ->QUAL[X].res_detail
 
 
 
	ROW+1
	;else
	;row + 0
	;endif
 
	ENDFOR
 
WITH 	MAXCOL = 5000
*/
endif
 
 
SELECT
	INTO "NL:"
	;INTO MINE
	ce.event_id,
	ce.event_cd,
	ce.event_end_dt_tm,
	immune_date = format(cem.admin_start_dt_tm,"mm/dd/yyyy;;d"),
	event_display = uar_get_code_display(ce.event_cd),
	provider = substring(1,30,pr.name_full_formatted)
 
FROM (ENCOUNTER E),
	( clinical_event ce ),
	(ce_med_result cem),
	(prsnl pr)
 
PLAN	( E WHERE (E.ENCNTR_ID = REQUEST -> VISIT [ 1 ]-> ENCNTR_ID ))
	;51878039) ;CERT, CLINMAXWELL
	;38120072)
	;38264184) ;BLUE, CLINDOCEIGHT
	;38116286) ;CERT, WAMHCPITWO
	;113831965))  ;cert,frankone
	;113840662))
 
join	(ce where (e.person_id = ce.person_id)
	and (ce.event_cd in (56349,15769080,56911,15272391,15272397,
			103449,98000266,98002828,98000265,52648691))  ;tetanus
	and (ce.event_end_dt_tm <= cnvtdatetime(curdate,curtime3) )
	and (ce.valid_until_dt_tm > cnvtdatetime(curdate,curtime3)))
 
join	(cem where (outerjoin(ce.event_id) = cem.event_id))
 
join	(pr where (outerjoin (cem.admin_prov_id) = pr.person_id))
 
 
ORDER	ce.person_id,
		ce.event_cd,
		cnvtdatetime(ce.event_end_dt_tm) desc
 
HEAD REPORT
        STAT = ALTERLIST(TEMP_REQ->QUAL,CNT+10)
 
head ce.person_id
	row + 0
 
head ce.event_cd
 
;DETAIL
        CNT = CNT + 1
        IF(MOD(CNT,10) = 1 AND CNT != 1)
          STAT = ALTERLIST(TEMP_REQ->QUAL,CNT+10)
        ENDIF
	if (ce.event_cd = 56349)
        TEMP_REQ->QUAL[CNT].CATEGORY = "Influenza"
        TEMP_REQ->QUAL[CNT].RES_DISPLAY = event_display
        TEMP_REQ->QUAL[CNT].RES_Detail	= immune_date
        TEMP_REQ->QUAL[CNT].SEQ_FLAG = 2
        TEMP_REQ->QUAL[CNT].sub_SEQ_FLAG = 1
        TEMP_REQ->QUAL[CNT].RES_PROV = provider
    elseif(ce.event_cd = 15272391)
    	if(ce.encntr_id = e.encntr_id)			;from the form 
    	TEMP_REQ->QUAL[CNT].CATEGORY = "Influenza"
        TEMP_REQ->QUAL[CNT].RES_DISPLAY = "Influenza Vaccine by Hx: "
        TEMP_REQ->QUAL[CNT].RES_Detail	= ce.result_val
        TEMP_REQ->QUAL[CNT].sub_SEQ_FLAG = 2
        TEMP_REQ->QUAL[CNT].SEQ_FLAG = 2
        endif
    elseif(ce.event_cd in (15769080,56911))
    	TEMP_REQ->QUAL[CNT].CATEGORY = "Pneumococcal"
        TEMP_REQ->QUAL[CNT].RES_DISPLAY = event_display
        TEMP_REQ->QUAL[CNT].RES_Detail	= immune_date
        TEMP_REQ->QUAL[CNT].SEQ_FLAG = 3
        TEMP_REQ->QUAL[CNT].sub_SEQ_FLAG = 1
        TEMP_REQ->QUAL[CNT].RES_PROV = provider
    elseif(ce.event_cd = 15272397)
    	if(ce.encntr_id = e.encntr_id)			;from the form
    	TEMP_REQ->QUAL[CNT].CATEGORY = "Pneumococcal"
        TEMP_REQ->QUAL[CNT].RES_DISPLAY = "Pneumococcal Vaccine by Hx: "
        TEMP_REQ->QUAL[CNT].RES_Detail	= ce.result_val
        TEMP_REQ->QUAL[CNT].SEQ_FLAG = 3
        TEMP_REQ->QUAL[CNT].sub_SEQ_FLAG = 2
        endif
     elseif(ce.event_cd in (103449,98000266,98002828,98000265))
    	TEMP_REQ->QUAL[CNT].CATEGORY = "Tetanus"
        TEMP_REQ->QUAL[CNT].RES_DISPLAY = event_display
        TEMP_REQ->QUAL[CNT].RES_Detail	= immune_date
        TEMP_REQ->QUAL[CNT].SEQ_FLAG = 4
        TEMP_REQ->QUAL[CNT].sub_SEQ_FLAG = 1
        TEMP_REQ->QUAL[CNT].RES_PROV = provider
    elseif(ce.event_cd = 52648691)
    	if(ce.encntr_id = e.encntr_id)			;from the form
    	TEMP_REQ->QUAL[CNT].CATEGORY = "Tetanus"
        TEMP_REQ->QUAL[CNT].RES_DISPLAY = "Tetanus Vaccine by Hx: "
        TEMP_REQ->QUAL[CNT].RES_Detail	= ce.result_val
        TEMP_REQ->QUAL[CNT].SEQ_FLAG = 4
        TEMP_REQ->QUAL[CNT].sub_SEQ_FLAG = 2
        endif
	endif
 
 
 
FOOT REPORT
        STAT = ALTERLIST(TEMP_REQ->QUAL,CNT)
/*
        X= 0
 
        FOR(X = 1 TO CNT)
        col 0 TEMP_REQ->QUAL[x].CATEGORY
        COL 30  TEMP_REQ->QUAL[x].RES_DISPLAY
        COL 60 TEMP_REQ->QUAL[X].RES_DETAIL
        col 90  TEMP_REQ->QUAL[x].SEQ_FLAG
       ; col 90 temp_req->qual[x].res_sev
        ROW+1
        ENDFOR
 
WITH 	MAXCOL = 600
*/
 
SET  RHEAD  =
 ;"{\rtf1\ansi \deff0{\fonttbl{\f0\fswiss Arial;}}{\colortbl;\red0\green0\blue0;\red255\green255\blue255;}\deftab1134"
 "{\rtf1\ansi \deff0{\fonttbl{\f0\fswiss Arial Narrow;}}{\colortbl;\red0\green0\blue0;\red255\green255\blue255;}\deftab1134"
 
SET  RH2R  =  "\plain \f0 \fs20 \cb2 \pard\sl0 "
 
SET  RH2B  =  "\plain \f0 \fs20 \b \cb2 \pard\sl0 "
 
SET  RH2BU  =  "\plain \f0 \fs20 \b \ul \cb2 \pard\sl0 "
 
SET  RH2U  =  "\plain \f0 \fs20 \u \cb2 \pard\sl0 "
 
SET  RH2I  =  "\plain \f0 \fs20 \i \cb2 \pard\sl0 "
 
SET  REOL  =  "\par"
 
SET  RTAB  =  "\tab"
 
SET  WR  =  " \plain \f0 \fs18 \cb2 "
 
SET  WB  =  " \plain \f0 \fs18 \b \cb2 "
 
SET  WU  =  " \plain \f0 \fs18 \ul \cb2 "
 
SET  WI  =  " \plain \f0 \fs18 \i \cb2 "
 
SET  WBI  =  " \plain \f0 \fs18 \b \i \cb2 "
 
SET  WIU  =  " \plain \f0 \fs18 \i \ul \cb2 "
 
SET  WBIU  =  " \plain \f0 \fs18 \b \ul \i \cb2 "
 
SET  RTFEOF  =  "}"
 
SET  REPLY -> TEXT  =  RHEAD
 
 
SELECT  INTO  "nl:"
 
	;Variables for sort of report, not for displaying record fields
        ;If use these variables for displaying data, the first seq defines
        ;the lengths for all the seqs - cuts off some data
 
        RES_DISP   = TEMP_REQ->QUAL[D1.SEQ].RES_DISPLAY,
        RES_DET    = TEMP_REQ->QUAL[D1.SEQ].RES_DETAIL,
        CAT 		= TEMP_REQ->QUAL[D1.SEQ].CATEGORY,
        SEQ_FLG		= TEMP_REQ->QUAL[D1.SEQ].SEQ_FLAG,
        sub_seq_flg = TEMP_REQ->QUAL[D1.SEQ].sub_SEQ_FLAG,
        RES_PR		= TEMP_REQ->QUAL[D1.SEQ].RES_PROV,
        D1.SEQ
 
FROM    (DUMMYT D1 WITH SEQ = VALUE(CNT))
 
PLAN    D1
 
ORDER BY SEQ_FLG,
	CAT,
	sub_seq_flg,
	RES_DISP,
	 RES_DET,
	 RES_PR
 
HEAD REPORT
 	REPLY -> TEXT = CONCAT ( RHEAD ,  RH2BU ),
 	REPLY -> TEXT = CONCAT ( REPLY -> TEXT ,  "Immunizations Given or By Hx",reol)
;Populate the global variables for displaying record fields
 
 
HEAD SEQ_FLG
	SEQ_FLAG = TEMP_REQ->QUAL[D1.SEQ].SEQ_FLAG
 
 
HEAD CAT
	CATEGORY = TEMP_REQ->QUAL[D1.SEQ].CATEGORY
	RES_DISPLAY	= TRIM(TEMP_REQ->QUAL[D1.SEQ].RES_DISPLAY)
	;res_detail = trim(TEMP_REQ->QUAL[D1.SEQ].RES_DETAIL)
	if(res_display > "  ")
	if(seq_flag in (2,4,3,5))
	REPLY -> TEXT = CONCAT (reply -> text, reol),
	REPLY -> TEXT = CONCAT (reply ->text,wb,trim(category),reol)
	endif
	endif
 
head sub_seq_flg
	sub_seq_flag = TEMP_REQ->QUAL[D1.SEQ].sub_SEQ_FLAG
 
HEAD RES_DISP
	RES_DISPLAY	= TRIM(TEMP_REQ->QUAL[D1.SEQ].RES_DISPLAY)
	SEQ_FLAG = TEMP_REQ->QUAL[D1.SEQ].SEQ_FLAG
 
	IF(SEQ_FLAG in (2,4,5,3))  ;= 1)
	;REPLY -> TEXT = CONCAT ( RHEAD ,  RH2BU ),
	;REPLY->TEXT = CONCAT(REPLY->TEXT,RH2BU,res_DISPLAY)
	;ELSE
 
	REPLY->TEXT = CONCAT(REPLY->TEXT,wr,res_display)
	elseif(seq_flag = 1)
	  if ( res_display = "No*")
	REPLY->TEXT = CONCAT(REPLY->TEXT,wr,res_display)
	  else
	  REPLY->TEXT = CONCAT(REPLY->TEXT,wb,res_display)
	  endif
	ENDIF
 
head res_det
	res_detail = trim(TEMP_REQ->QUAL[D1.SEQ].RES_DETAIL)
	SEQ_FLAG = TEMP_REQ->QUAL[D1.SEQ].SEQ_FLAG
 
	IF(SEQ_FLAG = 1) ;in (2,4,5,3))   ;= 1)
	REPLY->TEXT = CONCAT(REPLY->TEXT,rtab),
	REPLY->TEXT = CONCAT(REPLY->TEXT,rtab),
	REPLY->TEXT = CONCAT(REPLY->TEXT,wb,res_DETAIL)
	ELSE
	REPLY->TEXT = CONCAT(REPLY->TEXT,rtab),
	REPLY->TEXT = CONCAT(REPLY->TEXT,wr,res_detail)
	ENDIF
 
head res_pr
	res_prov = trim(TEMP_REQ->QUAL[D1.SEQ].RES_prov)
	SEQ_FLAG = TEMP_REQ->QUAL[D1.SEQ].SEQ_FLAG
 
	IF(SEQ_FLAG  = 1 )  ;in (2,4,5,3))   ;= 1)
	REPLY->TEXT = CONCAT(REPLY->TEXT,rtab),
	REPLY->TEXT = CONCAT(REPLY->TEXT,wb,res_prov,reol)
	ELSE
	REPLY->TEXT = CONCAT(REPLY->TEXT,rtab),
	REPLY->TEXT = CONCAT(REPLY->TEXT,wr,res_prov,reol)
	ENDIF
 
foot res_pr
	row + 0
 
foot res_det
	row + 0
 
foot res_disp
	row + 0
 
FOOT CAT
	ROW + 0
 
FOOT SEQ_FLG
	ROW + 0
 
 
 
WITH  NOCOUNTER, NULLREPORT
 
SET  REPLY -> STATUS_DATA -> STATUS  =  "S"
 
SET  REPLY -> TEXT  =  CONCAT ( REPLY -> TEXT ,  RTFEOF )
call echo(build("reply:::",reply->text))
 
 
 
END
 
GO

########################################################################################################################################################

/*
Find auto-print jobs. It looks for PM Documents, Ops Jobs, Scheduling reports, Orders requisitions, patient charts, SurgiNet reports, Radiology requisitions.
*/
  drop program chldmn_find_print_jobs:dba go
create program chldmn_find_print_jobs:dba
 
 
/***********************************************************************
 *                  GENERATED MODIFICATION CONTROL LOG                 *
 ***********************************************************************
 *                                                                     *
 *Mod Date     Engineer             Comment                            *
 *--- -------- -------------------- -----------------------------------*
 *000 01/12/04 Keith Frey           Initial Release                    *
 *001 04/16/04 Keith Frey	    Add search for output_dest_cd into
				    ops jobs
 *002 03/22/06 Keith Frey	    Add SurgiNet jobs
 *003 04/26/06 Keith Frey	    Add Radiology Requistions
 ***********************************************************************/
 
 
 
PROMPT  "Print to " = "MINE",
	"Find Queue Name " = ""
 
 
set io = cnvtupper(trim($1, 3))
set que_name = cnvtupper(trim($2, 3))
set que_fuzzy = concat("*", cnvtupper(trim($2, 3)), "*")
 
set isodbc = 0
 
;Request HNAM sign-on when executed from CCL on host
IF (VALIDATE(IsOdbc, 0) = 0)  EXECUTE CCLSECLOGIN  ENDIF
  
set line = fillstring(185, "=")
 
set printer_cd = 0
set printer_cd = uar_get_code_by("MEANING", 3000, "PRINTER")
 
free set t_printer
record t_printer (
   1 que = vc
   1 output_dest_cd = c8		;001
   1 pm_route_cnt = i4
   1 pm_route [*]
       2 doc_desc = c30
       2 distr_name = c50
       2 name = c50
       2 copies = i4
   1 ops_job_cnt =i4
   1 ops_job [*]
       2 hst = c6
       2 cntrl_grp = c25
       2 ot_task_id = f8
       2 job_time = c5
       2 job_grp = c40
       2 ot_parent_id = f8
       2 ot_parent_name = c40
       2 output_dist = c20
       2 batch = c85
       2 job_name = c40
   1 sched_job_cnt = i4
   1 sched_job [*]
      2 mnem = c50
      2 mean = c15
   1 req_job_cnt = i4
   1 req_job [*]
      2 value2_disp = c30
      2 desc = c45
      2 param1_disp = c30
      2 param2_disp = c30
      2 param3_disp = c30
   1 chart_job_cnt = i4
   1 chart_job [*]
     2 desc = c50
     2 queue = c20
   1 surgi_job_cnt = i4									;002
   1 surgi_job [*]                                                                      ;002
	2 disp = c80                                                                    ;002
	2 type = c80                                                                    ;002
	2 loc = c40                                                                     ;002
	2 num_copies = i4                                                               ;002
   1 rad_req_cnt = i4									;003
   1 rad_req [*]                                                                        ;003
	2 od_name = c20                                                                 ;003
	2 od_script = c50                                                               ;003
)
 
; Begin 001
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find output_dest_cd
 
select into "nl:"
	  od.output_dest_cd
 
from	  output_dest od
	, device d
 
plan d
where  d.name                   = que_name
  and  d.device_type_cd         = printer_cd
 
join od
where  d.device_cd		= od.device_cd
 
detail
	t_printer->output_dest_cd	= trim(cnvtstring(od.output_dest_cd), 3)
 
with	  nocounter
 
; End of finding output_dest_cd
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; End 001
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find PM document routes
 
set indx = 0
select into "nl:"
 
		  pdd.document_desc
		, pmddi.distribution_name
		, d.name
		, pmdd.copies
 
from	  	  pm_doc_document pdd
		, pm_doc_destination pmdd
		, pm_doc_distribution pmddi
		, output_dest od
		, device d
 
plan  pdd
where pdd.active_ind 		= 1
  and pdd.end_effective_dt_tm 	>= cnvtdatetime(curdate, curtime)
 
join  pmdd
where  pdd.document_id 		= pmdd.document_id
  and pmdd.active_ind 		= 1
  and pmdd.end_effective_dt_tm 	>= cnvtdatetime(curdate, curtime)
 
join pmddi
where pmdd.distribution_id 	= pmddi.distribution_id
 
join    od
where pmdd.output_dest_cd 	= od.output_dest_cd
 
join   d
where od.device_cd 		= d.device_cd
  and  d.name 			= que_name
  and  d.device_type_cd 	= printer_cd
 
 
order	  pdd.document_desc
	, d.name
	, pmdd.copies desc
 
 
head report
	t_printer->pm_route_cnt = 0
 
detail
	t_printer->pm_route_cnt = t_printer->pm_route_cnt + 1
 
	if (mod(t_printer->pm_route_cnt, 10) = 1)
		stat = alterlist(t_printer->pm_route, t_printer->pm_route_cnt + 9)
	endif
 
	indx = t_printer->pm_route_cnt
 
	t_printer->pm_route[indx]->doc_desc 	= substring(1, 30, pdd.document_desc)
	t_printer->pm_route[indx]->distr_name 	= substring(1, 50, pmddi.distribution_name)
	t_printer->pm_route[indx]->name 	= substring(1, 50, d.name)
	t_printer->pm_route[indx]->copies 	= pmdd.copies
 
 
foot report
	if (mod(t_printer->pm_route_cnt, 10) != 0)
		stat = alterlist(t_printer->pm_route, t_printer->pm_route_cnt)
	endif
 
 
with nocounter
 
; End of PM document routes
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find ops jobs
 
set indx1 = 0
select into "nl:"
		  ot_job_grp = ot.job_grp_name
		, output_dist = substring(1, 20, osp.output_dist)
		, batch = substring(1, 85, osp.batch_selection)
		, job_time = format(ot.beg_effective_dt_tm, "hh:mm;;m")
		, job_name = ot.JOB_GRP_NAME
 
 
from
		  ops_schedule_param osp
		, ops_task ot
		, dummyt d1
                , ops_job oj
 
 
plan  osp
where osp.active_ind 			= 1
  and osp.end_effective_dt_tm 		>= cnvtdatetime(curdate, curtime)
  and (cnvtupper(osp.output_dist) 	= que_name
       or
       cnvtupper(osp.batch_selection) 	= patstring(que_fuzzy)
; Begin 001
       or
       osp.output_dist			= trim(t_printer->output_dest_cd, 3)
       or
       osp.batch_selection		= trim(t_printer->output_dest_cd, 3)
; End 001
      )
 
join   ot
where osp.ops_task_id 			= ot.ops_task_id
  and  ot.active_ind 			= 1
  and  ot.end_effective_dt_tm 		>= cnvtdatetime(curdate, curtime)
 
join d1
join oj
where ot.ops_job_id                     = oj.ops_job_id
  and oj.active_ind                     = 1
  and oj.end_effective_dt_tm            >= cnvtdatetime(curdate, curtime)
 
 
head report
	t_printer->ops_job_cnt = 0
 
 
detail
	t_printer->ops_job_cnt = t_printer->ops_job_cnt + 1
 
	if (mod(t_printer->ops_job_cnt, 10) = 1)
		stat = alterlist(t_printer->ops_job, t_printer->ops_job_cnt + 9)
	endif
 
	indx1 = t_printer->ops_job_cnt
 
 
        t_printer->ops_job[indx1]->output_dist  = substring(1, 20, osp.output_dist)
        t_printer->ops_job[indx1]->batch        = substring(1, 85, osp.batch_selection)
	t_printer->ops_job[indx1]->job_time	= job_time
	t_printer->ops_job[indx1]->ot_parent_id	= ot.parent_id
	t_printer->ops_job[indx1]->ot_task_id	= ot.ops_task_id
	t_printer->ops_job[indx1]->job_grp	= ""
	t_printer->ops_job[indx1]->job_name     = job_name
 
foot report
	if (mod(t_printer->ops_job_cnt, 10) != 0)
		stat = alterlist(t_printer->ops_job, t_printer->ops_job_cnt)
	endif
 
 
with	  nocounter
 
 
 
 
; Find parent of ops job (Is the job in a job_group?)
 
if (t_printer->ops_job_cnt > 0)
	for (i = 1 to t_printer->ops_job_cnt)
		if (t_printer->ops_job[i]->ot_parent_id > 0)
 
			;;; Find parent of ops job (Is the job in a job_group?)
 
			select into "nl:"
				  ot_parent_name = substring(1, 40, ot2.job_grp_name)
				, hst = substring(1, 6, ocg2.host)
		                , cntrl_grp = substring(1, 30, ocg2.name)
				, job_time = format(ot2.beg_effective_dt_tm, "hh:mm;;m")
 
			from	  ops_task		ot2
				, ops_control_group	ocg2
 
			plan ot2
			where ot2.ops_task_id		= t_printer->ops_job[i]->ot_parent_id
			  and ot2.active_ind		= 1
			  and ot2.end_effective_dt_tm	>= cnvtdatetime(curdate, curtime)
 
			join ocg2
			where  ot2.ops_control_grp_id   	 = ocg2.ops_control_grp_id
			  and ocg2.active_ind                    = 1
			  and ocg2.end_effective_dt_tm           >= cnvtdatetime(curdate, curtime)
 
			detail
				t_printer->ops_job[i]->ot_parent_name	= ot_parent_name
				t_printer->ops_job[i]->hst		= hst
				t_printer->ops_job[i]->cntrl_grp 	= cntrl_grp
				t_printer->ops_job[i]->job_time		= job_time
			with nocounter
 
		else
			select into "nl:"
                                  hst = substring(1, 6, ocg.host)
                                , cntrl_grp = substring(1, 30, ocg.name)
 
                        from      ops_task      	ot
				, ops_control_group	ocg
 
                        plan ot
                        where ot.ops_task_id           = t_printer->ops_job[i]->ot_task_id
                          and ot.active_ind            = 1
                          and ot.end_effective_dt_tm   >= cnvtdatetime(curdate, curtime)
 
                        join ocg
                        where  ot.ops_control_grp_id   		= ocg.ops_control_grp_id
                          and ocg.active_ind                    = 1
                          and ocg.end_effective_dt_tm           >= cnvtdatetime(curdate, curtime)
 
                        detail
                                t_printer->ops_job[i]->hst              = hst
                                t_printer->ops_job[i]->cntrl_grp        = cntrl_grp
                        with nocounter
		endif
	endfor
endif
 
 
; End of ops jobs
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find scheduling routes
 
select into "nl:"
	  sr.mnemonic
	, sr.route_meaning
 
from	  device d
	, output_dest od
	, sch_route_list srl
	, sch_route sr
 
plan d
where d.name 			= que_name
 and  d.device_type_cd 		= printer_cd
 
join od
where  d.device_cd 		= od.device_cd
 
join srl
where  od.output_dest_cd 	= srl.output_dest_id
 
join sr
where srl.sch_route_id 		= sr.sch_route_id
 
 
head report
	t_printer->sched_job_cnt = 0
	indx3 = 0
 
detail
	t_printer->sched_job_cnt = t_printer->sched_job_cnt + 1
 
        if (mod(t_printer->sched_job_cnt, 10) = 1)
                stat = alterlist(t_printer->sched_job, t_printer->sched_job_cnt + 9)
        endif
 
        indx3 = t_printer->sched_job_cnt
 
	t_printer->sched_job[indx3]->mnem = trim(sr.mnemonic)
	t_printer->sched_job[indx3]->mean = trim(sr.route_meaning)
 
 
foot report
	if (mod(t_printer->sched_job_cnt, 10) != 0)
                stat = alterlist(t_printer->sched_job, t_printer->sched_job_cnt)
        endif
 
 
with nocounter
 
; End of scheduling routes
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find orders requisitions
 
select into "nl:"
	  value2_disp = substring(1, 30, uar_get_code_display(dfr.value2_cd))
	, desc = substring(1, 45, dor.route_description)
	, param1_disp = substring(1, 30,uar_get_code_display(dor.param1_cd))
	, param2_disp = substring(1, 30,uar_get_code_display(dor.param2_cd))
	, param3_disp = substring(1, 30,uar_get_code_display(dor.param3_cd))
 
 
from	  dcp_flex_printer dfp
	, dcp_flex_rtg  dfr
	, dcp_output_route dor
 
 
plan dfp
where cnvtupper(dfp.printer_name)	= patstring(que_fuzzy)
 
join dfr
where dfp.dcp_flex_rtg_id		= dfr.dcp_flex_rtg_id
 
join dor
where dfr.dcp_output_route_id		= dor.dcp_output_route_id
 
 
head report
	t_printer->req_job_cnt = 0
 
detail
        t_printer->req_job_cnt = t_printer->req_job_cnt + 1
 
        if (mod(t_printer->req_job_cnt, 10) = 1)
                stat = alterlist(t_printer->req_job, t_printer->req_job_cnt + 9)
        endif
 
        indx = t_printer->req_job_cnt
 
	t_printer->req_job[indx]->value2_disp	= value2_disp
        t_printer->req_job[indx]->desc		= desc
        t_printer->req_job[indx]->param1_disp	= param1_disp
        t_printer->req_job[indx]->param2_disp	= param2_disp
        t_printer->req_job[indx]->param3_disp	= param3_disp
 
 
foot report
        if (mod(t_printer->req_job_cnt, 10) != 0)
                stat = alterlist(t_printer->req_job, t_printer->req_job_cnt)
        endif
 
 
with nocounter
 
; End of orders requisitions
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Charts
 
select into "nl:"
	  desc = co.batch_name
	, queue = substring(1, 20, d.name)
 
from	  device d
	, output_dest od
	, charting_operations co
 
 
plan d
where d.name			= patstring(que_fuzzy)
  and d.device_type_cd		= printer_cd
 
join od
where  d.device_cd		= od.device_cd
 
join co
where cnvtstring(od.output_dest_cd)	= co.param
  and co.param_type_flag		= 10
 
 
head report
	t_printer->chart_job_cnt = 0
 
detail
	t_printer->chart_job_cnt = t_printer->chart_job_cnt + 1
 
	        if (mod(t_printer->chart_job_cnt, 10) = 1)
                stat = alterlist(t_printer->chart_job, t_printer->chart_job_cnt + 9)
        endif
 
	indx = t_printer->chart_job_cnt
 
	t_printer->chart_job[indx]->desc		= desc
	t_printer->chart_job[indx]->queue		= queue
 
 
foot report
	if (mod(t_printer->chart_job_cnt, 10) != 0)
                stat = alterlist(t_printer->chart_job, t_printer->chart_job_cnt)
        endif
 
 
with nocounter
 
 
; End of charts
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;



; Begin 002
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; SurgiNet

select into "nl:"
	  disp = substring(1, 80, sr.display)
	, type = substring(1, 80, uar_get_code_display(sr.rpt_type_cd))
	, loc = substring(1, 40, srfg.display)
	, num_copies = srd.num_copies

from	  sn_rpt_dest		srd
	, sn_rpt_filter_grp	srfg
	, sn_rpt		sr

plan srd
where cnvtupper(srd.display)		= que_name
   or cnvtupper(srd.display)		= patstring(que_fuzzy)

join srfg
where srfg.rpt_filter_grp_id		= srd.rpt_filter_grp_id

join sr
where sr.rpt_id				= srfg.rpt_id


head report
	t_printer->surgi_job_cnt	= 0
	srindx				= 0


detail
	t_printer->surgi_job_cnt	= t_printer->surgi_job_cnt + 1
	srindx				= t_printer->surgi_job_cnt

	stat = alterlist(t_printer->surgi_job, t_printer->surgi_job_cnt)

	t_printer->surgi_job[srindx]->disp		= disp
	t_printer->surgi_job[srindx]->type		= type
	t_printer->surgi_job[srindx]->loc		= loc
	t_printer->surgi_job[srindx]->num_copies	= num_copies

with nocounter

; End of SurgiNet
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; End 002



; Begin 003
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Rad Req's

select into "nl:"
	  od.name
	, od.script


from      output_dest_xref 	odx
	, output_dest		od
	, device		d
	, code_value		cv


plan odx

join od
where odx.output_dest_cd	= od.output_dest_cd

join d
where d.device_cd		= od.device_cd
  and d.name                   = que_name
  and d.device_type_cd         = printer_cd


join cv
where cv.code_value	= odx.usage_type_cd
  and cv.active_ind	= 1
  and cv.cdf_meaning	in ("CONTENT", "FLASHCARD", "FOLDER", "GENERIC", "REQUISITION", "TRANSPORT")


order by od.name, od.script


head report
	t_printer->rad_req_cnt	= 0
	rrind			= 0


head od.name
	t_printer->rad_req_cnt	= t_printer->rad_req_cnt + 1
	rrind			= t_printer->rad_req_cnt

	stat = alterlist(t_printer->rad_req, t_printer->rad_req_cnt)

	t_printer->rad_req[rrind]->od_name	= od.name


head od.script
	t_printer->rad_req[rrind]->od_script	= od.script

with nocounter

; End of Rad Req's
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; End 003

 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Check that at least one job was found.  If not, exit out.
 
if ((value(t_printer->pm_route_cnt) = 0)
    and
    (value(t_printer->ops_job_cnt) = 0)
    and
    (value(t_printer->sched_job_cnt) = 0)
    and
    (value(t_printer->req_job_cnt) = 0)
    and
    (value(t_printer->chart_job_cnt) = 0)
    and                                                                                 ;002
    (value(t_printer->surgi_job_cnt) = 0)						;002
    and											;003
    (value(t_printer->rad_req_cnt) = 0)                                                 ;003
   )
	execute from 9000_NO_JOBS to 9099_NO_JOBS
	go to exit_script
 
endif
 
; End of checking for at least one job
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Print the report
 
select into value(io)
	  d.seq
 
from dummyt d
 
plan d
 
 
head page
	CALL CENTER("Children's Hospitals & Clinics", 1, 187)
	row + 1
	title = concat("Auto printing to queue: ", que_name)
	CALL CENTER(title, 1, 187)
	row + 2
	curline = 3
 
 
head d.seq
	if (t_printer->pm_route_cnt > 0)
		CALL CENTER("PM Document Routing", 1, 187)
		row + 1
		col 001, "Document"
		col 035, "Distribution"
		col 090, "Queue"
		col 145, "Copies"
		row + 1
		col 001, line
		row + 1
		curline = curline + 3
 
		for (i = 1 to t_printer->pm_route_cnt)
			if (curline >= 40)
				break
			endif
 
			col 001, t_printer->pm_route[i]->doc_desc
			col 035, t_printer->pm_route[i]->distr_name
			col 090, t_printer->pm_route[i]->name
			col 145, t_printer->pm_route[i]->copies "####;l"
			row + 1
			curline = curline + 1
		endfor
 
		row + 3
		curline = curline + 3
	endif
 
 
        if (curline >= 40)
        	break
        endif
 
 
 
	if (t_printer->ops_job_cnt > 0)
		CALL CENTER("Ops jobs", 1, 187)
		row + 1
		col 001, "Host"
		col 010, "Control Group"
		col 038, "Time"
		col 045, "Job Group"
		col 090, "Job Name"
		row + 1
		col 045, "Output Distr"
		col 090, "Batch"
		row + 1
		col 001, line
		row + 1
		curline = curline + 4
 
 
		for (j = 1 to t_printer->ops_job_cnt)
                        if (curline >= 40)
                                break
                        endif
 
			col 001, t_printer->ops_job[j]->hst
			col 010, t_printer->ops_job[j]->cntrl_grp
			col 038, t_printer->ops_job[j]->job_time
			col 045, t_printer->ops_job[j]->ot_parent_name
			col 090, t_printer->ops_job[j]->job_name
			row + 1
			col 045, t_printer->ops_job[j]->output_dist
			col 090, t_printer->ops_job[j]->batch
			row + 1
			curline = curline + 2
		endfor
 
		row + 3
		curline = curline + 3
	endif
 
 
	if (curline >= 40)
        	break
        endif
 
 
	if (t_printer->sched_job_cnt > 0)
		CALL CENTER("Scheduling Routes", 1, 187)
		row + 1
		col 001, "Meaning"
		col 020, "Route"
		row + 1
		col 001, line
		row + 1
		curline = curline + 3
 
		for (k = 1 to t_printer->sched_job_cnt)
			if (curline >= 40)
                                break
                        endif
 
			col 001, t_printer->sched_job[k]->mean
			col 020, t_printer->sched_job[k]->mnem
			row + 1
 
			if (curline >= 40)
                                break
                        endif
		endfor
 
		row + 3
		curline = curline + 3
	endif
 
        if (curline >= 40)
                break
        endif
 
 
 
        if (t_printer->req_job_cnt > 0)
                CALL CENTER("Requisitions", 1, 187)
                row + 1
                col 001, "Value2"
		col 035, "Description"
		col 085, "Param1"
		col 120, "Param2"
		col 155, "Param3"
		row + 1
                col 001, line
                row + 1
                curline = curline + 3
 
                for (l = 1 to t_printer->req_job_cnt)
                        if (curline >= 40)
                                break
                        endif
 
                        col 001, t_printer->req_job[l]->value2_disp
			col 035, t_printer->req_job[l]->desc
			col 085, t_printer->req_job[l]->param1_disp
			col 120, t_printer->req_job[l]->param2_disp
			col 155, t_printer->req_job[l]->param3_disp
                        row + 1
 
                        if (curline >= 40)
                                break
                        endif
                endfor
 
		row + 3
		curline = curline + 3
 
        endif
 
	if (curline >= 40)
        	break
        endif
 
 
 
        if (t_printer->chart_job_cnt > 0)
                CALL CENTER("Charts", 1, 187)
                row + 1
		col 001, "Description"
		col 080, "Queue"
		row + 1
		col 001, line
                row + 1
		curline = curline + 3
 
             for (m = 1 to t_printer->chart_job_cnt)
                        if (curline >= 40)
                                break
                        endif
 
                        col 001, t_printer->chart_job[m]->desc
			col 080, t_printer->chart_job[m]->queue
			row + 1
			curline = curline + 1
	     endfor
 
             row + 3
             curline = curline + 3
        endif


; Begin 002
	if (t_printer->surgi_job_cnt > 0)
		call center("SurgiNet Reports", 1, 187)
		row + 1
		col 001, "Report"
		col 082, "Location"
		col 124, "Copies"
		row + 1
		col 001, "Report Type"
		row + 1
		col 001, line
		row + 1
		curline = curline + 4

		for (n = 1 to t_printer->surgi_job_cnt)
			if (curline >= 40)
				break
			endif

			col 001, t_printer->surgi_job[n]->disp
			col 082, t_printer->surgi_job[n]->type
			col 124, t_printer->surgi_job[n]->num_copies
			row + 1
			col 001, t_printer->surgi_job[n]->type
			row + 2
			curline = curline + 3
		endfor

		row + 3
		curline = curline + 3

	endif
; End 002


; Begin 003
        if (t_printer->rad_req_cnt > 0)
                call center("Radiology Requisitions", 1, 187)
                row + 1
                col 001, "Output Destination"
                col 030, "Script"
		row + 1

		for (p = 1 to t_printer->rad_req_cnt)
			col 001, t_printer->rad_req[p]->od_name
			col 030, t_printer->rad_req[p]->od_script
			row + 1
		endfor
	endif
; End 003
 
detail
	curline = curline
 
 
foot page
   ROW 42
   col 144, "Page: ", curpage "###;l"
   row 43
   col 144, "Print Date/Time: ", sysdate "mm/dd/yy hh:mm;;d"
 
 
with	  nocounter
	, landscape
	, compress
	, maxcol = 300		;188
	, maxrow = 44
 
 
go to exit_script
 
; End of printing
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
# 9000_NO_JOBS
 
select into value(io)
	msg = concat("There aren't any active printing jobs for ", que_name)
 
detail
	row 2
	col 001, msg
 
with nocounter
 
# 9099_NO_JOBS_END
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
 
 
#exit_script
free set t_printer
end
go

########################################################################################################################################################

/*
Med Reconciliation report that prints order detail for all active inpatient, retail, and EasyScript orders. Provider indicates which orders to continue. Report is used as legal prescription, as well as for communication to next provider of care and to pharmacist for med reconciliation.
*/
drop   program chld_mn_disch_med_rec:dba go
create program chld_mn_disch_med_rec:dba
 
;This report, run from PowerChart, will find all active inpatient, retail, 
;and Easyscript orders related to a specific encounter. 
;Our HUCS run the report when the patient is going to be discharged, and 
;clip a copy of it to the patient chart. The provider indicates by checking 
;a box beside each order if the order is to be continued and then
;signs the form. Three copies are made: one for the chart, one for the 
;decentral pharmacist (for med reconciliation task), and one to the patient
;(or retail pharmacy) as a prescription. The chart copy is routed to the
;primary care physician by Data & Record Services.
Our report prints an Asthma Action Plan at the end if an asthma problem is 
;found.

;
;Karen Malmsmkog
;Pharmacy/IT Analyst
;Children's Hospitals and Clinics of Minnesota
;2900 Centre Pointe Drive
;Roseville, MN 55113
;karen.malmskog@childrensmn.org

 
 
%i cust_script:mrn_util.inc
 
if (not validate(reply,0))
  record reply
  (
  1 elapsed_time          = F8
  1 status                = c1
%I cclsource:status_block.inc
  )
endif
 
if (not validate(errors,0))
   record errors
  (
  1 err_cnt     = i4
  1 err[*]
    2  err_code = i4
    2  err_msg  = vc
  )
endif
 
 
set io = request->output_device
 
free record t_rec
record t_rec (
  1 eid = f8
  1 fin = c15
  1 cur_unit = vc
  1 addr = c58
  1 name = c35
  1 wght = vc
  1 pid = f8
  1 mrn = c15
  1 dob = c12
  1 asthma_flag = i4
  1 fac_street = vc
  1 fac_city_state_zip = vc
  1 attending = c35
  1 ord_cnt = i4
  1 ord [*]
    2 oid = f8
    2 o_cat_type = c20
    2 o_ord_stat = c20
    2 o_prn_ind = i4
    2 oi_comp_seq = i4
    2 od_ord_type = f8
    2 brd_val = c200
    2 ord_freq = c50
    2 ord_route = c25
    2 o_ord_start_dt = c15
    2 o_mnem_sort = c3
    2 o_mnem = c55
    2 o_as_mnem = c55
    2 o_comment = c255
    2 od_ord_sort = i4
    2 tnf_desc = c100
    2 oi_freetxt_dose = c100
    2 oi_strength = f8
    2 oi_strength_unit = c20
    2 oi_volume = f8
    2 oi_volume_unit = c20
    2 op_tnf_id = f8
    2 op_item_id = f8
    2 ord_oe_field_mean = c25
    2 ord_oe_field_value = f8
    2 ord_oe_field_display_value = c255
    2 o_projected_stop_dt = c15
  1 ezscript_cnt = i4
  1 ezscript [*]
    2 oid = f8
    2 o_cat_type = c20
    2 o_ord_stat = c20
    2 o_prn_ind = i4
    2 o_ord_start_dt = c15
    2 o_mnem = c50
    2 o_mnem_sort = c3
    2 o_as_mnem = c50
    2 ez_type = i4
    2 ret_sig = c200
    2 cont_sub = i4
    2 o_projected_stop_dt = c15
    2 o_comment = c255
    2 ez_order_sort = i4
    2 od_det_cnt = i4
    2 od_det [*]
      3 od_ord_sort = i4
      3 ord_oe_field_mean = c25
      3 ord_oe_field_value = f8
      3 ord_oe_field_display_value =c255
      3 ord_oe_field_id = f8
      3 ord_oe_field_def = vc
  1 allergy_cnt = i4
  1 allergy [*]
    2 allergy_id = f8
    2 allergy_desc = vc
    2 all_sort = c6
)
 
declare pharm_cd = f8
set	pharm_cd = uar_get_code_by("MEANING", 106, "PHARMACY")
 
set errcode = 1
set errmsg  = fillstring(132," ")
set errcnt  = 0
set ord_line = fillstring(128,"_")
set patient_id = 0.0
 
 
set pha_type = 0.0
set uar_var = uar_get_meaning_by_codeset(6000,"PHARMACY",1,pha_type)
set ord_stat = 0.0
set uar_var = uar_get_meaning_by_codeset(6004,"ORDERED",1,ord_stat)
set fut_stat = 0.0
set uar_var = uar_get_meaning_by_codeset(6004,"FUTURE",1,fut_stat)
set in_proc_stat = 0.0
set uar_var = uar_get_meaning_by_codeset(6004,"INPROCESS",1,in_proc_stat)
set pend_rev_stat = 0.0
set uar_var = uar_get_meaning_by_codeset(6004,"PENDING REV",1,pend_rev_stat)
set susp_stat = 0.0
set uar_var = uar_get_meaning_by_codeset(6004,"SUSPENDED",1,susp_stat)
;set gen_cd = 0.0
;set uar_var = uar_get_meaning_by_codeset(11000,"GENERIC_NAME",1,gen_cd)
set brand_cd = 0.0
set uar_var = uar_get_meaning_by_codeset(11000,"BRAND_NAME",1,brand_cd)
 
set mrn_pool_cd = 0.0
set mrn_pool_cd = uar_get_code_by("DISPLAYKEY",263,"CHILDRENSENTERPRISEMRN")
set mrn_cd = 0.0
set uar_var = uar_get_meaning_by_codeset(4,"MRN",1,mrn_cd)
set fin_cd = 0.0
set uar_var = uar_get_meaning_by_codeset(319,"FIN NBR",1,fin_cd)
set consent_cd = 0.0
set consent_cd = uar_get_code_by("DISPLAYKEY",16449,"MINORCONSENT")
set pharm_type_cd = 0.0
set pharm_type_cd = uar_get_code_by("DISPLAYKEY",4500,"INPATIENT")
 
declare weight_cd = f8
set     weight_cd = uar_get_code_by("DISPLAYKEY", 72, "WEIGHT")
 
declare bus_addr_cd = f8
set	bus_addr_cd = uar_get_code_by("MEANING", 212, "BUSINESS")
 
set t_rec->asthma_flag = 0

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the facility and the facility address for the encntr selected
 
select into "nl:"
   ad.street_addr
  ,ad.city
  ,ad.state
  ,ad.zipcode
  ,cur_unit = uar_get_code_display(e.loc_nurse_unit_cd)
 
from encounter	e
    ,address	ad
 
plan e
  where e.encntr_id = request->visit[1]->encntr_id
 
join ad
  where ad.parent_entity_id	= e.loc_facility_cd
    and ad.address_type_cd	= bus_addr_cd
    and ad.active_ind		= 1
    and ad.beg_effective_dt_tm	<= cnvtdatetime(curdate, curtime3)
    and ad.end_effective_dt_tm	>= cnvtdatetime(curdate, curtime3)
 
detail
  t_rec->cur_unit               = trim(cur_unit)
  t_rec->fac_street             = trim(ad.street_addr)
  t_rec->fac_city_state_zip     = concat(trim(ad.city, 3),", ",trim(ad.state, 3),"  ",trim(ad.zipcode, 3))
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find patient's home address
 
select into "nl:"
   ad.street_addr
  ,ad.city
  ,ad.state
  ,ad.zipcode
 
from encounter  e
    ,address    ad
    ,person     p
 
plan e
  where e.encntr_id = request->visit[1]->encntr_id
 
join p
  where e.person_id = p.person_id
 
join ad
  where ad.parent_entity_id       = e.person_id
    and ad.active_ind             = 1
    and ad.beg_effective_dt_tm    <= cnvtdatetime(curdate, curtime3)
    and ad.end_effective_dt_tm    >= cnvtdatetime(curdate, curtime3)
 
detail
  t_rec->pid  = e.person_id
  t_rec->name = substring(1, 35, p.name_full_formatted)
  t_rec->dob  = format(p.birth_dt_tm, "mm/dd/yyyy;;d")
  t_rec->addr = concat(trim(ad.street_addr, 3),", ", trim(ad.city, 3),", ",trim(ad.state, 3))
  t_rec->addr = concat(trim(t_rec->addr, 3), " ", trim(ad.zipcode, 3))
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the patient's weight
 
select into "nl:"
  ce.clinical_event_id
 
from clinical_event        ce
 
plan ce
      where ce.encntr_id              = request->visit[1]->encntr_id
        and ce.event_cd               = weight_cd
        and ce.event_end_dt_tm        <= cnvtdatetime(curdate, curtime3)
        and ce.valid_until_dt_tm      >= cnvtdatetime(curdate, curtime3)
  where ce.clinical_event_id	  = (select max(ce1.clinical_event_id)
				     from clinical_event ce1
                 where ce1.encntr_id          = request->visit[1]->encntr_id
		   and ce1.event_cd           = weight_cd
                   and ce1.event_end_dt_tm    <= cnvtdatetime(curdate, curtime3)
		   and ce1.valid_until_dt_tm  >= cnvtdatetime(curdate, curtime3)
                   and ce1.result_status_cd in (9,15) ; auth, modified
				    )
 
 
detail
  decimal_pos     = findstring(".", ce.result_val) + 1
 
  t_rec->wght = concat(format(cnvtreal(ce.result_val),"####.##"), " ", uar_get_code_display(ce.result_units_cd))
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the attending physician
 
select into "nl:"
 
from
  encntr_prsnl_reltn epr
 ,person att
 
plan epr
  where epr.encntr_id           = request->visit[1]->encntr_id
    and epr.encntr_prsnl_r_cd   = 653
    and epr.end_effective_dt_tm > cnvtdatetime(curdate,curtime)
 
join att
  where epr.prsnl_person_id = att.person_id
 
order by epr.encntr_prsnl_reltn_id
 
head epr.encntr_prsnl_reltn_id
  t_rec->attending              = substring(1, 35, att.name_full_formatted)
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;Find all med orders for the encounter
 
select into "nl:"
   o.order_id
  ,ord_type = uar_get_code_display(o.catalog_type_cd)
  ,ord_stat = uar_get_code_display(o.order_status_cd)
  ,o.prn_ind
  ,oi.comp_sequence
  ,od.order_type
  ,brd.value
  ,order_start = format(o.current_start_dt_tm,"yyyymmddhhmm;;q")
  ,mnemonic_sort = substring (1,3,o.order_mnemonic)
  ,order_sort =     if(od.order_type in (1,3))
                      if(o.prn_ind = 0)
                        1     ;scheduled meds
                      else
                        2     ;prn meds
                      endif
                    else
                      3       ;continuous meds
                    endif
  ,pa.alias
 
from
   orders o
  ,encounter e
  ,person_alias pa
  ,order_detail ord
  ,order_ingredient oi
  ,order_product op
  ,order_dispense od
  ,med_identifier brd
  ,code_value cv
 
plan e
  where e.encntr_id = outerjoin(request->visit[1].encntr_id)
 
join o
  where o.encntr_id             = e.encntr_id
    and o.catalog_type_cd       = pha_type
    and o.order_status_cd       in (ord_stat, fut_stat, in_proc_stat, pend_rev_stat, susp_stat)
    and o.order_mnemonic        != ".*"             ;(.MAR and .DAY notes)
 
join od
  where o.order_id 		= od.order_id
    and od.order_type		= 1
 
join pa
  where e.person_id 		= pa.person_id
    and pa.person_alias_type_cd = mrn_cd
    and pa.end_effective_dt_tm 	>= cnvtdatetime(curdate,curtime)
    and pa.alias_pool_cd        = mrn_pool_cd
    and pa.active_ind           = 1
 
join ord
  where o.order_id 		= ord.order_id
    and ord.action_sequence 	= (select max(ord2.action_sequence)
                                   from order_detail ord2
                                   where o.order_id 	 = ord2.order_id
                                     and ord.oe_field_id = ord2.oe_field_id
                              	  )
 
join oi
  where o.order_id 	  	= oi.order_id
    and oi.action_sequence 	= (select max(oi2.action_sequence)
                             	   from order_ingredient oi2
                             	   where o.order_id 	   = oi2.order_id
                              	   and oi.comp_sequence = oi2.comp_sequence
                            	  )
 
join op
  where o.order_id 		= op.order_id
    and oi.action_sequence 	= op.action_sequence
    and oi.comp_sequence 	= op.ingred_sequence
 
join cv
  where outerjoin(ord.oe_field_value) = cv.code_value
 
join brd
  where outerjoin(op.item_id)      = brd.item_id
    and brd.med_identifier_type_cd = outerjoin(brand_cd)
    and brd.med_product_id         = outerjoin(0)
    and brd.pharmacy_type_cd       = outerjoin(pharm_type_cd)
    and brd.primary_ind            = outerjoin(1)
    and brd.active_ind             = outerjoin(1)
 
order by
   e.encntr_id
  ,order_sort
  ,mnemonic_sort
  ,order_start
  ,o.order_id
  ,oi.comp_sequence
 
 
head report
  t_rec->eid       = request->visit[1]->encntr_id
 
  t_rec->ord_cnt   = 0
  indx             = 0
 
detail
  t_rec->ord_cnt   = t_rec->ord_cnt + 1
  indx             = t_rec->ord_cnt
 
  if (mod(t_rec->ord_cnt, 10) = 1 )
    stat = alterlist(t_rec->ord, t_rec->ord_cnt + 9)
  endif
 
  t_rec->ord[indx]->oid				= o.order_id
  t_rec->ord[indx]->o_cat_type			= uar_get_code_display(o.catalog_type_cd)
  t_rec->ord[indx]->o_ord_stat			= uar_get_code_display(o.order_status_cd)
  t_rec->ord[indx]->o_prn_ind			= o.prn_ind
  t_rec->ord[indx]->oi_comp_seq			= oi.comp_sequence
  t_rec->ord[indx]->od_ord_type			= od.order_type
  t_rec->ord[indx]->brd_val			= brd.value
  t_rec->ord[indx]->o_ord_start_dt		= format(o.current_start_dt_tm,"mm/dd/yy;;d")
  t_rec->ord[indx]->o_mnem_sort			= substring(1, 8, o.order_mnemonic)
  t_rec->ord[indx]->o_mnem			= o.order_mnemonic
  t_rec->ord[indx]->o_as_mnem                   = o.ordered_as_mnemonic
  t_rec->ord[indx]->od_ord_sort			= order_sort
  t_rec->ord[indx]->tnf_desc			= o.order_mnemonic
  t_rec->ord[indx]->o_projected_stop_dt		= format(o.projected_stop_dt_tm, "mm/dd/yy hh:mm;;d")
  t_rec->ord[indx]->oi_freetxt_dose		= oi.freetext_dose
  t_rec->ord[indx]->oi_strength			= oi.strength
  t_rec->ord[indx]->oi_strength_unit		= uar_get_code_display(oi.strength_unit)
  t_rec->ord[indx]->oi_volume			= oi.volume
  t_rec->ord[indx]->oi_volume_unit		= uar_get_code_display(oi.volume_unit)
  t_rec->ord[indx]->ord_freq                    = cv.definition
  t_rec->ord[indx]->ord_route                   = cv.definition
  t_rec->ord[indx]->op_tnf_id			= op.tnf_id
  t_rec->ord[indx]->op_item_id                  = op.item_id
  t_rec->ord[indx]->ord_oe_field_mean		= ord.oe_field_meaning
  t_rec->ord[indx]->ord_oe_field_value		= ord.oe_field_value
  t_rec->ord[indx]->ord_oe_field_display_value	= ord.oe_field_display_value
 
 
foot report
  if (mod(t_rec->ord_cnt, 10) != 0)
    stat = alterlist(t_rec->ord, t_rec->ord_cnt)
  endif
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find inpatient controlled substance orders
 
select into "nl:"
 
from med_dispense md
    ,(dummyt d with seq = t_rec->ord_cnt)
 
plan d
 
join md
  where md.pharmacy_type_cd = 2663066 ; inpatient
    and md.item_id = t_rec->ord[d.seq].op_item_id
 
detail
  if(md.legal_status_cd = 1295)
    t_rec->ord[d.seq].od_ord_sort = 9         ;controlled substances
  endif
 
  row + 1
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the order comment
 
select into "nl:"
 
from
  order_dispense od
 ,order_comment orc
 ,long_text lt
 ,(dummyt d with seq = t_rec->ord_cnt)
 
plan d
 
join od
  where od.order_id 		= t_rec->ord[d.seq].oid
 
join orc
  where od.order_id = orc.order_id
    and orc.comment_type_cd = 32
 
join lt
  where orc.long_text_id = lt.long_text_id
 
order by
  od.order_id
 ,orc.action_sequence desc
 
head od.order_id
  t_rec->ord[d.seq].o_comment   = substring(1,200,lt.long_text)

with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find patient's allergies
 
select into "nl:"
 
  a.allergy_id
 ,description = if (a.substance_nom_id > 0)
                  substring(1,100,n.source_string)
                else
                  substring(1,100,a.substance_ftdesc)
                endif
 ,all_sort = if (a.substance_nom_id > 0)
                  substring(1,6,n.source_string)
                else
                  substring(1,6,a.substance_ftdesc)
                endif
 ,n.source_string
 
from allergy a
    ,nomenclature n
 
plan a
  where a.person_id = t_rec->pid
    and a.beg_effective_dt_tm < cnvtdatetime(curdate,curtime)
    and a.end_effective_dt_tm > cnvtdatetime(curdate,curtime)
    and a.active_ind = 1
    and a.active_status_cd = 119
    and a.cancel_dt_tm is null
 
join n
  where outerjoin(a.substance_nom_id) = n.nomenclature_id
 
order by
  all_sort
 
head report
  t_rec->allergy_cnt           = 0
 
detail
  t_rec->allergy_cnt           = t_rec->allergy_cnt + 1
 
    stat = alterlist(t_rec->allergy, t_rec->allergy_cnt)
 
  t_rec->allergy[t_rec->allergy_cnt]->allergy_id   = a.allergy_id
  t_rec->allergy[t_rec->allergy_cnt]->allergy_desc = description
  t_rec->allergy[t_rec->allergy_cnt]->all_sort     = all_sort
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find patient's asthma problem
 
select into "nl:"
 
from problem pr
    ,nomenclature n
 
plan pr
  where pr.person_id = t_rec->pid
    and pr.active_ind = 1
    and pr.cancel_reason_cd = 0
    and pr.life_cycle_status_cd = 1753
 
join n
  where outerjoin(n.nomenclature_id) = pr.nomenclature_id
    and n.source_identifier in ('493','493.*')
 
detail
  t_rec->asthma_flag = 1
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the FIN number for the encounter
 
select into "nl:"
 
from encntr_alias ea
 
plan ea
  where ea.encntr_id = request->visit[1]->encntr_id
    and ea.encntr_alias_type_cd = fin_cd
    and ea.end_effective_dt_tm  >= cnvtdatetime(curdate,curtime)
 
detail
  t_rec->fin       = substring(1, 15, ea.alias)
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; MRN
 
set pid                 = t_rec->pid
set mrn1                = get_pa_mrn(pid)
set pos                 = findstring("-", mrn1) - 1
set mrn                 = substring(1, pos, mrn1)
set t_rec->mrn 		= mrn
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the EZ Script meds
 
select into "nl:"
   o.order_id
  ,ord_type = uar_get_code_display(o.catalog_type_cd)
  ,ord_stat = uar_get_code_display(o.order_status_cd)
  ,o.prn_ind
  ,order_start = format(o.current_start_dt_tm,"yyyymmddhhmm;;q")
  ,mnemonic_sort = substring(1,15,o.order_mnemonic)
  ,order_sort = 4
 
from
   orders 		    o
  ,order_detail 	    ord
  ,code_value	            cv
 
plan o
  where o.person_id     	= t_rec->pid
    and o.catalog_type_cd 	= pha_type
    and o.order_status_cd 	in (ord_stat, fut_stat, in_proc_stat, pend_rev_stat, susp_stat)
    and o.activity_type_cd+0	= pharm_cd
    and o.orig_ord_as_flag 	in (1,2)
    and not exists 		(select  od.order_id
				   from  order_dispense od
                    		  where  o.order_id = od.order_id
                                    and  od.parent_order_id > 0)
 
join ord
  where o.order_id              = ord.order_id
    and ord.action_sequence     = (select max(ord2.action_sequence)
                                     from order_detail ord2
                                     where ord.order_id    = ord2.order_id
                                     and ord.oe_field_id = ord2.oe_field_id
                                  )
 
join cv
  where outerjoin(ord.oe_field_value) 	= cv.code_value
 
order by
  mnemonic_sort
 ,order_start
 ,o.order_id
 
 
head report
  t_rec->ezscript_cnt	= 0
  indx2			= 0
 
 
head o.order_id		;detail
  indx2			= indx2 + 1 ;t_rec->ezscript_cnt
 
  stat = alterlist(t_rec->ezscript, indx2) ;t_rec->ezscript_cnt)
 
  t_rec->ezscript[indx2]->oid		= o.order_id
  t_rec->ezscript[indx2]->o_cat_type	= uar_get_code_display(o.catalog_type_cd)
  t_rec->ezscript[indx2]->o_ord_stat    = uar_get_code_display(o.order_status_cd)
  t_rec->ezscript[indx2]->o_prn_ind     = o.prn_ind
  t_rec->ezscript[indx2]->o_ord_start_dt = format(o.current_start_dt_tm,"mm/dd/yy;;d")
  t_rec->ezscript[indx2]->o_mnem	= o.order_mnemonic
  t_rec->ezscript[indx2]->o_mnem_sort   = substring(1, 5, o.order_mnemonic)
  t_rec->ezscript[indx2]->o_as_mnem     = o.ordered_as_mnemonic
  t_rec->ezscript[indx2]->ez_type	= 1
  t_rec->ezscript[indx2]->od_det_cnt	= 0
  t_rec->ezscript[indx2]->ez_order_sort = order_sort
  t_rec->ezscript[indx2]->cont_sub      = 0
  indx3					= 0
 
detail
  indx3		 =indx3 + 1
 
  if (mod(indx3,50) = 1)
    stat = alterlist(t_rec->ezscript[indx2]->od_det,indx3+50)
  endif
 
  t_rec->ezscript[indx2]->od_det[indx3]->ord_oe_field_mean          = ord.oe_field_meaning
  t_rec->ezscript[indx2]->od_det[indx3]->ord_oe_field_value         = ord.oe_field_value
  t_rec->ezscript[indx2]->od_det[indx3]->ord_oe_field_display_value = ord.oe_field_display_value
  t_rec->ezscript[indx2]->od_det[indx3]->ord_oe_field_id	    = ord.oe_field_id
  t_rec->ezscript[indx2]->od_det[indx3]->ord_oe_field_def	    = cv.definition
 
foot o.order_id
  stat = alterlist(t_rec->ezscript[indx2].od_det,indx3)
  t_rec->ezscript[indx2]->od_det_cnt = indx3
 
foot report
  t_rec->ezscript_cnt = indx2
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the EZ Script controlled substance orders
 
select into "nl: "
 
from
   orders o
  ,mltm_ndc_main_drug_code mltm
  ,(dummyt d with seq = t_rec->ezscript_cnt)
 
plan d
 
join o
  where o.order_id            = t_rec->ezscript[d.seq].oid
 
join mltm
  where substring(9,6,o.cki)  = mltm.drug_identifier
    and mltm.csa_schedule     = "2"
 
detail
  t_rec->ezscript[d.seq].cont_sub  = 1
  t_rec->ezscript[d.seq].ez_type   = 2
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the EasyScript Retail sig
 
select into "nl:"
 
from
  order_dispense od
 ,order_comment orc
 ,long_text lt
 ,(dummyt d with seq = t_rec->ezscript_cnt)
 
plan d
 
join od
  where od.order_id 		= t_rec->ezscript[d.seq].oid
    and od.parent_order_id 	= 0
 
join orc
  where od.order_id = orc.order_id
    and orc.comment_type_cd = 2662985
 
join lt
  where orc.long_text_id = lt.long_text_id
 
order by
  od.order_id
 ,orc.action_sequence desc
 
head od.order_id
  t_rec->ezscript[d.seq].ez_type        	= 0
  t_rec->ezscript[d.seq].ret_sig		= substring(1,200,lt.long_text)
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the EasyScript order comment
 
select into "nl:"
 
from
 order_comment orc
 ,long_text lt
 ,(dummyt d with seq = t_rec->ezscript_cnt)
 
plan d
 
join orc
  where orc.order_id = t_rec->ezscript[d.seq].oid
    and orc.comment_type_cd = 32
 
join lt
  where orc.long_text_id = lt.long_text_id
 
order by
  orc.order_id
 ,orc.action_sequence desc
 
head orc.order_id
  t_rec->ezscript[d.seq].o_comment              = substring(1,200,lt.long_text)
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find retail controlled substance orders
 
select into "nl: "
 
from
  orders o
 ,order_ingredient oi
 ,order_product op
 ,med_dispense md
 ,(dummyt d with seq = t_rec->ezscript_cnt)
 
plan d
 
join o
  where o.order_id               = t_rec->ezscript[d.seq].oid
 
join oi
  where o.order_id              = oi.order_id
   and oi.action_sequence       = (select max(oi2.action_sequence)
                                   from order_ingredient oi2
                                   where o.order_id        = oi2.order_id
                                   and oi.comp_sequence = oi2.comp_sequence
                                  )
 
join op
  where o.order_id              = op.order_id
   and oi.action_sequence       = op.action_sequence
   and oi.comp_sequence         = op.ingred_sequence
 
join md
  where op.item_id              = md.item_id
    and md.legal_status_cd      = 1295
 
order by
  op.order_id
 
head op.order_id
  t_rec->ezscript[d.seq].cont_sub               = 1
  t_rec->ezscript[d.seq].ez_type                = 2
 
with nocounter
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; Find the EasyScript Minor Consent sig
 
select into "nl:"
 
 
from
  order_detail ord
 ,(dummyt d with seq = t_rec->ezscript_cnt)
 
plan d
 
join ord
  where ord.order_id    = t_rec->ezscript[d.seq].oid
    and ord.oe_field_id = consent_cd
 
order by
  ord.order_id
 
head ord.order_id
  t_rec->ezscript[d.seq].ez_type       = 2
  t_rec->ezscript[d.seq].ez_order_sort = 5
 
with nocounter
 
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;Print the report
 
;select into mine
select into value(io)
   d.seq
  ,fin = t_rec->fin
  ,mrn = t_rec->mrn
  ,current_loc = t_rec->cur_unit
  ,name = t_rec->name
  ,home_addr = t_rec->addr
  ,dob = t_rec->dob
  ,attending_provider = t_rec->attending
  ,o_cat_type = t_rec->ord[d.seq]->o_cat_type
  ,o_ord_stat = t_rec->ord[d.seq]->o_ord_stat
  ,o_prn_ind = t_rec->ord[d.seq]->o_prn_ind
  ,oi_comp_seq = t_rec->ord[d.seq]->oi_comp_seq
  ,od_ord_type = t_rec->ord[d.seq]->od_ord_type
  ,brd_val = t_rec->ord[d.seq]->brd_val
  ,o_ord_start_dt = t_rec->ord[d.seq]->o_ord_start_dt
  ,o_mnem_sort = t_rec->ord[d.seq]->o_mnem_sort
  ,o_mnem = t_rec->ord[d.seq]->o_mnem
  ,o_as_mnem = t_rec->ord[d.seq]->o_as_mnem
  ,o_comment = t_rec->ord[d.seq]->o_comment
  ,od_ord_sort = t_rec->ord[d.seq]->od_ord_sort
  ,tnf_desc = t_rec->ord[d.seq]->tnf_desc
  ,oid = t_rec->ord[d.seq]->oid
  ,o_projected_stop_dt = t_rec->ord[d.seq]->o_projected_stop_dt
  ,oi_freetxt_dose = t_rec->ord[d.seq]->oi_freetxt_dose
  ,oi_strength = t_rec->ord[d.seq]->oi_strength
  ,oi_strength_unit = t_rec->ord[d.seq]->oi_strength_unit
  ,oi_volume = t_rec->ord[d.seq]->oi_volume
  ,oi_volume_unit = t_rec->ord[d.seq]->oi_volume_unit
  ,ord_freq = t_rec->ord[d.seq]->ord_freq
  ,ord_route = t_rec->ord[d.seq]->ord_route
  ,op_tnf_id = t_rec->ord[d.seq]->op_tnf_id
  ,ord_oe_field_mean = t_rec->ord[d.seq]->ord_oe_field_mean
  ,ord_oe_field_value = t_rec->ord[d.seq]->ord_oe_field_value
  ,ord_oe_field_display_value = t_rec->ord[d.seq]->ord_oe_field_display_value
  ,wght = t_rec->wght
  ,fac_street = t_rec->fac_street
  ,fac_city_state_zip = t_rec->fac_city_state_zip
  ,drug_sort = cnvtupper(t_rec->ord[d.seq]->o_mnem)
 
from
  (dummyt	d with seq = t_rec->ord_cnt)
 
plan d
 
order by name
        ,od_ord_sort
        ,drug_sort
        ,oid
        ,oi_comp_seq
 
head report
  line1     = fillstring(75,"~"),
  LINE2     = fillstring(100,"_"),
  page_ind  = 0
  last_page = 0
  ez_order  = 0
  header_printed = 0
  ipsched_header_printed = 0
  ipprn_header_printed = 0
  ipcont_header_printed = 0
  cont_sub_fnd = 0
  cii_page_flag = 0
  parse_str = fillstring(2000," ")
  parse_med = fillstring(2000," ")
  run_date  = format(sysdate, "mm/dd/yyyy;;d")
  run_time  = format(sysdate, "hh:mm:ss;;d")
  rundate   = concat(run_date, " ", run_time)
 
  macro (parse_zeroes)  ;; PARSES ZEROS AND BLANK CHARACTERS FROM THE VALUE
 
    dsValue   = fillstring(12," ")
    move_fld  = fillstring(12,^ ^),
    strfld    = fillstring(12,^ ^),
    sig_dig   = 0,
    sig_dec   = 0,
    strfld    = cnvtstring(pass_field_in,12,4,r),
    str_cnt   = 1,
    len       = 0,
 
    while (str_cnt < 8 and substring(str_cnt,1,strfld) in ("0"," "))
      str_cnt = str_cnt + 1
    endwhile,
 
    sig_dig  = str_cnt - 1,
    str_cnt    = 12,
 
    while (str_cnt > 7 and substring(str_cnt,1,strfld) in ("0"," "))
      str_cnt = str_cnt - 1
    endwhile,
 
    if (str_cnt = 8 and substring(str_cnt,1,strfld) = ".")
      str_cnt = str_cnt - 1
    endif
 
    sig_dec = str_cnt
 
    if (sig_dig = 7 and str_cnt = 7)
      dsValue  = "n/a"
    else
      len     = movestring(strfld,sig_dig+1,move_fld,1,sig_dec-sig_dig),
      dsValue  = trim(move_fld)
      if (substring(1,1,dsValue) = ".")
        dsValue  = concat("0",trim(move_fld))
      endif
    endif
 
  endmacro
 
  macro (parse_medlist)
    s_pos = 1
    e_pos = size(trim(parse_med))
    c_line = fillstring(82," ")
    t_pos = 0
    l_pos = 1
 
    while (e_pos >= s_pos)
      t_pos = s_pos + 082
      while (substring(t_pos,1,parse_med) != " " and t_pos > s_pos)
        t_pos = t_pos - 1
      endwhile
      if(t_pos = s_pos)
        t_pos = s_pos + 082
      endif
      c_line = substring(s_pos,t_pos-s_pos,parse_med)
      if (l_pos >= 2)
        col 051, c_line, row + 1
      else
        col 041, c_line, row + 1
        l_pos = 2
      endif
      s_pos = t_pos + 1
    endwhile
  endmacro
 
  macro (parse_comment)
    s_pos = 1
    e_pos = size(trim(parse_str))
    c_line = fillstring(82," ")
    t_pos = 0
 
    while (e_pos >= s_pos)
      t_pos = s_pos + 82
      while (substring(t_pos,1,parse_str) != " " and t_pos > s_pos)
        t_pos = t_pos - 1
      endwhile
      if(t_pos = s_pos)
        t_pos = s_pos + 82
      endif
      c_line = substring(s_pos,t_pos-s_pos,parse_str)
      col 051, c_line, row + 1
      s_pos = t_pos + 1
    endwhile
  endmacro
 
head page
  "{lpi/7}{cpi/13}{f/24}", row + 1
  box_str   = fillstring(999," ")
  row 2
 
if (curpage = 1)
  row 1
  col 085, "Sent to Outpatient Pharmacy: Date _______ Time_______ Init_______", row + 2
endif
 
if (last_page = 0)
  "{lpi/6}{cpi/13}{f/24}"
  row + 1
  col 060,
  "{B}CHILDREN'S HOSPITALS AND CLINICS OF MINNESOTA{ENDB}"
  row + 1
  "{B}", call center(cnvtupper(fac_street), 1, 196), "{ENDB}"
  row + 1
  "{B}", call center(cnvtupper(fac_city_state_zip), 1, 196), "{ENDB}"
  row + 2
  col 069,
  "{B}DISCHARGE MEDICATION ORDER FORM{ENDB}"
  row + 2
  col 025, line2
  row + 1
 
  col 025, "{B}", name, "{ENDB}",
  col 085, "DOB: ", dob
  col 110, "Weight: ", wght
  col 140, "Location: ", current_loc
  row + 1
  col 025, "{B}", home_addr, "{ENDB}", row + 1
  row - 1
  col 100, "MRN: ", mrn,
  col 128, "FIN: ", fin
  row + 1
 
  col 025, "Attending Provider: ", attending_provider
  row + 1
 
  aller_d = fillstring (100," ")
  aller_d = "Allergies: ",
    if (t_rec->allergy_cnt >= 1)
      for (k = 1 to t_rec->allergy_cnt)
        if (size(trim(aller_d)) + size(trim(t_rec->allergy[k]->allergy_desc)) > 98)
          col 025, aller_d, row + 1
          aller_d = fillstring(100," ")
        endif
        aller_d = concat(trim(aller_d)," ",trim(t_rec->allergy[k]->allergy_desc))
        if (k < t_rec->allergy_cnt)
          aller_d = concat(trim(aller_d),", ")
        endif
      endfor
    elseif (t_rec->allergy_cnt = 0)
      aller_d = concat(trim(aller_d),"No allergies on file")
    endif
    col 025, aller_d
 
  if (curpage = 1)
    row + 2
    col 025, "Estimated Discharge Date _______ Time_______ Init_______ ",
             "Completeness Verified By: ___________________", row + 1
  else
    row + 1
  endif
  col 25, LINE2, row + 2
 
  if (t_rec->ord_cnt = 0 and t_rec->ezscript_cnt = 0)
    col 025, "{B}There are no active medication orders for this patient.{ENDB}"
  else
    col 025, "{B}Select [X] only the medications to be continued:{ENDB}", row + 2
  endif
 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;Multiple pages header
  if (curpage >= 1)
    page_ind = 1
    col 025,
    "{B}"
 
    if (ez_order = 0 and t_rec->ord_cnt > 0)
      if (od_ord_type != 2 and od_ord_sort < 5)
        if (o_prn_ind = 0)
          if (ipsched_header_printed = 1)
            "INPATIENT SCHEDULED MEDICATIONS CONTINUED "
          else
            "INPATIENT SCHEDULED MEDICATIONS"
            ipsched_header_printed = 1
          endif
        else
          if (ipprn_header_printed = 1)
            "INPATIENT PRN MEDICATIONS CONTINUED"
          else
            "INPATIENT PRN MEDICATIONS"
            ipprn_header_printed = 1
          endif
        endif
                                                   ;      elseif (od_ord_type = 3)
                                                   ;        "CONTINUOUS INFUSIONS CONTINUED "
      elseif (od_ord_sort = 9)
        col 025,
        if (ipcont_header_printed = 1)
          "{B}INPATIENT CONTROLLED SUBSTANCE [CII] MEDICATIONS CONTINUED{ENDB}"
        else
          "{B}INPATIENT CONTROLLED SUBSTANCE [CII] MEDICATIONS{ENDB}"
          cii_page_flag = 1
          ipcont_header_printed = 1
        endif
      endif
 
    row + 2
    col 025, "{B}Started"
    col 040, "{B}Medication{ENDB}"
    row + 2
    endif
 
    if (ez_order = 1)
      if (header_printed = 1)
        "HOME MEDICATIONS/PRESCRIPTIONS CONTINUED", row + 2
        row + 2
        col 025, "{B}Started"
        col 040, "{B}Medication{ENDB}"
        row + 2
      endif
    endif
 
 
  endif
endif         ;(last_page = 0)

;End of multiple pages header
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
head name
  dummyvar = 0
 
 
head od_ord_sort
 
  if (t_rec->ord_cnt = 0 and t_rec->ezscript_cnt > 0)
    col 025, "{B}There are no inpatient medications for this patient.{ENDB}"
    cii_page_flag = 1
    break
  endif
 
  if (od_ord_sort = 2 and ipprn_header_printed = 0)
    row + 3
    col 025, "{B}INPATIENT PRN MEDICATIONS{ENDB}", row + 2
    ipprn_header_printed = 1
    cii_page_flag = 0
  endif
 
  if (od_ord_sort = 9 and ipcont_header_printed = 0)
    break
    cii_page_flag = 1
  endif
 
head oid
  tot_vol = fillstring(20," ")
  rate = fillstring(20," ")
  rate_u = fillstring(20," ")
  freq_s = fillstring(30," ")
  route = fillstring(20," ")
  infuse = fillstring(20," ")
  infuse_u = fillstring(20," ")
  duration = 0
  duration_u = fillstring(20," ")
  ft_rate = fillstring(20," ")
  titrate_ind = 0
 
  if (t_rec->ord_cnt > 0)
    col 015, "{BOX/1/0}", row + 1
  endif
 
head oi_comp_seq
  if (t_rec->ord_cnt > 0)
    ing_line = fillstring(150,' ')
    dose_s = fillstring(30,' ')
 
    if (oi_freetxt_dose = null)
      if (oi_strength > 0)
        pass_field_in = oi_strength
        parse_zeroes
        dose_s = concat(trim(dsvalue), ' ', oi_strength_unit)
      endif
 
      if (oi_volume > 0 and (od_ord_type = 1 or oi_strength = 0))
        if (oi_strength > 0)
          dose_s = concat(trim(dose_s),'/')
        endif
 
        pass_field_in = oi_volume
        parse_zeroes
        dose_s = concat(trim(dose_s),trim(dsvalue), ' ', oi_volume_unit)
      endif
    else
      dose_s = oi_freetxt_dose
    endif
 
    if (oi_comp_seq = 1)
      margin = 24
    else
      margin = 25
    endif
 
    if (op_tnf_id > 0)
      ing_line = tnf_desc
    else
      if(brd_val > " ")
        ing_line = concat(trim(o_mnem), " (", trim(brd_val), ")")
      else
        ing_line = trim(o_mnem)
      endif
    endif
 
    if (od_ord_type = 1)
      ing_line = trim(ing_line)
    elseif (oi_comp_seq > 1)
      ing_line = substring(1,39,ing_line)
    endif
 
  endif
 
detail
  case (ord_oe_field_mean)
    of "TOTALVOLUME":		pass_field_in = ord_oe_field_value,
      				parse_zeroes,
      				tot_vol = dsValue
    of "RATE":			rate = cnvtstring(ord_oe_field_value)
    of "RATEUNIT":      	rate_u = ord_oe_field_display_value
    of "FREQ":                  freq_s = ord_freq
    of "RXROUTE":               route = ord_route
    of "INFUSEOVER":    	infuse = cnvtstring(ord_oe_field_value)
    of "INFUSEOVERUNIT":	infuse_u = ord_oe_field_display_value
    of "DURATION":              duration = ord_oe_field_value
    of "DURATIONUNIT":          duration_u = ord_oe_field_display_value
    of "TITRATEIND":            titrate_ind = ord_oe_field_value
    of "FREETEXTRATE":          ft_rate = ord_oe_field_display_value
  endcase
 
foot oid
  sig_line = fillstring(150,' ')
  parse_str = ""
  parse_med = ""
 
  if (od_ord_type = 1)
    sig_line = concat(trim(dose_s),' ',trim(route),' ',trim(freq_s))
    sig_line =  concat("{B}",trim(ing_line),"{ENDB} ", trim(sig_line))
    row - 1
    col 028, o_ord_start_dt
    col 041,
    if (sig_line > "")
      parse_med = sig_line
      parse_medlist
    endif
  endif
 
  if (o_comment > "")
    parse_str = o_comment
    parse_comment
  endif
 
 
  if (t_rec->ord_cnt > 0)
    col 051, "Change to: ",
             "________________________________________________ Disp:________ Refills: _____", row + 1
 
    if (row > 48) ;007 and curendreport = 0)
      	break
    endif
  endif
 

foot name
  minor_consent_fnd = 0
  cont_sub_fnd = 0
  ez_order = 1
 
  if (t_rec->ord_cnt > 0)
    break
  endif
 
  if (t_rec->ezscript_cnt > 0)
    for (h = 1 to 2)
      header_printed = 0

      if (h=2 and cont_sub_fnd = 1)
         break
         col 025, "{B}HOME/PRESCRIPTION CONTROLLED SUBSTANCE [CII] MEDICATIONS{ENDB}"
         cii_page_flag = 1
         row + 2
         col 026, "{B}Started"
         col 040, "{B}Medication{ENDB}"
         row + 2
      endif
 
 
      for (i = 1 to t_rec->ezscript_cnt)
        if (t_rec->ezscript[i].ez_type = 2)
          if (t_rec->ezscript[i].cont_sub = 0)
            minor_consent_fnd = 1
          elseif (t_rec->ezscript[i].cont_sub = 1)
            cont_sub_fnd = 1
          endif
        endif
 
        if ((h = 1 and t_rec->ezscript[i].ez_type < 2)
          or  (h = 2 and t_rec->ezscript[i].ez_type = 2))
 
          if (row > 50) ; and curendreport = 0)
            break
          elseif (t_rec->ezscript.ez_order_sort = 4 and header_printed = 0 and cont_sub_fnd = 0)
            col 025,
            "{B} HOME MEDICATIONS/PRESCRIPTIONS {ENDB}"
            row + 2
            col 025, "{B}Started"
            col 040, "{B}Medication{ENDB}"
            cii_page_flag = 0
            row + 2
 
            if (t_rec->ord_cnt > 0 and t_rec->ezscript_cnt = 0)
              col 025, "{B}There are no home medications/prescriptions for this patient.{ENDB}"
            endif
            header_printed = 1
          endif
 
          ez_o_mnem         = trim(t_rec->ezscript[i]->o_mnem)
          ez_o_as_mnem      = trim(t_rec->ezscript[i]->o_as_mnem)
          ez_o_ord_start_dt = t_rec->ezscript[i]->o_ord_start_dt
          ez_mnem           = concat(trim(ez_o_mnem), " (", trim(ez_o_as_mnem), ")")
          ez_start_dt       = ez_o_ord_start_dt
          ez_ord_comment    = t_rec->ezscript[i]->o_comment
 
 
          if (t_rec->ezscript_cnt > 0)
            col 015, "{BOX/1/0}"
            row + 1
          endif
 
          row - 1
          col 028, ez_start_dt
          col 041,  "{B}", ez_mnem, "{ENDB}"
          row + 1
 
          freq_e = fillstring(50,"")
          route = fillstring(18,"")
          ft_dose = fillstring(30,"")
          vol_dose = fillstring(8,"")
          vol_dose_u = fillstring(10,"")
          str_dose = fillstring(8,"")
          str_dose_u = fillstring(10,"")
          prn_inst = fillstring(200,"")
          spec_inx = fillstring(200,"")
          do_not_print = fillstring(80,"")
          indication = fillstring(80,"")
 
          for (j = 1 to t_rec->ezscript[i]->od_det_cnt)
            ez_ord_oe_field_mean = t_rec->ezscript[i]->od_det[j]->ord_oe_field_mean
            ez_ord_oe_field_value = t_rec->ezscript[i]->od_det[j]->ord_oe_field_value
            ez_ord_oe_field_display_value=t_rec->ezscript[i]->od_det[j]->ord_oe_field_display_value
 
            ez_sig_line = fillstring(2000," ")
 
            case (ez_ord_oe_field_mean)
              of "FREQ":              freq_e = t_rec->ezscript[i]->od_det[j]->ord_oe_field_def
              of "RXROUTE":           route = t_rec->ezscript[i]->od_det[j]->ord_oe_field_def
              of "FREETXTDOSE":       ft_dose = ez_ord_oe_field_display_value
              of "VOLUMEDOSE":        vol_dose = ez_ord_oe_field_display_value
              of "VOLUMEDOSEUNIT":    vol_dose_u = ez_ord_oe_field_display_value
              of "STRENGTHDOSE":      str_dose = ez_ord_oe_field_display_value
              of "STRENGTHDOSEUNIT":  str_dose_u = ez_ord_oe_field_display_value
              of "PRNINSTRUCTIONS":   prn_inst =ez_ord_oe_field_display_value
              of "SPECINX":           spec_inx = ez_ord_oe_field_display_value
              of "DONTPRINTRXREASON": do_not_print = ez_ord_oe_field_display_value
              of "INDICATIONS":       indication = ez_ord_oe_field_display_value
            endcase
	  endfor	; j loop
 
            if (t_rec->ezscript[i].ez_type = 0)
              ez_sig_line = "(Hx)"
            elseif (t_rec->ezscript[i].ez_type in (1,2))
              if (do_not_print in("current medication from another provider",
                                  "past medication from another provider"))
                ez_sig_line = "(Hx)"
              else
                ez_sig_line = "(Rx)"
              endif
            endif
 
            if (t_rec->ezscript[i].ez_type = 0)
              ez_sig_line = concat("(Hx)", trim(t_rec->ezscript[i].ret_sig))
            elseif (t_rec->ezscript[i].ez_type in (1,2))
              if (trim(ft_dose) = "")
                if(str_dose > "")
                  ez_sig_line = concat(trim(ez_sig_line), trim(str_dose), " ", trim(str_dose_u))
                endif
 
                if (str_dose > "" and vol_dose > "")
                  ez_sig_line = concat(trim(ez_sig_line), "/")
                endif
 
                if (vol_dose > "")
                  ez_sig_line = concat(trim(ez_sig_line), trim(vol_dose)," ", trim(vol_dose_u))
                endif
 
                ez_sig_line = concat(trim(ez_sig_line), " ", trim(route), " ", trim(freq_e))
 
              else
                ez_sig_line = concat(trim(ez_sig_line), trim(ft_dose), " ", trim(route), " ", trim(freq_e))
              endif
            endif
 
            parse_str = ""
 
            if(ez_sig_line > "")
              parse_str = ez_sig_line
              parse_comment
            endif
 
            parse_str = ""
 
            if(prn_inst > "")
              parse_str = prn_inst
              parse_comment
            endif
 
            parse_str = ""
 
            if (spec_inx > "")
              parse_str = spec_inx
              parse_comment
            endif
 
            if (ez_ord_comment > "")
              parse_str = ez_ord_comment
              parse_comment
            endif
 
            parse_str = ""
 
            col 051, "Change to: ",
               "________________________________________________ Disp:________ Refills: _____", row + 1
        endif  ; if h = 1 or h = 2
      endfor   ; i loop
    endfor ; h loop
  elseif (t_rec->ord_cnt > 0)
    col 025, "{B}There are no home medication/prescription orders for this patient.{ENDB}"
  endif   ; if t_rec->ezscript_cnt > 0
 
foot page
  row + 1
  "{f/0/1}{lpi/6}{cpi/18}",
  x = 1
 
  for (y = 84 to size(trim (box_str),1) by 84)
     	temp = fillstring (85," ")
     	temp = substring(x,y,box_str)
     	temp, row + 1
     	x = y+1
  endfor
 
  temp = fillstring (85," ")
  temp = concat(trim(substring(x,x+84,box_str)),"{f/0/1}{lpi/8}{cpi/14}")
  temp
  row + 1
 
  if (curpage = 1)
    "{pos/77/630}" row + 0
    col 011 "______________________________________"
    col 054 "_________________"
    col 083 "_________________"
    row + 1
    col 012 "Prescriber Signature"
    col 055 "Phone"
    col 084 "Date"
    row + 2
 
    col 012 "______________________________________"
    col 055 "____________________"
    row +1
    col 012 "Print Name"
    col 055, "DEA ",
    row + 1
    if (cii_page_flag = 0)
      col 055,
      "{B}Note: CII Medications must be written separately{ENDB}"
    endif
    row + 3
  else
    "{pos/77/648}" row + 0
    col 011 "______________________________________"
    col 054 "_________________"
    col 083 "_________________"
    row + 1
    col 012 "Prescriber Signature"
    col 055 "Phone"
    col 084 "Date"
    row + 2
 
    col 012 "______________________________________"
    col 055 "____________________"
    row +1
    col 12 "Print Name"
    col 55 "DEA ",
    row + 1
    if (cii_page_flag = 0)
      col 055,
      "{B}Note: CII Medications must be written separately{ENDB}"
    endif
    row + 1
  endif
 
  if (curpage = 1)
    row - 1
    col 12,
    "__________________________________________________________________________________________",
    row + 2
    col 012,
    "{B}Route ORIGINAL to : ___Retail Pharmacy    Route COPY to: ___Decentral Pharmacist ___Chart {ENDB}"
    row + 1
    col 012,
    "Medical Records: Fax copy to Primary Provider", row + 1
    col 090,
    "Page: ", curpage"##;L;I", row + 1
    col 012, "Run Date: ", rundate, row + 1
  else
    col 90 "Page: ", curpage"##;L;I", row + 1
  endif
 
foot report
  last_page = 1
  if (curendreport = 1)
    break
    row 2
 
    "{lpi/6}{cpi/13}{f/24}"
    row + 1
    col 060, "{B}CHILDREN'S HOSPITALS AND CLINICS OF MINNESOTA{ENDB}"
    row + 1
    "{B}", call center(cnvtupper(fac_street), 1, 196), "{ENDB}"
    row + 1
    "{B}", call center(cnvtupper(fac_city_state_zip), 1, 196), "{ENDB}"
    row + 2
 
    col 051, "{B} CURRENT MEDICATION PROFILE - MEDICATION ORDER FORM {ENDB}"
    row + 2
    col 025, line2
    row + 1
 
    col 025, "{B}", name, "{ENDB}",
    col 085, "DOB: ", dob
    col 110, "Weight: ", wght
    col 140, "Location: ", current_loc
    row + 1
    col 025, "{B}", home_addr, "{ENDB}", row + 1
    row - 1
    col 100, "MRN: ", mrn,
    col 128, "FIN: ", fin
    row + 1
 
    col 025, "Attending Provider: ", attending_provider
    row + 1
 
    aller_d = fillstring (100," ")
    aller_d = "Allergies: ",
      if (t_rec->allergy_cnt >= 1)
        for (k = 1 to t_rec->allergy_cnt)
          if (size(trim(aller_d)) + size(trim(t_rec->allergy[k]->allergy_desc)) > 98)
            col 025, aller_d, row + 1
            aller_d = fillstring(100," ")
          endif
          aller_d = concat(trim(aller_d)," ",trim(t_rec->allergy[k]->allergy_desc))
          if (k < t_rec->allergy_cnt)
            aller_d = concat(trim(aller_d),", ")
          endif
        endfor
      elseif (t_rec->allergy_cnt = 0)
        aller_d = concat(trim(aller_d),"No allergies on file")
      endif
      col 025, aller_d
    row + 1
 
    col 025, LINE2, row + 2
    col 025
    "{B}", "NEW PRESCRIPTIONS", "{ENDB}"
    row + 2
 
    n = 1
    while (n < 6)
      col 025, "{B}DRUG:  {ENDB}",
               "___________________________________________________________________________________________"
      row + 1
      col 025, "{B}Sig:  {ENDB}",
               "______________________________________________________________________________________________"
      row + 1
      col 025, "{B}Special instructions: {ENDB}",
               "______________________________________________________________________________"
      row + 1
      col 025, "{B}Duration: ________________",
                  "Dispense: ________________  Refills: ________________{ENDB}"
      row + 3
      n = n + 1
    endwhile
 
    "{lpi/8}{cpi/14}{f/0}"
    row + 4
    col 013 "______________________________________"
    col 054 "_______________________"
    col 083 "_________________"
    row + 1
    col 013 "Prescriber Signature"
    col 054 "Phone"
    col 083 "Date"
    row + 2
 
    col 013 "______________________________________"
    col 054 "_______________________"
    row +1
    col 013 "Print Name"
    col 054 "DEA ",
    row + 1

    if (cii_page_flag = 0)
      col 053, "{B} Note: CII Medications must be written separately {ENDB}"
    endif

    row + 3
 
  endif
 
  call center("<End of Report>", 1, 98)
 
with 	  nocounter
	, maxcol = 1000
	, maxrow = 80
	, dio=POSTSCRIPT
	, nullreport
 
if (t_rec->asthma_flag = 1)
 set spool="cust_script1:kids_asthma_act_plan.ps" value(io)
endif
 
if (curqual = 0)
    if ((t_rec->ord_cnt = 0) and (t_rec->ezscript_cnt = 0))
      set reply->status_data.status = "F"
   else
      set reply->status_data.status = "Z"
   endif
 
   set reply->status_data->subeventstatus[1]->OperationName = "PRINT"
else
  set reply->status_data->status = "S"
endif
 
 
end
go

########################################################################################################################################################

AGENDA

Inpatient Discussion
Pharmacist enters Medication Order
Pharmacist enters Intermittent Order
Pharmacist enters Continuous (LVP) Order
Pharmacist enters a Medication Order, with Multiple Products

Pharmacist modifies Medication Order
Nurse reschedules Medication Order
Nurse administers Medication Order
Pharmacist dispenses Medication Order – Initial Dose
Pharmacy Technician credits Medication Order
Pharmacist dispenses Medication Order – Fill batch

Retail Discussion
Physician enters Medication Order
Pharmacist dispenses Medication Order, accepted Claim.
Pharmacist Cancel Fills Medication Order
Pharmacist refills order, accepted Claim.
Pharmacist refills order, Health Plan is not adjudicated.

Other Topics
PharmNet PowerVision tables
Procure tables
Multum tables


 
Inpatient
Pharmacist enters Medication Order
Orders (One row per Parent order, and one row per exploded dose)
Primary Access: Order_id
Field Discussion:
Catalog_cd, Catalog_type_cd, Activity_type_cd
Current_start_dt_tm, Projected_stop_dt_tm
Order_Status_cd
Ingredient_ind = 0
Orig_order_as_flag (0 – Normal, 1 – Prescription, 2 – Historical,
4 – Charge Only, 5 – Superbill)
Clinical_display_line
Need_rx_verify_ind, Need_nurse_review_ind, Need_doctor_cosign_ind
Last_action_sequence, Last_ingred_action_sequence
Parent Order -> Template_order_flag = 0 or 1,
Template_order_id = 0
Child Order -> Template_order_flag = 4, Template_order_id =
Parent Order_id, Current_start_dt_tm = Dose Dt/Tm

Order_action (One row per action)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_type_cd
Action_dt_tm
Action_personnel_id

Order_dispense (One row per Parent order)
Primary Access: Order_id
Field Discussion:
Pharm_type_cd “INPATIENT” (CS 4500)
Ord_type_flag = 1
Last_ver_act_seq
Last_ver_ingr_seq

Order_detail (One row per field)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id

Order_comment (One row per Comment_type_cd)
Primary Access: Order_id, Action_sequence
		Field Discussion:
			Comment_type_cd
			Long_text_id
 

Order_ingredient (One row ingredient, which for Meds is 1)
Primary Access: Order_id, Action_sequence, Comp_sequence
Field Discussion:
Catalog_cd, Synonym_id
Strength, Strength_unit, Volume, Volume_unit, Freetext_dose
Freq_cd, Iv_seq
Ordered_as_mnemonic
Ingredient_type_flag (0,1 – Medication, 2 – Base, 3 – Additive)
Ordered_dose
Ordered_dose_unit_cd

Order_product (One row per ingredient)
Primary Access: Order_id, Action_sequence, Ingred_sequence
Field Discussion:
	Item_id
Tnf_id
Dose_quantity
Dose_quantity_unit_cd

Template_nonformulary (One row per TNF product. Written out for TNF
product.)
	Primary Access: Tnf_id, Order_id, Action_sequence
	Field Discussion:
		Tnf_id
		Description
		Cost
		NDC
		Shell_item_id
		
Task_activity (One row per Child Order row)
Primary Access: Order_id
Field Discussion:
Task_dt_tm = Dose Date/Time
Task_type_cd = Medication

 

Pharmacist enters Intermittent Order
Orders
Field Discussion:
Ingredient_ind = 1 (If one Order_ingredient row exists, then 0.
If more than one Order_ingredient row exists, then 1)

Order_dispense
Field Discussion:
Ord_type_flag = 3

Order_ingredient (One row ingredient, which for Intermittents is one or more)


Pharmacist enters Continuous Order
Orders
Field Discussion:
Ingredient_ind = 1 (If one Order_ingredient row exists, then 0.
If more than one Order_ingredient row exists, then 1)

Order_dispense
Field Discussion:
Ord_type_flag = 2

Order_ingredient (One row ingredient, which for Continuous (LVP) is one or more)


Pharmacist enters a Medication Order, with Multiple Products

Orders
Field Discussion:
Ingredient_ind = 1 (If one Order_ingredient row exists, then 0.
If more than one Order_ingredient row exists, then 1)

Order_dispense
Field Discussion:
Ord_type_flag = 1

Order_product (Many Order_product rows per Order_ingredient row)

 

Pharmacist modifies Medication Order
Orders (One row per Parent order, and one row per exploded dose)
Primary Access: Order_id
Field Discussion:
Last_action_sequence, Last_ingred_action_sequence -> Updated
to new action sequence
Child Order -> Updated with new information

Order_action (One row per action)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_sequence -> Updated to new action sequence

Order_dispense (One row per Parent order)
Primary Access: Order_id
Field Discussion:
Last_ver_act_seq
Last_ver_ingr_seq -> Updated to new action sequence

Order_detail (One row per field)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id -> Only modified fields are written out.

Order_comment (One row per Comment_type_cd)
Primary Access: Order_id, Action_sequence
		Field Discussion:
			Comment_type_cd
			Long_text_id -> Only written out if Comments are updated.

Order_ingredient (One row ingredient, which for Meds is 1)
Primary Access: Order_id, Action_sequence, Comp_sequence
Field Discussion:
Catalog_cd, Synonym_id -> Always written for Modify.

Order_product (One row per ingredient)
Primary Access: Order_id, Action_sequence, Ingred_sequence
Field Discussion:
	Item_id -> Always written out for Modify.

Template_nonformulary (One row per TNF product)
	Primary Access: Tnf_id, Order_id, Action_sequence
	Field Discussion:
		Tnf_id -> Written out for TNF product.
 
		
Task_activity (One row per Child Order row)
Primary Access: Order_id
Field Discussion:
Task_dt_tm = Dose Date/Time -> All future tasks are canceled,
and new ones are written out.  All past tasks are not
updated.


Nurse reschedules Medication Order
Orders (One row per Parent order, and one row per exploded dose)
Primary Access: Order_id
Field Discussion:
Last_action_sequence, Last_ingred_action_sequence -> Updated
to new action sequence

Order_action (One row per action)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_sequence -> Updated to new action sequence

Order_dispense (One row per Parent order)
Primary Access: Order_id
Field Discussion:
Last_ver_act_seq -> Updated to new action sequence
Last_ver_ingr_seq -> NOT UPDATED

Order_detail (One row per field)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id -> Only modified fields are written out.
		
Task_activity (One row per Child Order row)
Primary Access: Order_id
Field Discussion:
Task_dt_tm = Dose Date/Time -> All future tasks are canceled,
and new ones are written out.  All past tasks are not
updated.

 

Nurse administers Medication Order
Clinical_event (Two rows per Child Order row)
Primary Access: Order_id, View_level = 1 (This will limit the select to the
Correct single row)
Field Discussion:
Result_val = Documented Dose Amount
Result_units_cd = Documented Dose Unit Cd
Catalog_cd
Result_status_cd

Ce_med_result
Primary Access: Event_id from Clinical_event
Field Discussion:
Admin_note
Admin_route_cd
Admin_site_cd
Admin_dosage
Dosage_unit_cd


Pharmacist dispenses Medication Order – Initial Dose
Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = INITIALDOSE (CS 4032)
Doses
Event_total_price
First_dose_time
Charge_ind
Dispense_dt_tm
Pharm_type_cd = INPATIENT (CS 4500)
Disp_loc_cd

Prod_dispense_hx
Primary Access: Dispense_hx_id
Field Discussion:
Item_id
Tnf_id
Manf_item_id
Charge_qty
Cost
Price
Price_sched_id
 

Charge_event
		Primary Access: Ext_m_event_id = pdh.dispense_hx_id,
Ext_m_event_cont_cd = DISP ID (CS 13016),

If Manf_item_id > 0
Ext_i_event_id = pdh.dispense_hx_id,
Ext_i_event_cont_cd = DISP ID (CS 13016),
Ext_i_reference_id = pdh.manf_item_id,
Ext_i_reference_cont_cd = MANF ITEM
(CS 13016)

If Tnf_id > 0
Ext_i_event_id = pdh.tnf_id,
Ext_i_event_cont_cd = TNF_MED (CS 13016),
Ext_i_reference_id = 1,
Ext_i_reference_cont_cd = TNF_MED (CS 13016)

Field Discussion:
Charge_item_id

Charge
		Primary Access: Charge_item_id
		Field Discussion:
			Charge_description
			Price_sched_id
			Item_quantity
			Item_price
			Item_extended_price

Interface_charge
		Primary Access: Charge_item_id
		Field Discussion:

Mm_trans_header
Primary Access: Parent_entity_name (“DISPENSE_HX”),
Parent_entity_id = Dispense_hx_id
Field Discussion:
	Transaction_id
 

Mm_trans_line
Primary Access: Transaction_id
Field Discussion:
	Trans_status_cd
Item_id
Item_desc
From_trans_qty
From_qty_unit_cost
From_location_cd
From_qoh_new
Reason_cd


Pharmacy Technician credits Medication Order
Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = MANUALCREDIT (CS 4032)
Doses
Event_total_price
Charge_ind
Dispense_dt_tm
Pharm_type_cd = INPATIENT (CS 4500)
Chrg_dispense_hx_id

Prod_dispense_hx
Primary Access: Dispense_hx_id
Field Discussion:
Item_id
Tnf_id
Manf_item_id
Credit_qty
Cost
Price
Price_sched_id
 

Pharmacist dispenses Medication Order – Fill List
Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = FILLLIST (CS 4032)
Doses
Event_total_price
First_dose_time
Charge_ind
Dispense_dt_tm
Pharm_type_cd = INPATIENT (CS 4500)
Disp_loc_cd
Fill_hx_id
Run_user_id
 

Retail
Physician enters Medication Order
Orders (One row per Parent order)
Primary Access: Order_id
Field Discussion:
Catalog_cd, Catalog_type_cd, Activity_type_cd
Current_start_dt_tm, Projected_stop_dt_tm
Order_Status_cd
Ingredient_ind = 0
Orig_order_as_flag (1 – Prescription, 2 – Historical)
Clinical_display_line
Last_action_sequence, Last_ingred_action_sequence

Order_action (One row per action)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_type_cd
Action_dt_tm
Action_personnel_id

Order_detail (One row per field)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id

Order_comment (One row per Comment_type_cd)
Primary Access: Order_id, Action_sequence
		Field Discussion:
			Comment_type_cd
			Long_text_id

Order_ingredient (One row ingredient, which for Meds is 1)
Primary Access: Order_id, Action_sequence, Comp_sequence
Field Discussion:
Catalog_cd, Synonym_id
Strength, Strength_unit, Volume, Volume_unit, Freetext_dose

 

Pharmacist dispenses Retail Medication Order, accepted Claim.
Orders (One row per Parent order)
Primary Access: Order_id
Field Discussion:
Catalog_cd, Catalog_type_cd, Activity_type_cd
Current_start_dt_tm, Projected_stop_dt_tm
Order_Status_cd
Ingredient_ind = 0, Compounds will be 1.
Orig_order_as_flag (1 – Prescription, 2 – Historical)
Clinical_display_line
Last_action_sequence, Last_ingred_action_sequence

Order_dispense (One row per Parent order)
Primary Access: Order_id
Field Discussion:
	Pharm_type_cd = RETAIL (CS 4500)
	Rx_nbr
	Rx_nbr_cd
	Fill_nbr
Last_ver_act_seq
Last_ver_ingr_seq
Last_refill_dt_tm

Order_action (One row per action)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_type_cd
Action_dt_tm
Action_personnel_id

Order_detail (One row per field)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id

Order_comment (One row per Comment_type_cd)
Primary Access: Order_id, Action_sequence
		Field Discussion:
			Comment_type_cd
			Long_text_id

Order_health_plan
Primary Access: Order_id, Action_sequence, Health_plan_id
Field Discussion:
All fields from Claims within Order Entry

Order_health_plan_detail
Primary Access: Order_id, Action_seq, Health_plan_id
	Field Discussion:
		Detail_field_ident

Order_ingredient (Meds will have one row,
Compounds will have multiple rows)
Primary Access: Order_id, Action_sequence, Comp_sequence
Field Discussion:
Catalog_cd, Synonym_id
Strength, Strength_unit, Volume, Volume_unit, Freetext_dose
Ingredient_type_flag (0, 1 – Medication, 4 – Compound Parent,
5 – Compound Child)

Order_product (One row per ingredient)
Primary Access: Order_id, Action_sequence, Ingred_sequence
Field Discussion:
	Item_id
	Med_product_id
	Label_desc
	Brand_desc
	Generic_desc
	Drug_identifier
	Disp_qty
	Disp_qty_unit_cd

Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = DISPENSE (CS 4032)
Reimbursement
Copay
Disp_priority_dt_tm
Charge_ind
Fill_nbr
Pharm_type_cd = RETAIL (CS 4500)
Disp_sr_cd
Cost
Disp_qty
Disp_qty_unit_cd
 

Prod_dispense_hx
Primary Access: Dispense_hx_id
Field Discussion:
Item_id
Manf_item_id
Charge_qty
Cost
Price
Dispense_qty
Charge_ind

Charge_event
		Primary Access: Ext_m_event_id = pdh.dispense_hx_id,
Ext_m_event_cont_cd = DISP ID (CS 13016),
Ext_i_event_id = pdh.dispense_hx_id,
Ext_i_event_cont_cd = DISP ID (CS 13016),
Ext_i_reference_id = pdh.manf_item_id,
Ext_i_reference_cont_cd = MANF ITEM (CS 13016)

Field Discussion:
Charge_item_id

Charge
		Primary Access: Charge_item_id
		Field Discussion:
			Charge_description
			Price_sched_id
			Item_quantity
			Item_price
			Item_extended_price

Interface_charge
		Primary Access: Charge_item_id
		Field Discussion:

Mm_trans_header
Primary Access: Parent_entity_name (“DISPENSE_HX”),
Parent_entity_id = Dispense_hx_id
Field Discussion:
	Transaction_id
 

Mm_trans_line
Primary Access: Transaction_id
Field Discussion:
	Trans_status_cd
Item_id
Item_desc
From_trans_qty
From_qty_unit_cost
From_location_cd
From_qoh_new
Reason_cd

Rx_claim
Primary Access: Dispense_hx_id
Field Discussion:
Claim_format_cd        
Claim_format_type_cd   
Health_plan_id         
Ttrans_dt_tm           
Claim_trans_cd          
Claim_status_cd        
Switch_cd              
Subsection_cd          
Level5_cd              
Claim_text_id               
Response_text_id           
Active_ind                  
System_err_cd              
Unclaimed_ind               
Dur_ind                     
Print_flag                  
Reimbursement_amt           
Copay_amt                   
Authorization_nbr_txt   

 

Pharmacist Cancel Fills Medication Order
Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = CANCELFILL (CS 4032)
Chrg_dispense_hx_id = Dispense_hx_id from DISPENSE event

Prod_dispense_hx
Primary Access: Dispense_hx_id
Field Discussion:
Item_id
Manf_item_id
Credit_qty
Cost
Price
Dispense_qty
Charge_ind

Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = DISPENSE (CS 4032)
Chrg_dispense_hx_id = Dispense_hx_id from
CANCELFILL event


Pharmacist refills order, accepted Claim.
Orders
Primary Access: Order_id
Field Discussion:
Last_action_sequence, Last_ingred_action_sequence

Order_dispense (One row per Parent order)
Primary Access: Order_id
Field Discussion:
	Fill_nbr
Last_ver_act_seq
Last_ver_ingr_seq
Last_refill_dt_tm
 

Order_action (New Action_sequence)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_type_cd = REFILL (CS 6003)
Action_dt_tm
Action_personnel_id

Order_detail (Only fields which changed are written out)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id

Order_comment (If comments change, then rows are written out)
Primary Access: Order_id, Action_sequence

Order_health_plan (Only fields that change are written out)
Primary Access: Order_id, Action_sequence, Health_plan_id
Field Discussion:
All fields from Claims within Order Entry

Order_health_plan_detail (Only fields that change are written out)
Primary Access: Order_id, Action_seq, Health_plan_id
	Field Discussion:
		Detail_field_ident

Order_ingredient (Meds will have one row,
Compounds will have multiple rows)
Primary Access: Order_id, Action_sequence, Comp_sequence
Field Discussion:
Catalog_cd, Synonym_id

Order_product (One row per ingredient)
Primary Access: Order_id, Action_sequence, Ingred_sequence
Field Discussion:
	Item_id
	Med_product_id

Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = DISPENSE (CS 4032)

Prod_dispense_hx
Primary Access: Dispense_hx_id
 

Charge_event
Primary Access: Same as above

Charge
		Primary Access: Charge_item_id

Interface_charge
		Primary Access: Charge_item_id

Mm_trans_header
Primary Access: Parent_entity_name (“DISPENSE_HX”),
Parent_entity_id = Dispense_hx_id

Mm_trans_line
Primary Access: Transaction_id

Rx_claim
Primary Access: Dispense_hx_id


Pharmacist refills order, Health Plan is not adjudicated.
Orders
Primary Access: Order_id
Field Discussion:
Last_action_sequence, Last_ingred_action_sequence

Order_dispense (One row per Parent order)
Primary Access: Order_id
Field Discussion:
	Fill_nbr
Last_ver_act_seq
Last_ver_ingr_seq
Last_refill_dt_tm

Order_action (New Action_sequence)
Primary Access: Order_id, Action_sequence
Field Discussion:
Action_type_cd = REFILL (CS 6003)
Action_dt_tm
Action_personnel_id

Order_detail (Only fields which changed are written out)
Primary Access: Order_id, Action_sequence
	Field Discussion:
		Oe_field_meaning_id
 

Order_comment (If comments change, then rows are written out)
Primary Access: Order_id, Action_sequence

Order_ingredient (Meds will have one row,
Compounds will have multiple rows)
Primary Access: Order_id, Action_sequence, Comp_sequence
Field Discussion:
Catalog_cd, Synonym_id

Order_product (One row per ingredient)
Primary Access: Order_id, Action_sequence, Ingred_sequence
Field Discussion:
	Item_id
	Med_product_id

Dispense_hx
Primary Access: Order_id, Action_sequence
Field Discussion:
Disp_event_type_cd = DISPENSE (CS 4032)
Reimbursement = 0
Authorization_nbr = SPACES

Prod_dispense_hx
Primary Access: Dispense_hx_id

Charge_event
Primary Access: Same as above

Charge
		Primary Access: Charge_item_id

Interface_charge
		Primary Access: Charge_item_id

Mm_trans_header
Primary Access: Parent_entity_name (“DISPENSE_HX”),
Parent_entity_id = Dispense_hx_id

Mm_trans_line
Primary Access: Transaction_id

 

PharmNet PowerVision tables ->

Pha_disp_obs_st   
Pha_ord_act_obs_st
Pha_prod_disp_obs_st


Procure tables ->

Mm_trans_header – All transactions that flow thru Procure have a entry on this table.
Mm_trans_line – Detailed information about transaction.
Mm_trans_gl – GL information about transaction.
Item_location_cost – Stores current cost information about Item / Location combination.
Quantity_on_hand – Stores current QOH information about Item / Location combination.


Multum tables ->
Mltm_ndc_core_description
Primary Access: Ndc_code
Field Discussions:
Ndc_code
Ndc_regulation                   
Ndc_scheme                       
Main_multum_drug_code            
Brand_code        
Otc_status                       
Inner_package_size               
Inner_package_desc_code          
Outer_package_size               
Obsolete_date                    
Source_id                        
Orange_book_id                   
Unit_dose_code                   
Repackaged                      
Gbo                   
Ndc_formatted

Mltm_ndc_cost
Primary Access: Ndc_code
Field Discussions:
Ndc_code
Inventory_type                   
Cost                   
 

Mltm_ndc_main_drug_code
Primary Access: Main_multum_drug_code
Field Discussions:
Main_multum_drug_code
Principle_route_code
Dose_form_code
Product_strength_code
Drug_identifier
Csa_schedule
J_code
J_code_description

Mltm_mmdc_name_map
	Primary Access: Main_multum_drug_code
	Field Discussions:
			Main_multum_drug_code
Function_id (16 = Generic Name, 17 = Brand Name,
59 = Rx Mnemonic)
Drug_synonym_id = CKI number

Mltm_drug_name
	Primary Access: Drug_synonym_id
	Field Discussions:
			Drug_synonym_id
			Drug_name (Generic Name, Rx Mnemonic)
			Is_obsolete

Mltm_category_drug_xref
	Primary Access: Drug_identifier
	Field Discussions:
		Multum_category_id

Mltm_drug_categories
	Primary Access: Multum_category_id
	Field Discussions:
		Multum_category_id
		Category_name

Mltm_ndc_brand_name
	Primary Access: Brand_code
	Field Discussions:
		Brand_description
 

Mltm_ndc_source
	Primary Access: Source_id
	Field Discussions:
		Source_id
		Source_desc (Manufacturer’s Name)
		Address1
		Address2
		City
		State
		Province
		Zip
		Country
		
Mltm_ndc_orange_book
	Primary Access: Orange_book_id
	Field Discussions:
		Orange_book_id
		Orange_book_desc_ab
		Orange_book_description

Mltm_product_strength
Primary Access: Product_strength_code
Field Discussions:
	Product_strength_code
Product_strength_description

	Mltm_product_route
		Primary Access: Route_code
		Field Discussions:
			Route_code
			Route_abbr

	Multum_dose_form
		Primary Access: Dose_form_code
		Field Discussions:
			Dose_form_code
			Dose_form_Abbr

	Mltm_units
		Primary Access: Unit_id
		Field Discussions:
			Unit_id
			Unit_abbr

#########################################################################################################################################################

/*
This query will show the details (wrench level) for all the components (Tabs) under the Chart level as viewed in PrefMaint. 
You can specify position code or pref.
*/

SELECT 
	PosCD= V.POSITION_CD,
	Position = UAR_GET_CODE_DISPLAY( V.POSITION_CD ),
	Component=V.VIEW_NAME,
	Display_Order=cnvtint(N1.PVC_VALUE),
	TabName=N.PVC_VALUE,
	Pref=N2.PVC_NAME,
	Pref_Val=N2.PVC_VALUE

FROM
	VIEW_PREFS  V,
	NAME_VALUE_PREFS  N,
	DETAIL_PREFS  D,
	NAME_VALUE_PREFS  N1,
	NAME_VALUE_PREFS  N2

PLAN  V WHERE V.ACTIVE_IND = 1 
;      AND V.POSITION_CD = 46897   ;  Position (CPR BUILD)
      AND V.FRAME_TYPE = "CHART"
      AND V.APPLICATION_NUMBER = 600005 ; Powerchart
JOIN  N WHERE N.PARENT_ENTITY_ID = V.VIEW_PREFS_ID
      AND  N.ACTIVE_IND = 1
      AND  N.PVC_NAME = "VIEW_CAPTION"
JOIN  N1 WHERE N1.PARENT_ENTITY_ID = V.VIEW_PREFS_ID
      AND  N1.ACTIVE_IND = 1
      AND  N1.PVC_NAME = "DISPLAY_SEQ"
JOIN  D WHERE D.ACTIVE_IND = 1
      AND  D.APPLICATION_NUMBER = 600005
      AND  D.POSITION_CD =  V.POSITION_CD
      AND  D.VIEW_NAME =  V.VIEW_NAME
      AND  D.VIEW_SEQ =  V.VIEW_SEQ
JOIN  N2 WHERE N2.PARENT_ENTITY_ID = D.DETAIL_PREFS_ID
      AND  N2.ACTIVE_IND = 1
      ;AND  N2.PVC_NAME = "R_*"  ; Set to wrench preference of interest

ORDER BY	Position,
	Display_Order,
	Component
END
GO

#########################################################################################################################################################

Clinical Event - Glucose

SELECT distinct
	c.performed_dt_tm ";;q"
	, C.verified_dt_tm ";;q"
	, c_result_val = CNVTREAL(TRIM(c.result_val))
	, C_EVENT_DISP = UAR_GET_CODE_DISPLAY(C.EVENT_CD)
	, p.name_last
	, p.name_first
	, P.BIRTH_DT_TM
	, E_LOC_FACILITY_DISP = UAR_GET_CODE_DISPLAY(E.LOC_FACILITY_CD)
	, E_LOC_NURSE_UNIT_DISP = UAR_GET_CODE_DISPLAY(E.LOC_NURSE_UNIT_CD)
	, e_loc_room_cd_disp = uar_get_code_display(e.loc_room_cd)
	, e_loc_bed_cd_disp = uar_get_code_display(e.loc_bed_cd)
	, EA_ALIAS_POOL_DISP = UAR_GET_CODE_DISPLAY(EA.ALIAS_POOL_CD)
	, EA.ALIAS
	, epr.encntr_prsnl_reltn_id
	, pr.name_last
	, pr.name_first

FROM
	ENCOUNTER   E
	, CLINICAL_EVENT   C
	, PERSON   P
	, ENCNTR_ALIAS   EA
	, encntr_prsnl_reltn   epr
	, prsnl   pr

plan e where E.LOC_FACILITY_CD = 633867.00 ;PARAM_FAC_NBR
	and e.encntr_type_class_cd in (        391.00, 392.00)			;( INPAT, OBSV )
	and (e.disch_dt_tm > cnvtdatetime(curdate,curtime3)
	or e.disch_dt_tm = NULL)
	and e.active_ind = 1
	and e.beg_effective_dt_tm  <=  cnvtdatetime(curdate,curtime3)
	and e.end_effective_dt_tm >= cnvtdatetime(curdate,curtime3)
	
	
Join c where c.encntr_id = e.encntr_id
	;and c.encntr_id	=	e.encntr_id
	;and c.person_id			=			e.person_id
	and c.verified_dt_tm >= cnvtdatetime("01-APR-2008 00:00:00")
	and c.verified_dt_tm <= cnvtdatetime("17-MAY-2008 23:59:59")
	;and c.verified_dt_tm between CNVTDATETIME("01-APR-2008 00:00:00") 
    ;and CNVTDATETIME("17-MAY-2008 23:59:59")
	and c.event_cd		in (    4691270.00,     4690669.00,     4690649.00,     2700655.00)
	and c.result_val > " "
;((c.task_assay_cd	in (GLUCOSE_AC1, GLUCOSE_AC2, GLUCOSE_AC3, BICARB_AC, CREATININE_CC))
;	  or (c.catalog_cd		in (GLUCOSE_CC1, GLUCOSE_CC2, GLUCOSE_CC3))
;	  or (c.event_cd		in (GLUCOSE_EC1, GLUCOSE_EC2, GLUCOSE_EC3, GLUCOSE_EC4, BICARB_EC)))


JOIN p where p.person_id = c.person_id
	and p.active_ind = 1
	and p.beg_effective_dt_tm  <=  cnvtdatetime(curdate,curtime3)
	and p.end_effective_dt_tm >= cnvtdatetime(curdate,curtime3)
     
     
;JOIN EA WHERE EA.ENCNTR_ID = outerjoin(e.ENCNTR_ID)
;	and EA.ACTIVE_IND		=		1
;	and ea.encntr_alias_type_cd in (       1079.00,        1077.00)		;(mrn_alias_cd, fin_nbr_code)
join ea where ea.encntr_id = outerjoin(e.encntr_id)
	and ea.encntr_alias_type_cd = outerjoin(1079.00)    ;outerjoin(mrn_cd)
	and ea.active_ind = outerjoin(1)
	and ea.beg_effective_dt_tm  <=  outerjoin(cnvtdatetime(curdate,curtime3))
	and ea.end_effective_dt_tm >= outerjoin(cnvtdatetime(curdate,curtime3))
     

;JOIN epr WHERE epr.ENCNTR_ID = outerjoin(e.ENCNTR_ID)
;	and epr.ACTIVE_IND		=		1
;	and epr.encntr_prsnl_r_cd = 1119.00		;attend_phys
;	and (epr.expiration_ind != 1
;	or epr.expiration_ind is NULL)
join epr where epr.encntr_id = outerjoin(e.encntr_id)
	and epr.active_ind = outerjoin(1)
	and epr.beg_effective_dt_tm <= outerjoin(cnvtdatetime(curdate,curtime3))
	and epr.end_effective_dt_tm >= outerjoin(cnvtdatetime(curdate,curtime3))
	and epr.encntr_prsnl_r_cd = outerjoin(1119.00)     ;outerjoin(attDoc_cd)


;JOIN PR WHERE epr.prsnl_person_id = PR.PERSON_ID
join pr where pr.person_id = outerjoin(epr.prsnl_person_id)
	and pr.active_ind = outerjoin(1)
	and pr.beg_effective_dt_tm <= outerjoin(cnvtdatetime(curdate,curtime3))
	and pr.end_effective_dt_tm >= outerjoin(cnvtdatetime(curdate,curtime3))

ORDER BY
	c.clinical_event_id

WITH format,
  separator = " ",
  nocounter,
  time = 120
  
#########################################################################################################################################################

Attending Physician:

SELECT distinct
	epr.encntr_prsnl_reltn_id
	, pr.name_last
	, pr.name_first

FROM
	ENCOUNTER   E
	, ENCNTR_ALIAS   EA
	, encntr_prsnl_reltn   epr
	, prsnl   pr

plan e where e.encntr_id = XXXXXXXX

join ea where ea.encntr_id = outerjoin(e.encntr_id)
	and ea.encntr_alias_type_cd = outerjoin(1079.00)    ;outerjoin(mrn_cd)
	and ea.active_ind = outerjoin(1)
	and ea.beg_effective_dt_tm  <=  outerjoin(cnvtdatetime(curdate,curtime3))
	and ea.end_effective_dt_tm >= outerjoin(cnvtdatetime(curdate,curtime3))

join epr where epr.encntr_id = outerjoin(e.encntr_id)
	and epr.active_ind = outerjoin(1)
	and epr.beg_effective_dt_tm <= outerjoin(cnvtdatetime(curdate,curtime3))
	and epr.end_effective_dt_tm >= outerjoin(cnvtdatetime(curdate,curtime3))
	and epr.encntr_prsnl_r_cd = outerjoin(1119.00)     ;outerjoin(attDoc_cd)

join pr where pr.person_id = outerjoin(epr.prsnl_person_id)
	and pr.active_ind = outerjoin(1)
	and pr.beg_effective_dt_tm <= outerjoin(cnvtdatetime(curdate,curtime3))
	and pr.end_effective_dt_tm >= outerjoin(cnvtdatetime(curdate,curtime3))

#########################################################################################################################################################

Tasklist Report:

SELECT
	LOC = concat(trim(UAR_GET_CODE_DISPLAY(ED.LOC_ROOM_CD)),"-",trim(UAR_GET_CODE_DISPLAY(ED.LOC_BED_CD)))
	, pt_name = trim(p.name_full_formatted)
	, FIN = if (ea.alias_pool_cd > 0) cnvtalias(ea.alias, ea.alias_pool_cd) else trim(ea.alias) endif
	, ed.encntr_id
	, unit = uar_get_code_display(ed.loc_nurse_unit_cd)
	, room = uar_get_code_display(ed.loc_room_cd)
	, bed = uar_get_code_display(ed.loc_bed_cd)
	, wl_desc = substring(1,50,ot.task_description)
	, freq = EVALUATE(od.order_id,0.0,od2.oe_field_display_value,od.oe_field_display_value)
	, ord_phys = pr2.name_full_formatted
	, wl = decode(wlc.seq, wlc.units, 0.00)
	, bi_id = bi.bill_item_id
	, ord_id = o.order_id
	, const_ind = o.constant_ind
	, temp_ord_id = o.template_order_id
	, ord_id2 = if (o.template_order_id = 0)
             o.order_id
           else
             o.template_order_id
           endif
    , TA_ORD_ID = ta.order_id 
	, wl_ind = decode(bi.seq, 1, 0)
	, all_fld = 1
	, sortcol = concat(notrim(substring(1,50,ot.task_description))
	, EVALUATE(od.order_id,0.0,od2.oe_field_display_value,od.oe_field_display_value))
	, prn_yesno = od4.oe_field_display_value		;001
	, o.CLINICAL_DISPLAY_LINE

FROM
	encntr_domain   ed
	, encntr_alias   ea
	, person   p
	, task_activity   ta
	, orders   o
	, order_action   oa
	, prsnl   pr2
	, order_task   ot
	, dummyt   d1
	, bill_item   bi
	, bill_item_modifier   bim
	, dummyt   d2
	, dummyt   d3
	, workload_code   wlc
	, order_detail   od
	, ORDER_DETAIL   od2
	, ORDER_DETAIL   od4

plan ed
  where  ed.LOC_FACILITY_CD = 633867.00; $FACILITY ; 
;  	and ed.encntr_id =    26306261.00
	and ed.end_effective_dt_tm > cnvtdatetime(curdate, curtime)
	and ed.active_ind + 0 = 1
join ea
  where ed.encntr_id = ea.encntr_id
	and ea.encntr_alias_type_cd + 0 = 1077.00 ;  fin_cd ;
	and ea.active_ind + 0 = 1
	and ea.end_effective_dt_tm + 0 >= cnvtdatetime(curdate, curtime)
join p where p.person_id > 0
	and ed.person_id = p.person_id
join ta
  where ta.encntr_id = ed.encntr_id
	and ta.task_status_cd in (425, 428, 429) ;(tsk_inprocess, tsk_overdue, tsk_pending) ;
join o
  where ta.order_id = o.order_id
	and o.catalog_type_cd + 0 = 636078.00 ; $dept_cd ;       636078.00
	and (o.prn_ind = 1
	or o.constant_ind = 1
	or (ta.task_dt_tm >= cnvtdatetime("03-JUN-2008 00:00:00") ;; cnvtdatetime($start_dt_tm) ; 
	and ta.task_dt_tm <= cnvtdatetime("04-JUN-2008 23:59:59"))) ;; cnvtdatetime($end_dt_tm))) ; 
join oa
  where o.order_id = oa.order_id
	and oa.action_type_cd + 0 = 2534 ; order_cd ;
join pr2
  where oa.order_provider_id = pr2.person_id
join ot
  where ot.reference_task_id = ta.reference_task_id
join od where od.order_id = outerjoin(o.order_id)
	and trim(od.oe_field_meaning) = outerjoin("FREQ")
join od2 where od2.order_id = outerjoin(o.template_order_id)
	and trim(od2.oe_field_meaning) = outerjoin("FREQ")
join od4													;001
	where outerjoin(o.order_id) = od4.order_id
	and od4.oe_field_meaning = outerjoin("SCH/PRN")	;looking for prn:yes or prn:no
join d1
join bi
  where bi.ext_parent_reference_id = ta.catalog_cd
	and bi.ext_child_reference_id = ot.reference_task_id
	and bi.active_ind = 1
join d2
join bim
  where bim.bill_item_id = bi.bill_item_id
	and bim.active_ind = 1
	and bim.bill_item_type_cd = 3470.00 ;wl_bim_type_cd ;
join d3
join wlc
  where wlc.workload_code_id = bim.key3_id
	and wlc.active_ind + 0 = 1

ORDER BY
	unit
	, room
	, bed
	, p.name_last_key
	, p.name_first_key
	, FIN
	, sortcol
	, o.template_order_id
	, ord_id2

WITH outerjoin = d1,
  dontcare = bi,
  outerjoin = d2,
  outerjoin = d3,
  format,
  separator = " ",
  nocounter,
  time = 120

#########################################################################################################################################################

New to CCL - Recommendations:
Per Bob Ross:
I would suggest starting with the Quick Reference Guide under training on the CMSG.  I'm clearly biased, but I think the Command Reference and Programming Reference in the DiscernExplorerHelp.exe are very helpful.  Also Cerner offers a Discern Explorer 1 WBT that is very helpful for gaining an understanding of the basics.  You might check to see if your site has a perpetual license.  If so you can complete the WBT for no additional cost.  If you don't own a perpetual license you can purchase a one-time license for $400.  Contact cliented@cerner.com for more information on purchasing training.  After completing the WBT I recommend completing the Prompt Builder tutorial and then the Layout Builder Part 1 on the CMSG.  After those tutorials you will want to check into attending the Discern Explorer 2 and 3 classes.  Again you can contact cliented@cerner.com for more information on those training classes.  After those classes you will want to complete the Layout Builder Part 2 tutorial on the CMSG. And of course the members of this community are very knowledgeable when it comes to Discern Explorer (CCL) and are normally very willing to help new comers.  We have all been there ourselves and most remember what it was like.  

#########################################################################################################################################################

What are DummyT tables?  
Per Bob Ross:
I have long suspected that the name "dummyt" was chosen in order to make me feel like one.  However I have been assured that is not the case.

Basically the dummyt table is a special table definition in Discern Explorer.  It can be used to force processing to occur at the Discern Explorer level instead of the RDBMS level.  When you write a query in Discern Explorer that reads RDBMS tables, that query is translated and passed to the RDBMS.  The RDBMS executes what it is given and returns results back to Discern Explorer where additional processing may occur to create the final result set. 

I suspect for your specific example the With clause of the Select uses the dontcare or outerjoin controls options.   Without seeing those control options it is impossible to say exactly why the dummyt tables are used.  However, removing a few things from the code you posted that prevent it from compiling, and changing the second reference of join D1 to join D2. I ended up with the following:

SELECT distinct
	APPT_LOCATION = UAR_GET_CODE_DISPLAY( S.APPT_LOCATION_CD ),
	RESOURCE = substring(1,10,C.ALIAS),
	BEG_DATE = format( S.BEG_DT_TM, "MM/DD/YYYY;;D" ),
	BEG_TIME = format( S.BEG_DT_TM, "HH:MM;;S" ),
	END_TIME = format( S.END_DT_TM, "HH:MM;;S" ),
	PATIENT = SUBSTRING(1,40,P.NAME_FULL_FORMATTED),
	APPT_STATE = S2.STATE_MEANING,
	MRN = PA.ALIAS,
	APPT_DISP = UAR_GET_CODE_DISPLAY( SE.APPT_TYPE_CD ),
	APPT_TYPE = SA.MNEMONIC
 
FROM
	SCH_APPT  S,
	SCH_APPT  S2,
	PERSON  P,
	PERSON_ALIAS  PA,
	SCH_EVENT  SE,
	SCH_APPT_SYN  SA,
	CODE_VALUE_OUTBOUND  C,
	DUMMYT D1,
	DUMMYT D2
 
PLAN S WHERE  S.SCHEDULE_ID != 0
              and s.appt_location_cd = t_record->location_cd 
              and s.beg_dt_tm >= cnvtdatetime(t_record->beg_dt_tm)
              and s.beg_dt_tm <= cnvtdatetime(t_record->end_dt_tm)
              AND S.STATE_MEANING IN ("CONFIRMED", "CHECKED IN")
              AND S.ROLE_MEANING IN ("RESOURCE", "PATIENT", "ATTENDING")
 
JOIN SE WHERE  SE.SCH_EVENT_ID =  S.SCH_EVENT_ID
 
JOIN SA WHERE  SA.APPT_TYPE_CD =  SE.APPT_TYPE_CD
 
JOIN C WHERE C.CODE_VALUE = S.RESOURCE_CD
 
; get group resource
JOIN D1
JOIN S2 WHERE  ( (S2.SCHEDULE_ID = S.SCHEDULE_ID )
                OR ((S2.GRPSESSION_ID != 0.0)
                AND (S2.GRPSESSION_ID = S.GRPSESSION_ID)))
                AND (S2.ROLE_MEANING = "PATIENT")
                AND (S2.STATE_MEANING IN ("CONFIRMED", "CHECKED IN"))
 
JOIN P WHERE P.PERSON_ID = S2.PERSON_ID
 
JOIN D2
JOIN PA WHERE  PA.ACTIVE_IND = 1
               AND PA.PERSON_ID = P.PERSON_ID
               AND PA.PERSON_ALIAS_TYPE_CD = 10
               and pa.alias_pool_cd = 678470
               AND PA.END_EFFECTIVE_DT_TM > cnvtdatetime(CURDATE,235959)

When the above select is executed, the join to d1 will cause everything that is above D1 to be passed as a query to the RDBMS.  That query will look something like the following.  To see the actual query you can use cclquery, set trace rdbdebug, or ExplorerAnalyzer.exe and search for the program name.

SELECT 
	S.RESOURCE_CD,
	S.BEG_DT_TM,
	S.END_DT_TM,
	S.STATE_MEANING,
	S.ROLE_MEANING,
	S.SCH_EVENT_ID,
	S.SCHEDULE_ID,
	S.APPT_LOCATION_CD,
	S.GRPSESSION_ID,
	SE.SCH_EVENT_ID,
	SE.APPT_TYPE_CD,
	SA.MNEMONIC,
	SA.APPT_TYPE_CD,
	C.CODE_VALUE,
	C.ALIAS
FROM  CODE_VALUE_OUTBOUND C ,
	SCH_APPT_SYN SA ,
	SCH_EVENT SE ,
	SCH_APPT S  
WHERE  NOT S.SCHEDULE_ID = :1    
	AND S.APPT_LOCATION_CD =  :2    
	AND S.BEG_DT_TM >=  :3    
	AND S.BEG_DT_TM <=  :4    
	AND  (S.STATE_MEANING = :5 OR S.STATE_MEANING = :6   )  
	AND  (S.ROLE_MEANING =:7   OR S.ROLE_MEANING =  :8  OR S.ROLE_MEANING = :9   )  
	AND SE.SCH_EVENT_ID =    S.SCH_EVENT_ID 
	AND SA.APPT_TYPE_CD =    SE.APPT_TYPE_CD 
	AND C.CODE_VALUE =    S.RESOURCE_CD                           

In the above query the :1 - :9 will be bind variables that are equal to values from your program.  The bind variables are used to take better advantage of the RDBMS optimization.

The above query will return a temporary result set to Discern Explorer.  Since the Discern Explorer query contains the Join D1 and Join D2 clauses, Discern Explorer will then use the temporary result set and execute a query that is made up all the tables that are between Join D1 and Join D2.  That query will look something like:

SELECT 
	S2.PERSON_ID,
	S2.STATE_MEANING,
	S2.ROLE_MEANING,
	S2.SCHEDULE_ID,
	S2.GRPSESSION_ID,
	P.PERSON_ID,
	P.NAME_FULL_FORMATTED 
	FROM  PERSON P ,
	SCH_APPT S2  
WHERE ((S2.SCHEDULE_ID =     :1   ) OR 
	( NOT S2.GRPSESSION_ID =     :2    AND S2.GRPSESSION_ID =     :3   )) 
	AND S2.ROLE_MEANING =     :4    AND  (S2.STATE_MEANING =     :5    OR S2.STATE_MEANING =     :6   )  
	AND P.PERSON_ID =    S2.PERSON_ID

The above query is going to be executed one time for every row that is in the temporary result set that was returned by the first query.  Each time the query is executed the :3 bind variable is going to be set equal to the S.GRPSESSION_ID from the temporary result set.  So this second query is going to be executed one time for each row that was returned in the temporary result set.  Each execution of this second query may return some rows that will be added into the temporary result set and associated with the corresponding rows that are already in that temporary result set.

Again since your Discern Explorer query is using the Join to D2, a third query that looks like the following will be created:

SELECT  
	PA.PERSON_ID,
	PA.ACTIVE_IND,
	PA.ALIAS_POOL_CD,
	PA.PERSON_ALIAS_TYPE_CD,
	PA.ALIAS,PA.END_EFFECTIVE_DT_TM
FROM  PERSON_ALIAS PA  
WHERE PA.ACTIVE_IND =     :1    
	AND PA.PERSON_ID =     :2    
	AND PA.PERSON_ALIAS_TYPE_CD =     :3    
	AND PA.ALIAS_POOL_CD =       :4    
	AND PA.END_EFFECTIVE_DT_TM >  :5

This third query is going to be executed one time for each row that is returned by each execution of the second query.  In the above query the bind variable :2 is going to be set equal to the p.person_id that was return in one of the rows from the one of the executions of the second query.  Each execution of the third query may return qualifying rows that are again added to the temporary result set.

After all the executions of all three queries, the temporary result set will be complete and ready for processing by the report writer clauses in your Discern Explorer query or just displayed as the query results if no report writer clauses are used.

Again without seeing the With clause it is impossible to know exactly why the dummyt tables are used.  But my guess is that the With clause has something like OUTERJOIN = D1, OUTERJOIN = D2.  If that is the case Discern Explorer will return the rows from the first query even if no results were returned from an execution of the second query or it will return the rows from the first and second queries even if no results were returned from an execution of the third query.  

#########################################################################################################################################################

CCL for Attending Phys Relationship fix:

update into encntr_prsnl_reltn
set active_ind = 1,
active_status_cd = 188,
MANUAL_CREATE_IND = 0,
MANUAL_CREATE_BY_ID = 0.00,
MANUAL_INACT_DT_TM = null,
MANUAL_INACT_IND = 0,
MANUAL_INACT_BY_ID = 0,
EXPIRATION_IND = 0,
EXPIRE_DT_TM = null,
end_effective_dt_tm = cnvtdatetime("31-DEC-2100")
where prsnl_person_id = 769978 ; ENTER PHYSICIAN’S PERSONNEL ID (HNAUSER)
and encntr_prsnl_r_cd = 1119
and encntr_id = (select encntr_id
from encntr_alias where encntr_alias_type_cd = 1077 and
alias = "41405154") ; ENTER FIN NUMBER
go

#########################################################################################################################################################

; DTA to Event Code Conversion
SELECT
	DTA_CD = DTA.TASK_ASSAY_CD
	, DTA_DESC = DTA.DESCRIPTION
	, EVENT_CD = DTA.EVENT_CD
	, EVENT_DISP = UAR_GET_CODE_DISPLAY(DTA.EVENT_CD)
	

FROM
	DISCRETE_TASK_ASSAY   DTA

WITH NOCOUNTER, SEPARATOR=" ", FORMAT


#########################################################################################################################################################

; Tells you what db you are pointed to

select * from v$instance 

; This currently works in CMBLD's DVD app:
; This will point to CMRPT db instead of CMBLD (default)

select * from v$instance@cmrpt

; Note: To use DBVisualizer (third party software),
; you will need individual account.

#########################################################################################################################################################



PSMH11H