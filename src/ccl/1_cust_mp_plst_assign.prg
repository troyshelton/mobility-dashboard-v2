;*** Generated by translate command; please verify contents before re-including in CCL ***
DROP PROGRAM   1_cust_mp_plst_assign : DBA  GO
CREATE PROGRAM  1_cust_mp_plst_assign : DBA

prompt 
	"Output to File/Printer/MINE" = "MINE"   ;* Enter or select the printer or file name to send this report to. 

with OUTDEV

;/* ; troy
 
RECORD  ORGS  (
1  QUAL [*]
2  ORG_ID  =  F8
2  CONFID_LEVEL  =  I4 )
 
SET  ENCNTR_ORG_SEC_IND  = 0
 
SET  CONFID_IND  = 0
 
DECLARE  DMINFO_OK  =  I2  WITH  NOCONSTANT (0 )
 
SET  DMINFO_OK  =  VALIDATE ( CCLDMINFO -> MODE , 0 )
 
 CALL ECHO ( CONCAT ("Ccldminfo exists= " ,  BUILD ( DMINFO_OK )))

IF ( ( DMINFO_OK =1 ) )
SET  ENCNTR_ORG_SEC_IND  =  CCLDMINFO -> SEC_ORG_RELTN
SET  CONFID_IND  =  CCLDMINFO -> SEC_CONFID
ELSE
SELECT  INTO "nl:"
FROM ( DM_INFO  DI )
 PLAN ( DI
WHERE (DI.INFO_DOMAIN="SECURITY" ) AND (DI.INFO_NAME IN ("SEC_ORG_RELTN" ,
"SEC_CONFID" )))
 
 
DETAIL
 
IF ( (DI.INFO_NAME="SEC_ORG_RELTN" ) AND (DI.INFO_NUMBER=1 ) )  ENCNTR_ORG_SEC_IND =1
ELSEIF ( (DI.INFO_NAME="SEC_CONFID" ) AND (DI.INFO_NUMBER=1 ) )  CONFID_IND =1
ENDIF
 
 WITH  NOCOUNTER
ENDIF
 
 
IF (  (( ( ENCNTR_ORG_SEC_IND =1 ) )  OR  (( CONFID_IND =1 ) ))  )
DECLARE  ORG_CNT  =  I2  WITH  NOCONSTANT (0 )
IF ( ( VALIDATE ( _SACRTL_ORG_INC_ , 99999 )=99999 ) )
DECLARE  _SACRTL_ORG_INC_  =  I2  WITH  CONSTANT (1 )
RECORD  SAC_ORG  (
1  ORGANIZATIONS [*]
2  ORGANIZATION_ID  =  F8
2  CONFID_CD  =  F8
2  CONFID_LEVEL  =  I4 )
 EXECUTE SECRTL
 EXECUTE SACRTL
DECLARE  ORGCNT  =  I4  WITH  PROTECTED , NOCONSTANT (0 )
DECLARE  SECSTAT  =  I2
DECLARE  LOGONTYPE  =  I4  WITH  PROTECT , NOCONSTANT ( - (1 ))
DECLARE  DYNAMIC_ORG_IND  =  I4  WITH  PROTECT , NOCONSTANT ( - (1 ))
DECLARE  DCUR_TRUSTID  =  F8  WITH  PROTECT , NOCONSTANT (0.0 )
DECLARE  DYNORG_ENABLED  =  I4  WITH  CONSTANT (1 )
DECLARE  DYNORG_DISABLED  =  I4  WITH  CONSTANT (0 )
DECLARE  LOGONTYPE_NHS  =  I4  WITH  CONSTANT (1 )
DECLARE  LOGONTYPE_LEGACY  =  I4  WITH  CONSTANT (0 )
 CALL UAR_SECGETCLIENTLOGONTYPE ( LOGONTYPE )
 CALL ECHO ( BUILD ("logontype:" ,  LOGONTYPE ))
IF ( ( LOGONTYPE != LOGONTYPE_NHS ) )
SET  DYNAMIC_ORG_IND  =  DYNORG_DISABLED
ENDIF
 
IF ( ( LOGONTYPE = LOGONTYPE_NHS ) )
DECLARE  GETDYNAMICORGPREF (( DTRUSTID = F8 )) =  I4
SUBROUTINE   GETDYNAMICORGPREF  ( DTRUSTID  )
 
DECLARE  SCUR_TRUST  =  VC
DECLARE  PREF_VAL  =  VC
DECLARE  IS_ENABLED  =  I4  WITH  CONSTANT (1 )
DECLARE  IS_DISABLED  =  I4  WITH  CONSTANT (0 )
SET  SCUR_TRUST  =  CNVTSTRING ( DTRUSTID )
SET  SCUR_TRUST  =  CONCAT ( SCUR_TRUST , ".00" )
IF (  NOT ( VALIDATE ( PREF_REQ , 0 ) ) )
RECORD  PREF_REQ  (
1  WRITE_IND  =  I2
1  DELETE_IND  =  I2
1  PREF [*]
2  CONTEXTS [*]
3  CONTEXT  =  VC
3  CONTEXT_ID  =  VC
2  SECTION  =  VC
2  SECTION_ID  =  VC
2  SUBGROUP  =  VC
2  ENTRIES [*]
3  ENTRY  =  VC
3  VALUES [*]
4  VALUE  =  VC )
ENDIF
 
IF (  NOT ( VALIDATE ( PREF_REP , 0 ) ) )
RECORD  PREF_REP  (
1  PREF [*]
2  SECTION  =  VC
2  SECTION_ID  =  VC
2  SUBGROUP  =  VC
2  ENTRIES [*]
3  PREF_EXISTS_IND  =  I2
3  ENTRY  =  VC
3  VALUES [*]
4  VALUE  =  VC
1  STATUS_DATA
2  STATUS  =  C1
2  SUBEVENTSTATUS [1 ]
3  OPERATIONNAME  =  C25
3  OPERATIONSTATUS  =  C1
3  TARGETOBJECTNAME  =  C25
3  TARGETOBJECTVALUE  =  VC )
ENDIF
 
SET  STAT  =  ALTERLIST ( PREF_REQ -> PREF , 1 )
SET  STAT  =  ALTERLIST ( PREF_REQ -> PREF [1 ]-> CONTEXTS , 2 )
SET  STAT  =  ALTERLIST ( PREF_REQ -> PREF [1 ]-> ENTRIES , 1 )
SET  PREF_REQ -> PREF [1 ]-> CONTEXTS [1 ]-> CONTEXT  = "organization"
SET  PREF_REQ -> PREF [1 ]-> CONTEXTS [1 ]-> CONTEXT_ID  =  SCUR_TRUST
SET  PREF_REQ -> PREF [1 ]-> CONTEXTS [2 ]-> CONTEXT  = "default"
SET  PREF_REQ -> PREF [1 ]-> CONTEXTS [2 ]-> CONTEXT_ID  = "system"
SET  PREF_REQ -> PREF [1 ]-> SECTION  = "workflow"
SET  PREF_REQ -> PREF [1 ]-> SECTION_ID  = "UK Trust Security"
SET  PREF_REQ -> PREF [1 ]-> ENTRIES [1 ]-> ENTRY  = "dynamic organizations"
 EXECUTE PPR_PREFERENCES WITH  REPLACE ("ptlst_request" , "PREF_REQ" ),
 REPLACE ("ptlstEncntr_reply" , "PREF_REP" )
IF ( ( CNVTUPPER ( PREF_REP -> PREF [1 ]-> ENTRIES [1 ]-> VALUES [1 ]-> VALUE )="ENABLED" ) )
 RETURN ( IS_ENABLED )
 
ELSE   RETURN ( IS_DISABLED )
 
ENDIF
 
 
END ;Subroutine
 
DECLARE  HPROP  =  I4  WITH  PROTECT , NOCONSTANT (0 )
DECLARE  TMPSTAT  =  I2
DECLARE  SPROPNAME  =  VC
DECLARE  SROLEPROFILE  =  VC
SET  HPROP  =  UAR_SRVCREATEPROPERTY ()
SET  TMPSTAT  =  UAR_SECGETCLIENTATTRIBUTESEXT (5 ,  HPROP )
SET  SPROPNAME  =  UAR_SRVFIRSTPROPERTY ( HPROP )
SET  SROLEPROFILE  =  UAR_SRVGETPROPERTYPTR ( HPROP ,  NULLTERM ( SPROPNAME ))
SELECT  INTO "nl:"
FROM ( PRSNL_ORG_RELTN_TYPE  PRT ),
( PRSNL_ORG_RELTN  POR )
 PLAN ( PRT
WHERE (PRT.ROLE_PROFILE= SROLEPROFILE ) AND (PRT.ACTIVE_IND=1 ) AND (PRT.BEG_EFFECTIVE_DT_TM<=
 CNVTDATETIME ( CURDATE ,  CURTIME3 )) AND (PRT.END_EFFECTIVE_DT_TM> CNVTDATETIME ( CURDATE ,
 CURTIME3 )))
 AND ( POR
WHERE ( OUTERJOIN (PRT.ORGANIZATION_ID)=POR.ORGANIZATION_ID) AND (POR.PERSON_ID= OUTERJOIN (
PRT.PRSNL_ID)) AND (POR.ACTIVE_IND= OUTERJOIN (1 )) AND (POR.BEG_EFFECTIVE_DT_TM<= OUTERJOIN (
 CNVTDATETIME ( CURDATE ,  CURTIME3 ))) AND (POR.END_EFFECTIVE_DT_TM> OUTERJOIN ( CNVTDATETIME (
 CURDATE ,  CURTIME3 ))))
 
ORDER BY POR.PRSNL_ORG_RELTN_ID
 
DETAIL
 ORGCNT =1 ,
 SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS , 1 ),
 USER_PERSON_ID =PRT.PRSNL_ID,
 SAC_ORG -> ORGANIZATIONS [1 ]-> ORGANIZATION_ID =PRT.ORGANIZATION_ID,
 SAC_ORG -> ORGANIZATIONS [1 ]-> CONFID_CD =POR.CONFID_LEVEL_CD,
 CONFID_CD = UAR_GET_COLLATION_SEQ (POR.CONFID_LEVEL_CD),
 SAC_ORG -> ORGANIZATIONS [1 ]-> CONFID_LEVEL =
IF ( ( CONFID_CD >0 ) )  CONFID_CD
ELSE  0
ENDIF
 
 WITH  MAXREC =1
SET  DCUR_TRUSTID  =  SAC_ORG -> ORGANIZATIONS [1 ]-> ORGANIZATION_ID
SET  DYNAMIC_ORG_IND  =  GETDYNAMICORGPREF ( DCUR_TRUSTID )
 CALL UAR_SRVDESTROYHANDLE ( HPROP )
ENDIF
 
IF ( ( DYNAMIC_ORG_IND = DYNORG_DISABLED ) )
SELECT  DISTINCT  INTO "nl:"
FROM ( PRSNL_ORG_RELTN  POR )
 
WHERE (POR.PERSON_ID= REQINFO -> UPDT_ID ) AND (POR.ACTIVE_IND=1 ) AND (POR.BEG_EFFECTIVE_DT_TM<
 CNVTDATETIME ( CURDATE ,  CURTIME3 )) AND (POR.END_EFFECTIVE_DT_TM>= CNVTDATETIME ( CURDATE ,
 CURTIME3 ))
 
HEAD REPORT
 
IF ( ( ORGCNT >0 ) )  SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS , 10 )
ENDIF
 
DETAIL
 ORGCNT =( ORGCNT +1 ),
 
IF ( ( MOD ( ORGCNT , 10 )=1 ) )  SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS , ( ORGCNT +9 ))
ENDIF
,
 SAC_ORG -> ORGANIZATIONS [ ORGCNT ]-> ORGANIZATION_ID =POR.ORGANIZATION_ID,
 SAC_ORG -> ORGANIZATIONS [ ORGCNT ]-> CONFID_CD =POR.CONFID_LEVEL_CD,
 SAC_ORG -> ORGANIZATIONS [ ORGCNT ]-> CONFID_LEVEL =
IF ( ( UAR_GET_COLLATION_SEQ (POR.CONFID_LEVEL_CD)>0 ) )  UAR_GET_COLLATION_SEQ (POR.CONFID_LEVEL_CD
)
ELSE  0
ENDIF
 
FOOT REPORT
 SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS ,  ORGCNT )
 WITH  NOCOUNTER
ELSEIF ( ( DYNAMIC_ORG_IND = DYNORG_ENABLED ) )
DECLARE  NHSTRUSTCHILD_ORG_ORG_RELTN_CD  =  F8
SET  NHSTRUSTCHILD_ORG_ORG_RELTN_CD  =  UAR_GET_CODE_BY ("MEANING" , 369 , "NHSTRUSTCHLD" )
SELECT  INTO "nl:"
FROM ( ORG_ORG_RELTN  OOR )
 PLAN ( OOR
WHERE (OOR.ORGANIZATION_ID= DCUR_TRUSTID ) AND (OOR.ACTIVE_IND=1 ) AND (OOR.BEG_EFFECTIVE_DT_TM<
 CNVTDATETIME ( CURDATE ,  CURTIME3 )) AND (OOR.END_EFFECTIVE_DT_TM>= CNVTDATETIME ( CURDATE ,
 CURTIME3 )) AND (OOR.ORG_ORG_RELTN_CD= NHSTRUSTCHILD_ORG_ORG_RELTN_CD ))
 
 
HEAD REPORT
 
IF ( ( ORGCNT >0 ) )  SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS , 10 )
ENDIF
 
DETAIL
 
IF ( (OOR.RELATED_ORG_ID>0 ) )  ORGCNT =( ORGCNT +1 ),
IF ( ( MOD ( ORGCNT , 10 )=1 ) )  SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS , ( ORGCNT +9 ))
ENDIF
,  SAC_ORG -> ORGANIZATIONS [ ORGCNT ]-> ORGANIZATION_ID =OOR.RELATED_ORG_ID
ENDIF
 
FOOT REPORT
 SECSTAT = ALTERLIST ( SAC_ORG -> ORGANIZATIONS ,  ORGCNT )
 WITH  NOCOUNTER
ELSE
 CALL ECHO ( BUILD ("Unexpected login type: " ,  DYNAMIMC_ORG_IND ))
ENDIF
 
ENDIF
 
SET  ORG_CNT  =  SIZE ( SAC_ORG -> ORGANIZATIONS , 5 )
SET  STAT  =  ALTERLIST ( ORGS -> QUAL ,  ORG_CNT )
FOR (  COUNT  = 1  TO  ORG_CNT  )
 
SET  ORGS -> QUAL [ COUNT ]-> ORG_ID  =  SAC_ORG -> ORGANIZATIONS [ COUNT ]-> ORGANIZATION_ID
SET  ORGS -> QUAL [ COUNT ]-> CONFID_LEVEL  =  SAC_ORG -> ORGANIZATIONS [ COUNT ]-> CONFID_LEVEL
 
ENDFOR
 
ENDIF
;*/ ; troy 

SET  CONFID_IND  =  0       ; troy
SET  ENCNTR_ORG_SEC_IND = 0 ; troy
 
DECLARE  LOCCNT  =  I4  WITH  NOCONSTANT (0 )
 
DECLARE  CNT  =  I4  WITH  NOCONSTANT (0 )
 
DECLARE  ARG_NBR  =  I4  WITH  NOCONSTANT ( CNVTINT ( SIZE ( ptlst_request -> ARGUMENTS , 5 )))

call echo(build("ARG_NBR: ", ARG_NBR))
 
DECLARE  COUNTER  =  I4  WITH  NOCONSTANT (1 )
 
DECLARE  PRSNL_ID  =  F8  WITH  NOCONSTANT (0.0 )
 
DECLARE  LAG_MINUTES  =  I4  WITH  NOCONSTANT (0 )
 
DECLARE  INTERVAL  =  VC
 
DECLARE  X  =  I4  WITH  NOCONSTANT (0 )
 
DECLARE  Y  =  I4  WITH  NOCONSTANT (0 )
 
DECLARE  FACILITY_TYPE_CD  =  F8  WITH  NOCONSTANT (0.0 )
 
DECLARE  BUILDING_TYPE_CD  =  F8  WITH  NOCONSTANT (0.0 )
 
DECLARE  UNIT_TYPE_CD  =  F8  WITH  NOCONSTANT (0.0 )
 
DECLARE  FILTERIND  =  I2  WITH  NOCONSTANT (0 )
 
SET  FACILITY_TYPE_CD  =  UAR_GET_CODE_BY ("MEANING" , 222 , "FACILITY" )
 
SET  BUILDING_TYPE_CD  =  UAR_GET_CODE_BY ("MEANING" , 222 , "BUILDING" )
 
SET  UNIT_TYPE_CD  =  UAR_GET_CODE_BY ("MEANING" , 222 , "NURSEUNIT" )
 
SET  CENSUS_TYPE_CD  =  UAR_GET_CODE_BY ("MEANING" , 339 , "CENSUS" )
 
SET  E_DT_TM  =  CNVTDATETIME ( CURDATE ,  CURTIME3 )
 
SET  B_DT_TM  =  CNVTDATETIME ( CURDATE ,  CURTIME3 )
 
FOR (  COUNTER  = 1  TO  ARG_NBR  )
 
CASE (  ptlst_request -> ARGUMENTS [ COUNTER ]-> ARGUMENT_NAME  )
 OF "prsnl_id" :
SET  PRSNL_ID  =  CNVTREAL ( ptlst_request -> ARGUMENTS [ COUNTER ]-> PARENT_ENTITY_ID )
 OF "lag_minutes" :
SET  LAG_MINUTES  =  CNVTINT ( ptlst_request -> ARGUMENTS [ COUNTER ]-> ARGUMENT_VALUE )
 ENDCASE
 
 
ENDFOR

call echo(build("PRSNL_ID: ", PRSNL_ID))
call echo(build("LAG_MINUTES: ", LAG_MINUTES))
 
IF ( ( LAG_MINUTES >0 ) )
SET  INTERVAL  =  BUILD ( ABS ( LAG_MINUTES ), "min" )
SET  E_DT_TM  =  CNVTLOOKAHEAD ( INTERVAL ,  CNVTDATETIME ( CURDATE ,  CURTIME3 ))
SET  B_DT_TM  =  CNVTLOOKBEHIND ( INTERVAL ,  CNVTDATETIME ( CURDATE ,  CURTIME3 ))
ENDIF
 
 
SET  ENCNTR_WHERE  = "e.encntr_id = ed.encntr_id and e.active_ind = 1"
 
IF (  (( ( CONFID_IND =1 ) )  OR  (( ENCNTR_ORG_SEC_IND =1 ) ))  )
SET  FILTERIND  = 1
ELSE
SET  FILTERIND  = 0
ENDIF
 
 
RECORD  LOCATIONS  (
1  QUAL [*]
2  LOC_FACILITY_CD  =  F8
2  LOC_BUILDING_CD  =  F8
2  LOC_NURSE_UNIT_CD  =  F8
2  LOC_ROOM_CD  =  F8
2  LOC_BED_CD  =  F8
2  ENCNTR_ID  =  F8 )

call echo(">>> care team query: ")
 
SELECT  INTO "nl:"
FROM ( DCP_CARE_TEAM_PRSNL  CTP ),
( DCP_SHIFT_ASSIGNMENT  SA )
PLAN ( CTP
  WHERE  (
      ( (CTP.PRSNL_ID=0 ) )  
      OR  (
        (CTP.PRSNL_ID= PRSNL_ID ) 
        AND  (
          ( (CTP.BEG_EFFECTIVE_DT_TM <= CNVTDATETIME ( B_DT_TM )) AND (CTP.END_EFFECTIVE_DT_TM>= CNVTDATETIME ( B_DT_TM )) )  
          OR ((CTP.BEG_EFFECTIVE_DT_TM>= CNVTDATETIME ( B_DT_TM )) AND (CTP.BEG_EFFECTIVE_DT_TM<= CNVTDATETIME (E_DT_TM )) )
        )  
      )
  ) 
)

AND ( SA
  WHERE (
    SA.CARETEAM_ID=(CTP.CARETEAM_ID+0 )
  ) 
  AND  (( (SA.PRSNL_ID=0 ) AND (SA.CARETEAM_ID!=0 ) )  OR
   ((SA.PRSNL_ID= PRSNL_ID ) )
  )  
  AND  (
    ((SA.BEG_EFFECTIVE_DT_TM<= CNVTDATETIME ( B_DT_TM )) AND (SA.END_EFFECTIVE_DT_TM>= CNVTDATETIME ( B_DT_TM )) )  
    OR ((SA.BEG_EFFECTIVE_DT_TM>= CNVTDATETIME (B_DT_TM )) AND (SA.BEG_EFFECTIVE_DT_TM<= CNVTDATETIME ( E_DT_TM )) )
  )

)
 
 
HEAD REPORT
 LOCCNT =0
DETAIL
 LOCCNT =( LOCCNT +1 ),
 
IF ( ( MOD ( LOCCNT , 10 )=1 ) )  STAT = ALTERLIST ( LOCATIONS -> QUAL , ( LOCCNT +9 ))
ENDIF
,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_FACILITY_CD =SA.LOC_FACILITY_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_BUILDING_CD =SA.LOC_BUILDING_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_NURSE_UNIT_CD =SA.LOC_UNIT_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_ROOM_CD =SA.LOC_ROOM_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_BED_CD =SA.LOC_BED_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> ENCNTR_ID =SA.ENCNTR_ID
 WITH  NOCOUNTER
 
SET  CNT  =  LOCCNT



call echo(">>> location group query # 1: ")

;/* ; skip
SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT )),
( LOCATION_GROUP  LG ),
( LOCATION_GROUP  LG1 )
 PLAN ( D
WHERE ( LOCATIONS -> QUAL [D.SEQ]-> LOC_BUILDING_CD =0 ) AND ( LOCATIONS -> QUAL [D.SEQ]->
 ENCNTR_ID =0 ))
 AND ( LG
WHERE (LG.PARENT_LOC_CD= LOCATIONS -> QUAL [D.SEQ]-> LOC_FACILITY_CD ) AND (
LG.LOCATION_GROUP_TYPE_CD= FACILITY_TYPE_CD ) AND (LG.ROOT_LOC_CD=0 ))
 AND ( LG1
WHERE (LG1.PARENT_LOC_CD=LG.CHILD_LOC_CD) AND (LG1.LOCATION_GROUP_TYPE_CD= BUILDING_TYPE_CD ) AND (
LG1.ROOT_LOC_CD=0 ))
 
 
DETAIL
 LOCCNT =( LOCCNT +1 ),
 
IF ( ( MOD ( LOCCNT , 10 )=1 ) )  STAT = ALTERLIST ( LOCATIONS -> QUAL , ( LOCCNT +9 ))
ENDIF
,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_FACILITY_CD = LOCATIONS -> QUAL [D.SEQ]-> LOC_FACILITY_CD ,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_BUILDING_CD =LG.CHILD_LOC_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_NURSE_UNIT_CD =LG1.CHILD_LOC_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_ROOM_CD =0 ,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_BED_CD =0 ,
 LOCATIONS -> QUAL [ LOCCNT ]-> ENCNTR_ID =0
 WITH  NOCOUNTER
;*/

 
call echo(">>> location group query # 2: ")

;/* ; skip 
SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT )),
( LOCATION_GROUP  LG )
 PLAN ( D
WHERE ( LOCATIONS -> QUAL [D.SEQ]-> LOC_NURSE_UNIT_CD =0 ) AND ( LOCATIONS -> QUAL [D.SEQ]->
 ENCNTR_ID =0 ))
 AND ( LG
WHERE (LG.PARENT_LOC_CD= LOCATIONS -> QUAL [D.SEQ]-> LOC_BUILDING_CD ) AND (
LG.LOCATION_GROUP_TYPE_CD= BUILDING_TYPE_CD ) AND (LG.ROOT_LOC_CD=0 ))
 
 
DETAIL
 LOCCNT =( LOCCNT +1 ),
 
IF ( ( MOD ( LOCCNT , 10 )=1 ) )  STAT = ALTERLIST ( LOCATIONS -> QUAL , ( LOCCNT +9 ))
ENDIF
,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_FACILITY_CD = LOCATIONS -> QUAL [D.SEQ]-> LOC_FACILITY_CD ,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_BUILDING_CD = LOCATIONS -> QUAL [D.SEQ]-> LOC_BUILDING_CD ,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_NURSE_UNIT_CD =LG.CHILD_LOC_CD,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_ROOM_CD =0 ,
 LOCATIONS -> QUAL [ LOCCNT ]-> LOC_BED_CD =0 ,
 LOCATIONS -> QUAL [ LOCCNT ]-> ENCNTR_ID =0
 WITH  NOCOUNTER
;*/

call echorecord(locations)


 


call echo(">>> encounter domain query: ")


SET  CNT  = 0

 
SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( LOCCNT )),
( ENCNTR_DOMAIN  ED ),
( ENCOUNTER  E ),
( PERSON  P )
 PLAN ( D
  WHERE ( LOCATIONS -> QUAL [D.SEQ]-> LOC_NURSE_UNIT_CD >0 )
)
AND ( ED
  WHERE (ED.ENCNTR_DOMAIN_TYPE_CD= CENSUS_TYPE_CD ) ; > 0.00 ) ;  ; troy
  AND (ED.LOC_NURSE_UNIT_CD= LOCATIONS -> QUAL [D.SEQ]-> LOC_NURSE_UNIT_CD ) 
  AND (ED.END_EFFECTIVE_DT_TM>= CNVTDATETIME ( B_DT_TM )) ; troy
  AND (
    ((  ED.LOC_ROOM_CD= LOCATIONS -> QUAL [D.SEQ]-> LOC_ROOM_CD ))  
    OR (( LOCATIONS -> QUAL [D.SEQ]-> LOC_ROOM_CD =0 ))
  )
  AND (
    (( ED.LOC_BED_CD= LOCATIONS -> QUAL [D.SEQ]-> LOC_BED_CD ))  
    OR (( LOCATIONS -> QUAL [D.SEQ]-> LOC_BED_CD =0 ))
  )
  AND  (
    ( (ED.ENCNTR_ID= LOCATIONS -> QUAL [D.SEQ]->ENCNTR_ID ) )  
   OR  (( LOCATIONS -> QUAL [D.SEQ]-> ENCNTR_ID =0 ) )
  )
  AND (ED.ACTIVE_IND=1 ) ; troy
)
AND ( E
  WHERE  PARSER ( ENCNTR_WHERE ) ; "e.encntr_id = ed.encntr_id and e.active_ind = 1"
)
AND ( P
  WHERE (P.PERSON_ID=E.PERSON_ID) AND (P.ACTIVE_IND=1 )
)
 
ORDER BY E.ENCNTR_ID
 
HEAD REPORT
 CNT =0
HEAD E.ENCNTR_ID
 CNT =( CNT +1 ),
IF ( ( MOD ( CNT , 10 )=1 ) )  STAT = ALTERLIST ( ptlstEncntr_reply -> PATIENTS , ( CNT +9 ))
ENDIF
, ptlstEncntr_reply -> PATIENTS [ CNT ]-> PERSON_ID =P.PERSON_ID, ptlstEncntr_reply -> PATIENTS [ CNT ]-> PERSON_NAME =
P.NAME_FULL_FORMATTED, ptlstEncntr_reply -> PATIENTS [ CNT ]-> ENCNTR_ID =E.ENCNTR_ID, ptlstEncntr_reply -> PATIENTS [ CNT ]
-> PRIORITY =0 , ptlstEncntr_reply -> PATIENTS [ CNT ]-> ACTIVE_IND =1 , ptlstEncntr_reply -> PATIENTS [ CNT ]->
 ORGANIZATION_ID =E.ORGANIZATION_ID, ptlstEncntr_reply -> PATIENTS [ CNT ]-> CONFID_LEVEL_CD =E.CONFID_LEVEL_CD,
 ptlstEncntr_reply -> PATIENTS [ CNT ]-> CONFID_LEVEL = UAR_GET_COLLATION_SEQ (E.CONFID_LEVEL_CD),
IF ( ( ptlstEncntr_reply -> PATIENTS [ CNT ]-> CONFID_LEVEL <0 ) )  ptlstEncntr_reply -> PATIENTS [ CNT ]-> CONFID_LEVEL =0
ENDIF
, ptlstEncntr_reply -> PATIENTS [ CNT ]-> FILTER_IND = FILTERIND
FOOT REPORT
 STAT = ALTERLIST ( ptlstEncntr_reply -> PATIENTS ,  CNT )
 WITH  NOCOUNTER;, SKIPREPORT = 1

call echo(">>> PERSON_PRSNL_RELTN query: ")
 
IF (  (( ( CONFID_IND =1 ) )  OR  (( ENCNTR_ORG_SEC_IND =1 ) ))  AND ( CNT >0 ) )
SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT )),
( PERSON_PRSNL_RELTN  PPR ),
( CODE_VALUE_EXTENSION  CVE )
 PLAN ( D
WHERE ( ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =1 ))
 AND ( PPR
WHERE (PPR.PERSON_ID= ptlstEncntr_reply -> PATIENTS [D.SEQ]-> PERSON_ID ) AND (PPR.PRSNL_PERSON_ID= REQINFO ->
 UPDT_ID ) AND (PPR.ACTIVE_IND=1 ) AND (PPR.BEG_EFFECTIVE_DT_TM<= CNVTDATETIME ( CURDATE ,
 CURTIME3 )) AND (PPR.END_EFFECTIVE_DT_TM> CNVTDATETIME ( CURDATE ,  CURTIME3 )))
 AND ( CVE
WHERE (CVE.CODE_VALUE=PPR.PERSON_PRSNL_R_CD) AND (CVE.FIELD_NAME="Override" ) AND (CVE.CODE_SET=331
))
 
 
DETAIL
 
IF (  (( (CVE.FIELD_VALUE="2" ) )  OR  ((CVE.FIELD_VALUE="1" ) AND  (( ( CONFID_IND =0 ) )  OR  ((
 ptlstEncntr_reply -> PATIENTS [D.SEQ]-> CONFID_LEVEL =0 ) ))  ))  )  ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =0
ENDIF
 
 WITH  NOCOUNTER

call echo(">>> ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND query: ")

SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT )),
( DUMMYT  D2  WITH  SEQ = VALUE ( ORG_CNT ))
 PLAN ( D
WHERE ( ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =1 ))
 AND ( D2
WHERE ( ORGS -> QUAL [D2.SEQ]-> ORG_ID = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> ORGANIZATION_ID ))
 
 
DETAIL
 
IF (  (( ( CONFID_IND =0 ) )  OR  (( ORGS -> QUAL [D2.SEQ]-> CONFID_LEVEL >= ptlstEncntr_reply -> PATIENTS [
D.SEQ]-> CONFID_LEVEL ) ))  )  ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =0
ENDIF
 
 WITH  NOCOUNTER
 
call echo(">>> ENCNTR_PRSNL_RELTN query: ")

SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT )),
( ENCNTR_PRSNL_RELTN  EPR )
 PLAN ( D
WHERE ( ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =1 ))
 AND ( EPR
WHERE (EPR.ENCNTR_ID= ptlstEncntr_reply -> PATIENTS [D.SEQ]-> ENCNTR_ID ) AND (EPR.PRSNL_PERSON_ID= REQINFO ->
 UPDT_ID ) AND (EPR.EXPIRATION_IND=0 ) AND (EPR.ACTIVE_IND=1 ) AND (EPR.ENCNTR_PRSNL_R_CD>0 ) AND (
EPR.BEG_EFFECTIVE_DT_TM< CNVTDATETIME ( CURDATE ,  CURTIME3 )) AND (EPR.END_EFFECTIVE_DT_TM>
 CNVTDATETIME ( CURDATE ,  CURTIME3 )))
 
 
DETAIL
 ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =0
 WITH  NOCOUNTER
SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT ))
 PLAN ( D
WHERE ( ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND =0 ))
 
 
HEAD REPORT
 ACTUAL_CNT =0
DETAIL
 ACTUAL_CNT =( ACTUAL_CNT +1 ),
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> PERSON_ID = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> PERSON_ID ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> PERSON_NAME = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> PERSON_NAME ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> ENCNTR_ID = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> ENCNTR_ID ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> PRIORITY = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> PRIORITY ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> ACTIVE_IND = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> ACTIVE_IND ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> ORGANIZATION_ID = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> ORGANIZATION_ID ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> CONFID_LEVEL_CD = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> CONFID_LEVEL_CD ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> CONFID_LEVEL = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> CONFID_LEVEL ,
 ptlstEncntr_reply -> PATIENTS [ ACTUAL_CNT ]-> FILTER_IND = ptlstEncntr_reply -> PATIENTS [D.SEQ]-> FILTER_IND
FOOT REPORT
 CNT = ACTUAL_CNT ,
 STAT = ALTERLIST ( ptlstEncntr_reply -> PATIENTS ,  CNT )
 WITH  NOCOUNTER
IF ( ( CURQUAL =0 ) )
SET  CNT  = 0
SET  STAT  =  ALTERLIST ( ptlstEncntr_reply -> PATIENTS ,  CNT )
ENDIF
 
ENDIF
 
;get patient demog info
SET VIEWS CHECK

/* 
SELECT INTO  "nl:"
from (dummyt d with seq = size(ptlstEncntr_reply->patients,5))
	,cust_pt_demo_view c
plan d
join c
	where c.encntr_id = ptlstEncntr_reply->patients[d.seq].encntr_id
order by d.seq
head d.seq
	ptlstEncntr_reply->patients[d.seq].room = c.room
	ptlstEncntr_reply->patients[d.seq].bed = c.bed
	ptlstEncntr_reply->patients[d.seq].age = cnvtage(c.birth_dt_tm)
	ptlstEncntr_reply->patients[d.seq].sex = c.gender
	ptlstEncntr_reply->patients[d.seq].mrn = c.mrn
	ptlstEncntr_reply->patients[d.seq].fin = c.fin
	ptlstEncntr_reply->patients[d.seq].med_service = c.medical_service
with nocounter
*/

call echo(">>> DCP_PL_PRIORITIZATION query: ")

IF ( ( CNT >0 ) AND ( ptlst_request -> PATIENT_LIST_ID >0 ) )
SELECT  INTO "nl:"
FROM ( DUMMYT  D  WITH  SEQ = VALUE ( CNT )),
( DCP_PL_PRIORITIZATION  P )
 PLAN ( D )
 AND ( P
WHERE (P.PATIENT_LIST_ID= ptlst_request -> PATIENT_LIST_ID ) AND (P.PERSON_ID= ptlstEncntr_reply -> PATIENTS [D.SEQ]->
 PERSON_ID ))
 
 
DETAIL
 ptlstEncntr_reply -> PATIENTS [D.SEQ]-> PRIORITY =P.PRIORITY
 WITH  NOCOUNTER
ENDIF
 
call echo(">>> CCL Queries completed. Exiting ")
 
IF ( ( CNT =0 ) )
SET  ptlstEncntr_reply -> STATUS_DATA -> STATUS  = "Z"
ELSE
SET  ptlstEncntr_reply -> STATUS_DATA -> STATUS  = "S"
ENDIF
 
call echorecord(ptlstEncntr_reply)
 
SET  SCRIPT_VERSION  = "001 03/25/25 TROYS"

#EXIT_SCRIPT

END GO
